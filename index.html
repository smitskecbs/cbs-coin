<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Coin ‚Äì Community Builds Sovereignty</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <!-- Confetti (optioneel, voor success) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg1:#0f0f0f;--bg2:#1a1a1a;--fg:#00ffcc;--cyan:#00ffff;
      --panel:#111;--muted:#9aa;--border:#00ffcc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Orbitron',sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg);display:flex;flex-direction:column;align-items:center;padding:2rem
    }
    nav{width:100%;background:#111;padding:1rem;text-align:center;margin-bottom:2rem;border-bottom:1px solid #0c2020}
    nav a{margin:0 .8rem;color:var(--cyan);text-decoration:none;font-weight:700}
    nav a:hover{text-decoration:underline}
    header{text-align:center;width:100%}
    h1{font-size:3rem;margin:.5rem 0 .2rem}
    h2{font-size:1.35rem;font-weight:400;color:var(--muted);margin:.4rem 0 1rem}
    .logo{margin:1rem 0;max-width:180px}
    .section{max-width:1100px;background:#111;padding:1.4rem;margin:1rem 0;border:1px solid var(--border);border-radius:12px}
    a{color:var(--cyan);text-decoration:none}
    a:hover{text-decoration:underline}
    footer{margin-top:2rem;font-size:.9rem;color:#aaa;text-align:center}
    .social-links{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;margin:1rem 0}
    .social-links a{display:inline-flex;align-items:center;padding:.5rem 1rem;background:#1a1a1a;border:1px solid var(--cyan);border-radius:6px;font-weight:700;color:var(--cyan)}
    .social-links a:hover{background:var(--cyan);color:#000}

    /* Knoppen */
    .toolbar{display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap;margin:1rem 0}
    .btn{
      padding:.9rem 1.4rem;font-weight:800;border-radius:12px;border:1px solid var(--cyan);
      background:#141414;color:var(--cyan);cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,255,204,.15)}
    .btn-primary{
      background:var(--fg);color:#001c1a;border:none;
      box-shadow:0 0 10px var(--fg),0 0 40px var(--fg),0 0 80px var(--fg);
    }
    .btn-primary:hover{box-shadow:0 0 20px var(--cyan),0 0 60px var(--cyan),0 0 100px var(--cyan)}

    /* Status */
    #status{min-height:1.5rem;margin-top:.6rem}
    .ok{color:#5aff86} .warn{color:#ffd166} .err{color:#ff6b6b}
    #walletAddr{font-size:.95rem;color:#9fffe3}
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="roadmap.html">Roadmap</a>
    <a href="tokenomics.html">Tokenomics</a>
    <a href="litepaper.html">Litepaper</a>
    <a href="dao-mainnet/dao.html">DAO</a>
    <a href="mailto:smitskecbs@gmail.com">Contact</a>
  </nav>

  <header>
    <img class="logo" alt="CBS Coin Logo"
         src="https://cyan-persistent-stork-902.mypinata.cloud/ipfs/bafybeia7qejzloll6teyt4o4orvd7bnvkg4thrfajv4rgb3fmm2odeweoa/logo.png" />
    <h1>CBS Coin</h1>
    <h2>Community Builds Sovereignty</h2>

    <div class="social-links">
      <a href="https://t.me/CBS_Coin" target="_blank" rel="noreferrer">Telegram</a>
      <a href="https://twitter.com/CBS_Coin" target="_blank" rel="noreferrer">X (Twitter)</a>
    </div>
  </header>

  <!-- KOOP CBS (on-site deal) -->
  <section class="section" style="text-align:center">
    <h2>üí∞ Koop CBS ‚Äì Actie</h2>
    <p><b>0.020 SOL</b> ‚Üí <b>25.000 CBS</b> (direct via onze site).</p>

    <!-- Wallet in het koopvak -->
    <div class="toolbar">
      <button id="connectBtn" class="btn">üîå Connect Wallet</button>
      <button id="disconnectBtn" class="btn" style="display:none">üîí Disconnect</button>
      <span id="walletAddr"></span>
    </div>

    <div class="toolbar">
      <button id="buyBtn" class="btn btn-primary">üí≥ Koop 25.000 CBS (0.020 SOL)</button>
      <button id="retryBtn" class="btn" style="display:none">üîÅ Herprobeer uitbetaling</button>
    </div>

    <p id="status"></p>
  </section>

  <!-- INFO -->
  <section class="section">
    <h3>üì¶ Token Info</h3>
    <ul>
      <li><strong>Tokennaam:</strong> CBS Coin</li>
      <li><strong>Symbool:</strong> CBS</li>
      <li><strong>Totale supply:</strong> 100.000.000</li>
      <li><strong>Mint authority:</strong> <em>uitgeschakeld</em></li>
      <li><strong>Freeze authority:</strong> <em>uitgeschakeld</em></li>
      <li><strong>Explorer:</strong>
        <a href="https://solscan.io/token/B9z8cEWFmc7LvQtjKsaLoKqW5MJmGRCWqs1DPKupCfkk" target="_blank" rel="noreferrer">
          Bekijk op Solscan
        </a>
      </li>
    </ul>
  </section>

  <section class="section">
    <h3>üìÑ Whitepaper & Roadmap</h3>
    <p>
      Bekijk onze visie en plannen in de <a href="litepaper.html" target="_blank" rel="noreferrer">litepaper</a>.
      De roadmap bevat o.a. liquidity pools, DAO integratie en tokenverificatie op grote platforms.
    </p>
  </section>

  <footer>
    ¬© 2025 CBS Coin ‚Äì Sovereignty through community.
    <div class="social-links" style="justify-content:center;margin-top:.6rem">
      <a href="https://t.me/CBS_Coin" target="_blank" rel="noreferrer">Telegram</a>
      <a href="https://twitter.com/CBS_Coin" target="_blank" rel="noreferrer">X (Twitter)</a>
    </div>
  </footer>

  <!-- Web3.js (ESM) -->
  <script type="module">
    // ===== Config =====
    const CREATOR_WALLET = "76SjWWFoJ1NQEWXVWbbqYR8112FAEyWGQT1PS1DeLmEg"; // ontvanger SOL
    const CBS_MINT       = "B9z8cEWFmc7LvQtjKsaLoKqW5MJmGRCWqs1DPKupCfkk";
    const PRICE_SOL      = 0.020;        // 0.020 SOL
    const CBS_PER_BUY    = 25000;        // 25.000 CBS
    const HELIUS_RPC     = "https://mainnet.helius-rpc.com/?api-key=dee593c7-e01e-42da-9419-bcf7b585b67e";

    // Backend die CBS uitkeert na betaling:
    const FULFILL_ENDPOINT = "https://cbs-coin.vercel.app/api/koop-cbs";

    // ===== UI helpers =====
    const $ = (id)=>document.getElementById(id);
    const connectBtn    = $("connectBtn");
    const disconnectBtn = $("disconnectBtn");
    const walletAddrEl  = $("walletAddr");
    const buyBtn        = $("buyBtn");
    const retryBtn      = $("retryBtn");
    const statusEl      = $("status");
    const setOK  = (h)=>{ statusEl.className="ok";  statusEl.innerHTML=h; };
    const setERR = (h)=>{ statusEl.className="err"; statusEl.innerHTML=h; };
    const setWARN= (h)=>{ statusEl.className="warn";statusEl.innerHTML=h; };
    const link  = (href, text)=>`<a href="${href}" target="_blank" rel="noreferrer">${text}</a>`;

    // ===== Wallet detect =====
    function getProvider(){
      if (window.solana?.isPhantom) return window.solana;
      if (window.phantom?.solana?.isPhantom) return window.phantom.solana;
      return null;
    }
    function shortKey(pk){ const s = pk?.toString()||""; return s.length>10 ? s.slice(0,4)+"‚Ä¶"+s.slice(-4) : s; }
    function setConnected(pk){ walletAddrEl.textContent = "Wallet: "+shortKey(pk); connectBtn.style.display="none"; disconnectBtn.style.display="inline-block"; }
    function setDisconnected(){ walletAddrEl.textContent = ""; connectBtn.style.display="inline-block"; disconnectBtn.style.display="none"; }

    async function connectWallet(){
      const p = getProvider();
      if(!p){ alert("Phantom wallet niet gevonden."); return null; }
      try{
        const res = await p.connect({ onlyIfTrusted:false });
        const pub = (res.publicKey||p.publicKey).toString();
        setConnected(pub);
        return pub;
      }catch(e){ console.warn(e); return null; }
    }
    async function disconnectWallet(){
      const p = getProvider(); try{ await p?.disconnect?.(); }catch(_){}
      setDisconnected();
    }
    connectBtn.addEventListener("click", connectWallet);
    disconnectBtn.addEventListener("click", disconnectWallet);

    // Probeer silent connect
    window.addEventListener("load", async () => {
      const p = getProvider();
      if (!p) return;
      try{
        const res = await p.connect({ onlyIfTrusted:true });
        if (res?.publicKey || p.publicKey) setConnected((res.publicKey||p.publicKey).toString());
      }catch(_){}
      // Toon retry-knop als er een pending uitbetaling in storage staat
      const pending = getPending();
      if (pending) retryBtn.style.display = "inline-block";
    });

    import { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL } from "https://esm.sh/@solana/web3.js@1.95.3";

    // eenvoudige client-side cooldown: 1 koop per 5 minuten
    const COOLDOWN_MS = 5 * 60 * 1000;
    function tooSoon(){
      try{
        const t = Number(localStorage.getItem("cbs_last_buy_ts")||"0");
        return (Date.now() - t) < COOLDOWN_MS;
      }catch{ return false; }
    }
    function markBuy(){ try{ localStorage.setItem("cbs_last_buy_ts", String(Date.now())); }catch{} }

    // pending storage (voor retry)
    function setPending(obj){
      try{ localStorage.setItem("cbs_pending_fulfill", JSON.stringify(obj)); }catch{}
    }
    function getPending(){
      try{
        const raw = localStorage.getItem("cbs_pending_fulfill");
        if (!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    }
    function clearPending(){
      try{ localStorage.removeItem("cbs_pending_fulfill"); }catch{}
    }

    async function fulfill({ buyer, signature }){
      const resp = await fetch(FULFILL_ENDPOINT, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          buyer, signature,
          cbsAmount: CBS_PER_BUY,
          priceSol: PRICE_SOL,
          mint: CBS_MINT
        })
      });
      let data = null;
      try{ data = await resp.json(); }catch(_){}
      if (resp.ok && (data?.ok || data?.tx || data?.signature)) {
        return { ok:true, tx: data.tx || data.signature };
      }
      return { ok:false, error: data?.error || "Fulfill failed" };
    }

    // Koop flow
    buyBtn.addEventListener("click", async () => {
      try{
        let provider = getProvider();
        if (!provider){ setERR("‚ùå Phantom wallet niet gevonden. Installeer Phantom."); return; }

        // Connect als nog niet connected
        let buyerPub = provider.publicKey?.toString();
        if (!buyerPub) buyerPub = await connectWallet();
        if (!buyerPub) return;

        if (tooSoon()) return setWARN("Even geduld‚Ä¶ je kunt over een paar minuten opnieuw kopen.");

        setWARN("‚è≥ Voorbereiden van betaling‚Ä¶");

        const connection = new Connection(HELIUS_RPC, "confirmed");
        const buyerPk    = new PublicKey(buyerPub);
        const toPk       = new PublicKey(CREATOR_WALLET);

        // Maak SOL transfer tx
        const tx = new Transaction();
        tx.feePayer = buyerPk;
        const { blockhash } = await connection.getLatestBlockhash("finalized");
        tx.recentBlockhash = blockhash;

        const lamports = Math.round(PRICE_SOL * LAMPORTS_PER_SOL);
        tx.add(SystemProgram.transfer({
          fromPubkey: buyerPk,
          toPubkey: toPk,
          lamports
        }));

        // Ondertekenen & verzenden
        let signature;
        if (typeof provider.signAndSendTransaction === "function") {
          const res = await provider.signAndSendTransaction(tx);
          signature = res?.signature ?? res;
        } else {
          const signed = await provider.signTransaction(tx);
          signature = await connection.sendRawTransaction(signed.serialize(), { skipPreflight:false });
        }

        setWARN(`‚è≥ Betaling verstuurd, wachten op confirm‚Ä¶ ${link("https://solscan.io/tx/"+signature, "Bekijk op Solscan")}`);
        await connection.confirmTransaction(signature, "confirmed");

        // Backend uitbetaling
        setWARN("‚è≥ Uitbetaling 25.000 CBS wordt gestart‚Ä¶");
        const result = await fulfill({ buyer: buyerPk.toString(), signature });

        if (result.ok){
          clearPending();
          markBuy();
          setOK(
            `‚úÖ Koop geslaagd! ${PRICE_SOL} SOL ontvangen. 25.000 CBS is onderweg. ` +
            `${link("https://solscan.io/tx/"+result.tx, "Uitbetaling op Solscan")}`
          );
          retryBtn.style.display = "none";
          confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else {
          // Bewaar pending en toon retry
          setPending({ buyer: buyerPk.toString(), signature });
          retryBtn.style.display = "inline-block";
          setOK(
            `‚úÖ Betaling ontvangen. De uitbetaling kon niet direct worden bevestigd (` +
            `${result.error}). Je kunt zo meteen op <b>Herprobeer uitbetaling</b> klikken. ` +
            `Bewaar je TX: <code>${signature}</code>.`
          );
        }

      }catch(e){
        console.error(e);
        const msg = (e?.message || e || "").toString().toLowerCase();
        if (msg.includes("reject") || msg.includes("decline")){
          setERR("Je hebt de betaling in Phantom geannuleerd.");
        } else if (msg.includes("insufficient") || msg.includes("not enough")){
          setERR("Onvoldoende SOL voor deze aankoop (0.020 SOL + netwerkfee vereist).");
        } else {
          setERR("‚ùå Er ging iets mis bij het kopen: " + (e?.message || e));
        }
      }
    });

    // Herprobeer uitbetaling
    retryBtn.addEventListener("click", async () => {
      const pending = getPending();
      if (!pending){ setERR("Geen uitbetaling om te herproberen."); return; }

      try{
        setWARN("‚è≥ Opnieuw proberen te uitbetalen‚Ä¶");
        const result = await fulfill(pending);
        if (result.ok){
          clearPending();
          setOK(`‚úÖ Uitbetaling gelukt! ${link("https://solscan.io/tx/"+result.tx, "Bekijk op Solscan")}`);
          retryBtn.style.display = "none";
          confetti({ particleCount: 120, spread: 60, origin: { y: 0.6 } });
        } else {
          setERR("Nog niet gelukt: " + (result.error || "onbekende fout"));
        }
      }catch(e){
        console.error(e);
        setERR("‚ùå Fout bij herproberen: " + (e?.message || e));
      }
    });
  </script>
</body>
</html>

