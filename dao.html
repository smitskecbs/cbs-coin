<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO ‚Äì Stemmen (Devnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--green:#39ff14;--muted:#66ffff;--panel:#0f0f0f}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(880px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan);text-align:left}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .q{display:flex;gap:10px;align-items:center;font-size:18px;margin:10px 0 14px;color:var(--green)}
    .fl{font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    button,a.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;align-items:center}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    pre{background:#0b0f16;color:#b7fff1;border-radius:12px;padding:12px;max-height:320px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO ‚Äì Stemmen op proposal</h1>
    <div class="sub">Netwerk: <b>Devnet</b> ‚Ä¢ RPC: <code>https://api.devnet.solana.com</code></div>

    <div class="q"><span class="fl">üî•üî•</span><b>Vraag:</b>&nbsp;1 Miljoen CBS burnen ‚Äî YES of NO? <span class="fl">üî•üî•</span></div>

    <div class="kv">Wallet: <code id="wallet">niet verbonden</code></div>
    <div class="kv">Program ID: <code>FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY</code></div>
    <div class="kv">Proposal: <code id="proposal">9ALSSyJxAPCgyEcgJmVLnCTV5yPzbJAhUyeWMRv4kYYe</code></div>
    <div class="kv">Vote receipt PDA: <code id="receipt">‚Äî</code></div>
    <div class="kv">Status: <span id="status" class="status"></span></div>

    <div class="row">
      <button id="connect" class="secondary">Connect Phantom</button>
      <button id="yes" disabled>Stem YES</button>
      <button id="no"  disabled class="secondary">Stem NO</button>
      <a class="btn secondary" href="https://faucet.solana.com" target="_blank" rel="noopener">Claim Devnet SOL</a>
    </div>

    <div class="sub">Zet Phantom op <b>Devnet</b> ‚Üí Settings ‚Üí Developer Settings ‚Üí Change Network ‚Üí Devnet.
      ‚Ä¢ Proposal in Explorer: <a id="plink" target="_blank" rel="noopener">open</a></div>

    <pre id="log"></pre>
  </div>

  <script type="module">
    import {
      Connection, PublicKey, SystemProgram, Transaction, TransactionInstruction
    } from "https://esm.sh/@solana/web3.js@1.95.3";

    // --- Config (DEVNET) ---
    const RPC = "https://api.devnet.solana.com";
    const PROGRAM_ID = new PublicKey("FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY");
    const PROPOSAL = new PublicKey("9ALSSyJxAPCgyEcgJmVLnCTV5yPzbJAhUyeWMRv4kYYe");
    const VOTE_DISC = Uint8Array.from([227,110,155,23,136,126,172,25]); // 'vote' discriminator

    const conn = new Connection(RPC, "confirmed");
    document.getElementById("plink").href =
      `https://explorer.solana.com/address/${PROPOSAL.toBase58()}?cluster=devnet`;

    // --- UI helpers ---
    const $w = document.getElementById("wallet");
    const $r = document.getElementById("receipt");
    const $s = document.getElementById("status");
    const $log = document.getElementById("log");
    const log = m => { $log.textContent += m + "\n"; $log.scrollTop = $log.scrollHeight; };
    const setStatus = (t,c) => { $s.textContent = t; $s.className = "status " + (c||""); };
    const setEnabled = on => { yes.disabled = !on; no.disabled = !on; };

    const connectBtn = document.getElementById("connect");
    const yes = document.getElementById("yes");
    const no  = document.getElementById("no");

    let provider = null;  // Phantom provider
    let walletPk = null;

    // --- Robuuste Phantom detectie + wachten op injectie ---
    function getInjectedProvider(){
      if ("phantom" in window && window.phantom?.solana?.isPhantom) return window.phantom.solana;
      if (window.solana?.isPhantom) return window.solana;
      return null;
    }
    async function getProviderReady(timeoutMs = 2000){
      const existing = getInjectedProvider();
      if (existing) return existing;
      // wacht op Phantom injectie event
      return await new Promise((resolve) => {
        const t = setTimeout(() => resolve(getInjectedProvider()), timeoutMs);
        window.addEventListener("solana#initialized", () => {
          clearTimeout(t);
          resolve(getInjectedProvider());
        }, { once: true });
      });
    }

    async function deriveReceipt(voterPk){
      const [pda] = await PublicKey.findProgramAddress(
        [new TextEncoder().encode("receipt"), PROPOSAL.toBuffer(), voterPk.toBuffer()],
        PROGRAM_ID
      );
      return pda;
    }
    async function getSol(pubkey){
      try { return (await conn.getBalance(pubkey))/1e9; } catch { return 0; }
    }

    // --- Event handlers (handig op desktop Phantom) ---
    function wireProviderEvents(p){
      try {
        p.on("connect", (pk) => log("üîå Event: connect " + (pk?.toBase58?.() || "")));
        p.on("disconnect", () => log("üîå Event: disconnect"));
        p.on("accountChanged", (pk) => {
          log("üë§ Account changed: " + (pk?.toBase58?.() || ""));
          location.reload(); // simpelste: herlaad zodat UI klopt
        });
      } catch {}
    }

    // --- Connect flow ---
    connectBtn.onclick = async () => {
      try{
        provider = await getProviderReady();
        if(!provider){
          alert("Phantom Wallet niet gevonden. Installeer Phantom en zet 'm op Devnet.");
          log("‚ùå Phantom provider niet gevonden.");
          return;
        }
        wireProviderEvents(provider);

        // Probeer eerst silent reconnect
        try { await provider.connect({ onlyIfTrusted: true }); } catch {}
        if (!provider.publicKey) {
          // Toon popup om toestemming te vragen
          await provider.connect({ onlyIfTrusted: false });
        }

        walletPk = provider.publicKey;
        if(!walletPk){ log("‚ùå Geen publicKey na connect."); return; }

        $w.textContent = walletPk.toBase58();
        log("‚úÖ Verbonden met: " + walletPk.toBase58());

        const bal = await getSol(walletPk);
        if(bal < 0.01) setStatus("Weinig Devnet SOL ‚Äì gebruik 'Claim Devnet SOL'.", "warn");

        const pda = await deriveReceipt(walletPk);
        $r.textContent = pda.toBase58();

        const info = await conn.getAccountInfo(pda, "confirmed");
        if(info){
          setStatus("Je hebt al gestemd met deze wallet.", "warn");
          setEnabled(false);
        }else{
          setStatus("Je kunt stemmen.", "ok");
          setEnabled(true);
        }
      }catch(e){
        console.error(e);
        log("‚ùå Connect fout: " + (e?.message ?? e));
      }
    };

    // --- Stem ---
    async function vote(yesVote){
      try{
        if(!provider || !walletPk){ return alert("Eerst verbinden met Phantom."); }

        const receipt = await deriveReceipt(walletPk);
        const exists = await conn.getAccountInfo(receipt, "confirmed");
        if(exists){ setStatus("Je hebt al gestemd met deze wallet.", "warn"); setEnabled(false); return; }

        // Data = discriminator + 1 byte (1=yes, 0=no)
        const data = new Uint8Array([...VOTE_DISC, yesVote ? 1 : 0]);

        const keys = [
          { pubkey: PROPOSAL, isSigner:false, isWritable:true },
          { pubkey: receipt,  isSigner:false, isWritable:true },
          { pubkey: walletPk, isSigner:true,  isWritable:true },
          { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
        ];

        const { blockhash } = await conn.getLatestBlockhash("finalized");
        const tx = new Transaction({ feePayer: walletPk, recentBlockhash: blockhash })
          .add(new TransactionInstruction({ programId: PROGRAM_ID, keys, data }));

        // Phantom verstuurt zelf; pak signature string uit het resultaat
        const { signature } = await provider.signAndSendTransaction(tx);
        log("‚è≥ Verstuurd, wachten op finalisatie‚Ä¶ " + signature);

        await conn.confirmTransaction(signature, "finalized");
        log(`‚úÖ Stem ${yesVote ? "YES" : "NO"} bevestigd: ${signature}`);
        log(`üîó Explorer: https://explorer.solana.com/tx/${signature}?cluster=devnet`);
        setStatus("Stem geregistreerd. Bedankt!", "ok");
        setEnabled(false);
      }catch(e){
        console.error(e);
        const msg = (e?.message || "").toLowerCase();
        if(msg.includes("already been processed")){
          log("‚ö†Ô∏è Oude transactie gebruikt. Ververs de pagina en probeer opnieuw.");
        }else if(msg.includes("insufficient") || msg.includes("debit")){
          log("‚ö†Ô∏è Onvoldoende Devnet SOL. Gebruik de faucet-knop.");
        }else if(msg.includes("custom program error")){
          log("‚ö†Ô∏è Program-fout: " + e.message);
        }else{
          log("‚ùå Onbekende fout: " + (e?.message ?? e));
        }
      }
    }

    document.getElementById("yes").onclick = () => vote(true);
    document.getElementById("no").onclick  = () => vote(false);
  </script>
</body>
</html>
