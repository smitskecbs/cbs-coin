<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Snake Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{--bg1:#0f0f0f;--bg2:#1a1a1a;--fg:#00ffcc;--accent:#00ffff;--panel:#111;--border:#0ff}
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Orbitron',sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg);display:flex;flex-direction:column;align-items:center;padding:16px
    }
    header{display:flex;align-items:center;gap:.75rem;margin:10px auto 14px auto}
    header img{height:48px}
    h1{margin:0;font-size:clamp(1.6rem,3.3vw,2.3rem);color:var(--accent);text-shadow:0 0 6px #0ff5}
    .panel{background:var(--panel);border:2px solid var(--border);border-radius:16px;padding:16px;margin:10px auto;max-width:680px;width:100%;box-shadow:0 0 22px #0ff3}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .btn{background:var(--fg);color:#012;cursor:pointer;border:none;border-radius:12px;padding:.85rem 1.35rem;font-weight:800}
    .btn:hover{background:var(--accent)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    #payBtn{box-shadow:0 0 10px var(--fg),0 0 35px var(--fg),0 0 60px var(--fg)}

    #gameWrap{max-width:440px;margin:10px auto}
    canvas{
      display:block;margin:0 auto;border:2px solid var(--accent);
      width:100%;max-width:440px;height:auto;background:#000;touch-action:none;border-radius:12px
    }

    .muted{color:#9aa} table{width:100%;border-collapse:collapse}
    th,td{padding:.55rem;border-bottom:1px solid #0ff3;text-align:center}
    h2{margin:.2rem 0 .6rem}

    /* Name overlay */
    #nameOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    #nameCard{background:#111;border:2px solid var(--border);border-radius:12px;padding:16px 18px;box-shadow:0 0 18px #0ff6;width:min(92vw,420px)}
    #nameInput{width:100%;padding:.75rem 1rem;border:2px solid var(--border);border-radius:.6rem;background:#000;color:#fff;font-family:inherit;font-size:1rem}
    #error{color:#ff6b7a;font-size:.85rem;margin-top:.35rem;display:none}

    /* Mobile D-pad (transparant, onder het canvas) */
    #dpad{
      position:static;              /* geen overlay */
      display:none;                 /* alleen mobiel */
      justify-content:center;
      margin-top:12px;
    }
    #dpad .pad{
      display:grid;
      grid-template-columns:64px 64px 64px;
      grid-template-rows:64px 64px 64px;
      gap:12px;
      opacity:.45;
      filter:drop-shadow(0 0 6px #0ff6)
    }
    #dpad button{
      pointer-events:auto;
      background:rgba(0,255,255,.10);
      border:1px solid #0ff7;color:#cff;border-radius:15px;
      backdrop-filter:blur(2px);font-weight:800
    }
    #dpad button:active{background:rgba(0,255,255,.22)}
    @media (max-width:680px){ #dpad{display:flex} }
  </style>
</head>
<body>
  <header>
    <img src="https://cyan-persistent-stork-902.mypinata.cloud/ipfs/bafybeia7qejzloll6teyt4o4orvd7bnvkg4thrfajv4rgb3fmm2odeweoa/logo.png" alt="CBS" />
    <h1>CBS Snake Game</h1>
  </header>

  <div class="panel">
    <div class="row" style="justify-content:center;margin-bottom:.3rem">
      <button id="connectBtn" class="btn">üîó Connect Wallet</button>
      <button id="payBtn" class="btn" disabled>üí≥ Pay 10 CBS</button>
      <button id="startBtn" class="btn" disabled>‚ñ∂Ô∏è Start</button>
    </div>
    <p class="muted" style="text-align:center;margin:.2rem 0 0 0">
      Entry fee: <b>10 CBS</b> ‚Ä¢ Monthly prize for best score
    </p>
  </div>

  <div class="panel" id="gamePanel">
    <div id="gameWrap">
      <canvas id="gameCanvas" width="420" height="420"></canvas>
      <!-- Transparent mobile D-pad (onder het canvas) -->
      <div id="dpad" aria-label="On-screen controls">
        <div class="pad">
          <div></div>     <button data-dir="UP">‚ñ≤</button>     <div></div>
          <button data-dir="LEFT">‚óÑ</button> <div></div> <button data-dir="RIGHT">‚ñ∫</button>
          <div></div>     <button data-dir="DOWN">‚ñº</button>   <div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2 style="text-align:center">üèÜ Top 3</h2>
    <p class="muted" style="text-align:center;margin-top:-.25rem">Only the three highest scores are shown.</p>
    <table>
      <thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <p id="lbNote" class="muted" style="display:none;margin-top:.5rem;text-align:center">Showing local scores (cloud unavailable).</p>
  </div>

  <!-- Name modal -->
  <div id="nameOverlay">
    <div id="nameCard">
      <h3 style="margin:.2rem 0 .6rem;color:var(--accent)">Save your score</h3>
      <p class="muted" style="margin:.1rem 0 .6rem">Type your name and press <b>Enter</b> to submit.</p>
      <input id="nameInput" maxlength="30" placeholder="Your name or wallet‚Ä¶" autocomplete="off" />
      <div id="error">Name is required.</div>
      <div style="margin-top:.8rem;text-align:right">
        <button id="saveBtn" class="btn">Save</button>
        <button id="cancelBtn" class="btn" style="background:#333;color:#ddd">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- Game + Wallet -->
  <script type="module">
    /******** CONFIG ********/
    const SUPABASE_URL = "https://aiawteejixsgsunmefpi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpYXd0ZWVqaXhzZ3N1bm1lZnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NDExODIsImV4cCI6MjA3MTAxNzE4Mn0.aMbRUM0YebNMfZhSLb9PFdSHAZ-D5WpACPefCfjSLqI";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE = "leaderboard";
    // JOUW Edge Function (naam: quick-service)
    const EDGE_FN_URL = "https://aiawteejixsgsunmefpi.supabase.co/functions/v1/quick-service";

    // Solana
    import { Connection, PublicKey, Transaction } from "https://esm.sh/@solana/web3.js@1.95.8";
    import {
      getAssociatedTokenAddress,
      createTransferInstruction,
      TOKEN_PROGRAM_ID
    } from "https://esm.sh/@solana/spl-token@0.4.7";

    const RPC_URL = "https://rpc.helius.xyz/?api-key=453a64a5-31dd-4c21-9619-6f0c69c74ff9";
    const connection = new Connection(RPC_URL, "confirmed");
    const CBS_MINT = new PublicKey("B9z8cEWFmc7LvQtjKsaLoKqW5MJmGRCWqs1DPKupCfkk");
    const TREASURY = new PublicKey("76SjWWFoJ1NQEWXVWbbqYR8112FAEyWGQT1PS1DeLmEg");
    const CBS_DECIMALS = 9;           // number
    const ENTRY_CBS = 10;             // number of CBS
    let walletPK = null;
    // Payment/run state
    let paidSig  = null; // vers betaalbewijs, nog niet gebruikt
    let roundSig = null; // geconsumeerd voor huidige run

    /******** UI ********/
    const $ = (id)=>document.getElementById(id);
    const connectBtn = $("connectBtn"), payBtn = $("payBtn"), startBtn = $("startBtn");
    const overlay = $("nameOverlay"), nameInput = $("nameInput"), err = $("error"), saveBtn = $("saveBtn"), cancelBtn = $("cancelBtn");
    const tbody = $("leaderboardBody"), lbNote = $("lbNote");

    // Init button states
    payBtn.disabled = true;   // pas na connect
    startBtn.disabled = true; // pas na betaling

    /******** GAME ********/
    const canvas = $("gameCanvas"), ctx = canvas.getContext("2d");
    const box = 20;
    let snake, direction, food, score, loopId;
    const watermark = new Image();
    watermark.src = "https://cyan-persistent-stork-902.mypinata.cloud/ipfs/bafybeia7qejzloll6teyt4o4orvd7bnvkg4thrfajv4rgb3fmm2odeweoa/logo.png";

    function randCell(){ return {x: Math.floor(Math.random()* (canvas.width/box)) * box, y: Math.floor(Math.random()* (canvas.height/box)) * box }; }
    function initGame(){ snake=[{x:10*box,y:10*box}]; direction=null; food=randCell(); score=0; drawFrame(); }
    function start(){ clearInterval(loopId); initGame(); loopId=setInterval(tick,100); }
    function stop(){ clearInterval(loopId); }

    function drawRoundedRect(x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
    function neonSegment(x,y,s,head=false){ ctx.save(); const g=ctx.createLinearGradient(x,y,x+s,y+s); g.addColorStop(0,"#35d0ff"); g.addColorStop(1,"#00e5ff"); ctx.shadowColor="#00d5ff"; ctx.shadowBlur=18; drawRoundedRect(x+2,y+2,s-4,s-4,6); ctx.fillStyle=g; ctx.fill(); ctx.shadowBlur=0; ctx.strokeStyle="rgba(255,255,255,.25)"; ctx.lineWidth=2; ctx.stroke(); if(head){ctx.beginPath(); ctx.arc(x+s*0.7, y+s*0.35, 2, 0, Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();} ctx.restore(); }
    function drawCoin(x,y,s){ ctx.save(); const r=s/2,cx=x+r,cy=y+r; ctx.shadowColor="#ffd54d"; ctx.shadowBlur=14; const g=ctx.createRadialGradient(cx,cy,r*0.2,cx,cy,r); g.addColorStop(0,"#ffe27a"); g.addColorStop(0.6,"#ffca28"); g.addColorStop(1,"#ffb300"); ctx.beginPath(); ctx.arc(cx,cy,r-2,0,Math.PI*2); ctx.fillStyle=g; ctx.fill(); ctx.shadowBlur=0; ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,.35)"; ctx.stroke(); ctx.restore(); }

    function drawFrame(){
      ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
      // Watermark
      if (watermark.complete){
        const w=canvas.width*0.75, h=w; ctx.save(); ctx.globalAlpha=0.08; ctx.drawImage(watermark,(canvas.width-w)/2,(canvas.height-h)/2,w,h); ctx.restore();
      }
      drawCoin(food.x, food.y, box);
      for(let i=snake.length-1;i>=0;i--){ neonSegment(snake[i].x,snake[i].y,box,i===0); }
      ctx.fillStyle="#fff"; ctx.font="18px Orbitron"; ctx.fillText("Score: "+score, box, 22);
    }

    function tick(){
      let x=snake[0].x, y=snake[0].y;
      if(direction==="LEFT") x-=box;
      if(direction==="UP")   y-=box;
      if(direction==="RIGHT")x+=box;
      if(direction==="DOWN") y+=box;

      // wrap walls
      const W=canvas.width, H=canvas.height;
      if(x<0) x=W-box; else if(x>=W) x=0;
      if(y<0) y=H-box; else if(y>=H) y=0;

      if(x===food.x && y===food.y){ score++; food=randCell(); }
      else snake.pop();

      if(snake.some(s=>s.x===x&&s.y===y)){ stop(); drawFrame(); openNameModal(score); return; }
      snake.unshift({x,y});
      drawFrame();
    }

    document.addEventListener("keydown", e=>{
      if(e.key==="ArrowLeft" && direction!=="RIGHT") direction="LEFT";
      else if(e.key==="ArrowUp" && direction!=="DOWN") direction="UP";
      else if(e.key==="ArrowRight" && direction!=="LEFT") direction="RIGHT";
      else if(e.key==="ArrowDown" && direction!=="UP") direction="DOWN";
    });

    // Mobile D-pad (click/touch)
    document.querySelectorAll('#dpad button').forEach(b=>{
      const set=(d)=>{
        if(d==="LEFT"&&direction!=="RIGHT")direction="LEFT";
        if(d==="RIGHT"&&direction!=="LEFT")direction="RIGHT";
        if(d==="UP"&&direction!=="DOWN")direction="UP";
        if(d==="DOWN"&&direction!=="UP")direction="DOWN";
      };
      b.addEventListener('click',()=> set(b.dataset.dir));
      b.addEventListener('touchstart',e=>{ e.preventDefault(); set(b.dataset.dir); },{passive:false});
    });

    /******** WALLET / PAYMENT ********/
    function provider(){ return window.solana?.isPhantom ? window.solana : null; }

    connectBtn.addEventListener("click", async ()=>{
      try{
        const p = provider(); if(!p) return alert("Phantom Wallet not found.");
        const { publicKey } = await p.connect(); walletPK = publicKey;
        connectBtn.textContent = `‚úÖ ${publicKey.toString().slice(0,4)}‚Ä¶${publicKey.toString().slice(-4)}`;
        payBtn.disabled = false;  // nu mag je betalen
      }catch(e){ console.error(e); alert("Wallet connect failed."); }
    });

    payBtn.addEventListener("click", async ()=>{
      try{
        const p = provider(); if(!p) return alert("Phantom Wallet not found.");
        if(!walletPK){ const { publicKey } = await p.connect(); walletPK=publicKey; connectBtn.textContent=`‚úÖ ${publicKey.toString().slice(0,4)}‚Ä¶${publicKey.toString().slice(-4)}`; }
        payBtn.disabled = true; payBtn.textContent = "Processing‚Ä¶";

        const fromATA = await getAssociatedTokenAddress(CBS_MINT, walletPK);
        const toATA   = await getAssociatedTokenAddress(CBS_MINT, TREASURY);

        // check balance
        const balInfo = await connection.getTokenAccountBalance(fromATA).catch(()=>null);
        const needRaw = ENTRY_CBS * (10 ** CBS_DECIMALS);
        if(!balInfo || Number(balInfo.value.amount) < needRaw){
          payBtn.disabled=false; payBtn.textContent="üí≥ Pay 10 CBS";
          return alert("Not enough CBS to play (need 10 CBS).");
        }

        const ix = createTransferInstruction(fromATA, toATA, walletPK, needRaw, [], TOKEN_PROGRAM_ID);
        const tx = new Transaction().add(ix);
        tx.feePayer = walletPK;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        const { signature } = await p.signAndSendTransaction(tx);
        await connection.confirmTransaction(signature, "confirmed");

        // betaling geslaagd -> klaar om te starten
        paidSig = signature;
        roundSig = null;
        startBtn.disabled = false;     // gebruiker mag nu starten
        alert("Payment confirmed. Press START to play!");
      }catch(e){
        console.error(e);
        alert("Payment failed. Please try again.");
      }finally{
        payBtn.disabled=false; payBtn.textContent="üí≥ Pay 10 CBS";
      }
    });

    // Start: alleen met verse betaling
    startBtn.addEventListener("click", ()=>{
      if(!walletPK) return alert("Connect your wallet first.");
      if(!paidSig)  return alert("Please pay 10 CBS first.");
      // consumeer betaling
      roundSig = paidSig; paidSig = null;
      startBtn.disabled = true; // tijdens run niet opnieuw starten
      start();
    });

    /******** NAME / SAVE (Edge Function) ********/
    function openNameModal(sc){
      overlay.style.display="flex";
      nameInput.value=""; err.style.display="none"; nameInput.focus();
      overlay.dataset.score = String(sc ?? 0);
    }
    cancelBtn.addEventListener("click", ()=>{
      overlay.style.display="none";
      // ronde afgesloten zonder opslaan -> nieuwe betaling nodig
      roundSig = null;
      startBtn.disabled = true;
    });

    async function submitName(){
      const name = (nameInput.value||"").trim();
      if(!name){ err.textContent="Name is required."; err.style.display="block"; return; }
      const sc = Number(overlay.dataset.score||0);
      overlay.style.display="none";
      try{
        const resp = await fetch(EDGE_FN_URL, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ name, score: sc, tx_sig: roundSig })
        });
        const out = await resp.json().catch(()=> ({}));
        if(!resp.ok || !out?.ok) throw new Error(out?.error || "submit-score failed");
      }catch(e){
        console.error(e);
        alert("Saving failed (payment proof required).");
      }finally{
        // ronde afgelopen -> opnieuw betalen
        roundSig = null;
        startBtn.disabled = true;
        renderTop3();
      }
    }
    nameInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); submitName(); } });
    saveBtn.addEventListener("click", submitName);

    /******** LEADERBOARD (Top-3) ********/
    function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
    async function renderTop3(){
      tbody.innerHTML = "<tr><td colspan='3' class='muted'>Loading‚Ä¶</td></tr>"; lbNote.style.display="none";
      try{
        const { data, error } = await sb.from(TABLE).select("*").order("score",{ascending:false}).order("created_at",{ascending:true}).limit(3);
        if(error) throw error;
        tbody.innerHTML=""; (data||[]).forEach((r,i)=>{ const tr=document.createElement("tr"); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml((r.name||"").toString().slice(0,30)||"Anonymous")}</td><td>${Number(r.score)||0}</td>`; tbody.appendChild(tr); });
      }catch(e){
        console.warn("Cloud leaderboard failed:", e);
        lbNote.style.display="block"; tbody.innerHTML = "<tr><td colspan='3' class='muted'>No data</td></tr>";
      }
    }

    // init
    initGame(); renderTop3();
  </script>
</body>
</html>

