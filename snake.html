<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>CBS Snake Game</title>
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    :root{
      --bg1:#0b0b0b; --bg2:#141414; --fg:#eafffb; --accent:#00ffff;
      --panel:#0e0f12; --border:#00ffcc; --muted:#9aa;
      --glow: 0 0 22px rgba(0,255,204,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Orbitron',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, #07222620 0%, transparent 50%),
        radial-gradient(1200px 600px at 90% 100%, #004c4c20 0%, transparent 50%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg);display:flex;flex-direction:column;align-items:center;
      padding:clamp(.75rem,2vw,1.25rem);min-height:100vh
    }
    header{display:flex;align-items:center;gap:.8rem;margin:.4rem 0 1rem;flex-wrap:wrap;justify-content:center;text-align:center}
    header img{height:48px;filter:drop-shadow(0 0 8px rgba(0,255,255,.25))}
    h1{font-size:clamp(1.4rem,4.5vw,2rem);color:var(--accent);letter-spacing:.5px;text-shadow:0 0 10px rgba(0,255,255,.25)}
    .panel{
      background:linear-gradient(180deg,#0e1114,#0b0c0f);
      border:1.5px solid var(--border);border-radius:16px;padding:1rem;margin:.6rem;
      box-shadow:var(--glow);width:100%;max-width:680px
    }
    .controls{
      display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;justify-content:center;margin:.25rem 0 .5rem
    }
    .control{
      display:flex;gap:.5rem;align-items:center;background:#0b0e10;border:1px solid #1c2e2e;padding:.5rem .75rem;border-radius:12px;
      box-shadow: 0 0 10px rgba(0,255,204,.12) inset;
      font-size:.95rem
    }
    .control label{opacity:.9}
    select, input[type="checkbox"]{
      accent-color:#00e5ff;
    }
    select{
      background:#000;border:1px solid var(--border);color:#fff;border-radius:10px;padding:.35rem .6rem;font-family:inherit
    }
    .btn{
      background:linear-gradient(180deg,#00ffe0,#00c8ff);
      color:#001014;border:none;padding:.8rem 1.3rem;border-radius:.8rem;cursor:pointer;font-weight:700;
      font-size:1rem;box-shadow:0 6px 22px rgba(0,255,224,.25), inset 0 0 0 2px rgba(0,0,0,.1)
    }
    .btn:hover{filter:brightness(1.05)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    canvas{
      display:block;margin:.4rem auto;border:2px solid var(--accent);border-radius:12px;
      width:100%;max-width:440px;height:auto;background:#000;touch-action:none;
      box-shadow: 0 0 18px rgba(0,255,255,.25)
    }

    /* D-PAD mobile controls */
    .dpad{
      display:none; /* default verborgen op desktop */
      position:sticky;bottom:env(safe-area-inset-bottom,10px);
      margin: .25rem auto 0;max-width:440px;padding:.4rem 0
    }
    .dgrid{
      display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;justify-items:center;align-items:center
    }
    .dirbtn{
      width:80px;height:80px;border-radius:16px;border:1px solid #1c2e2e;background:#0a0e11;color:#dff;
      font-size:1.3rem;font-weight:700;cursor:pointer;
      box-shadow: inset 0 0 18px rgba(0,255,224,.12), 0 0 14px rgba(0,255,224,.12)
    }
    .dirbtn:active{transform:scale(.97);filter:brightness(1.15)}
    .dirbtn.empty{visibility:hidden}

    table{width:100%;border-collapse:collapse;font-size:clamp(.9rem,2.2vw,1rem)}
    th,td{padding:.55rem;border-bottom:1px solid #1c2e2e;text-align:center}
    .muted{color:var(--muted)}
    /* Overlay */
    #nameOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    #nameCard{background:#0e1114;border:1.5px solid var(--border);border-radius:14px;padding:1rem 1.1rem;box-shadow:var(--glow);width:min(92vw,420px)}
    #nameInput{width:100%;padding:.75rem 1rem;border:1.5px solid var(--border);border-radius:.6rem;background:#000;color:#fff;font-family:inherit;font-size:1rem}
    #error{color:#ff6e8a;font-size:.85rem;margin-top:.35rem;display:none}
    #saveBtn{min-width:6rem}
    /* Small tweaks for small screens */
    @media (max-width:520px){
      .dirbtn{width:74px;height:74px}
      .btn{padding:.75rem 1.1rem}
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="CBS Logo">
    <h1>CBS Snake Game</h1>
  </header>

  <div class="panel">
    <div class="controls">
      <button id="playBtn" class="btn">‚ñ∂Ô∏è Play</button>
      <div class="control">
        <label for="speed">Speed</label>
        <select id="speed">
          <option value="130">Easy</option>
          <option value="100" selected>Normal</option>
          <option value="80">Fast</option>
        </select>
      </div>
      <div class="control">
        <label for="wrap">Wrap walls</label>
        <input id="wrap" type="checkbox">
      </div>
      <div class="control">
        <label for="showPad">On-screen controls</label>
        <input id="showPad" type="checkbox">
      </div>
    </div>

    <p style="text-align:center;margin:.2rem 0 .4rem">
      <strong>Entry fee:</strong> 100 CBS <span class="muted">(demo mode, free play)</span>
    </p>

    <canvas id="gameCanvas" width="400" height="400" aria-label="Snake game board"></canvas>

    <!-- D-PAD -->
    <div id="dpad" class="dpad" aria-label="On-screen controls">
      <div class="dgrid">
        <button class="dirbtn empty" tabindex="-1" aria-hidden="true">‚Ä¢</button>
        <button id="btnUp" class="dirbtn" aria-label="Up">‚ñ≤</button>
        <button class="dirbtn empty" tabindex="-1" aria-hidden="true">‚Ä¢</button>

        <button id="btnLeft" class="dirbtn" aria-label="Left">‚óÄ</button>
        <button id="btnDown" class="dirbtn" aria-label="Down">‚ñº</button>
        <button id="btnRight" class="dirbtn" aria-label="Right">‚ñ∂</button>
      </div>
    </div>
  </div>

  <div class="panel" id="boardWrap">
    <h2 style="text-align:center;">üèÜ Top 3</h2>
    <p class="muted" style="text-align:center;margin-top:-.25rem">Only the three highest scores are shown.</p>
    <table>
      <thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <p id="lbNote" class="muted" style="display:none;margin-top:.5rem;text-align:center">Showing local scores (cloud unavailable).</p>
  </div>

  <!-- Name input overlay -->
  <div id="nameOverlay">
    <div id="nameCard">
      <h3 style="margin:.2rem 0 .6rem;color:var(--accent)">Save your score</h3>
      <p class="muted" style="margin:.1rem 0 .6rem">Type your name and press <b>Enter</b> to submit.</p>
      <input id="nameInput" maxlength="30" placeholder="Your name or wallet‚Ä¶" autocomplete="off" />
      <div id="error">Name is required.</div>
      <div style="margin-top:.8rem;text-align:right">
        <button id="saveBtn" class="btn" style="padding:.6rem 1rem">Save</button>
        <button id="cancelBtn" class="btn" style="background:#2c2f33;color:#dfe;box-shadow:none;border:1px solid #1c2e2e">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ===== Supabase config =====
    const SUPABASE_URL = "https://aiawteejixsgsunmefpi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpYXd0ZWVqaXhzZ3N1bm1lZnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NDExODIsImV4cCI6MjA3MTAxNzE4Mn0.aMbRUM0YebNMfZhSLb9PFdSHAZ-D5WpACPefCfjSLqI";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE = "leaderboard";

    // ===== Game state =====
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const box = 20;

    let snake, direction, nextDir, food, score, game;
    let pendingScore = null;
    let saving = false;

    // Preferences
    const isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;
    const getPref = (k, d) => { try{ const v = localStorage.getItem("cbs_"+k); return v===null? d : JSON.parse(v);}catch{return d;} };
    const setPref = (k, v) => { try{ localStorage.setItem("cbs_"+k, JSON.stringify(v)); }catch{} };

    const speedSel = document.getElementById("speed");
    const wrapChk  = document.getElementById("wrap");
    const padChk   = document.getElementById("showPad");
    const dpad     = document.getElementById("dpad");

    // defaults
    speedSel.value = String(getPref("speed", isTouch ? 130 : 100));
    wrapChk.checked = !!getPref("wrap", isTouch ? true : false);
    padChk.checked  = !!getPref("pad",  isTouch ? true : false);
    dpad.style.display = padChk.checked ? "block" : "none";

    speedSel.addEventListener("change", ()=>{ setPref("speed", Number(speedSel.value)); if(game) restartWithNewSpeed(); });
    wrapChk.addEventListener("change", ()=> setPref("wrap", wrapChk.checked));
    padChk.addEventListener("change", ()=>{ setPref("pad", padChk.checked); dpad.style.display = padChk.checked?"block":"none"; });

    // Buttons
    document.getElementById("playBtn").addEventListener("click", startGame);
    document.getElementById("saveBtn").addEventListener("click", submitName);
    document.getElementById("cancelBtn").addEventListener("click", cancelName);

    // D-pad handlers
    const btnUp = document.getElementById("btnUp");
    const btnDown = document.getElementById("btnDown");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");
    function setDir(d){
      const opp = {LEFT:"RIGHT",RIGHT:"LEFT",UP:"DOWN",DOWN:"UP"};
      if(direction && d===opp[direction]) return; // prevent 180¬∞
      nextDir = d;
    }
    [btnUp,btnDown,btnLeft,btnRight].forEach((b)=>{
      if(!b) return;
      b?.addEventListener("click", ()=> setDir(b===btnUp?"UP":b===btnDown?"DOWN":b===btnLeft?"LEFT":"RIGHT"));
      b?.addEventListener("touchstart", (e)=>{ e.preventDefault(); setDir(b===btnUp?"UP":b===btnDown?"DOWN":b===btnLeft?"LEFT":"RIGHT"); }, {passive:false});
    });

    // Fallback lokale scores
    function getLocalScores(){
      try { return JSON.parse(localStorage.getItem("cbs_snake_scores") || "[]"); }
      catch { return []; }
    }
    function putLocalScore(name, score){
      const arr = getLocalScores();
      arr.push({ name, score, created_at: new Date().toISOString() });
      arr.sort((a,b)=> b.score - a.score || new Date(a.created_at)-new Date(b.created_at));
      localStorage.setItem("cbs_snake_scores", JSON.stringify(arr.slice(0,50)));
    }

    function randFood(){
      return { x: Math.floor(Math.random()*20)*box, y: Math.floor(Math.random()*20)*box };
    }

    function initGame(){
      snake=[{x:10*box,y:10*box}];
      direction=null; nextDir=null;
      food=randFood();
      score=0;
    }

    document.addEventListener("keydown", e=>{
      if(e.key==="ArrowLeft")  setDir("LEFT");
      else if(e.key==="ArrowUp")    setDir("UP");
      else if(e.key==="ArrowRight") setDir("RIGHT");
      else if(e.key==="ArrowDown")  setDir("DOWN");
    });

    // Swipe/tap fallback on canvas
    canvas.addEventListener("touchstart", e=>{
      if(!isTouch) return;
      e.preventDefault();
      const r=canvas.getBoundingClientRect();
      const cx=r.left+r.width/2, cy=r.top+r.height/2;
      const dx=e.changedTouches[0].clientX-cx, dy=e.changedTouches[0].clientY-cy;
      if(Math.abs(dx)>Math.abs(dy)){
        setDir(dx>0?"RIGHT":"LEFT");
      }else{
        setDir(dy>0?"DOWN":"UP");
      }
    }, {passive:false});

    // ===== Rendering helpers (neon snake + coin) =====
    function drawRoundedRect(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }

    function drawNeonSegment(x, y, size, isHead=false){
      ctx.save();
      const grad = ctx.createLinearGradient(x, y, x+size, y+size);
      grad.addColorStop(0, "#35d0ff");
      grad.addColorStop(1, "#00e5ff");
      ctx.shadowColor = "#00d5ff";
      ctx.shadowBlur = 18;
      drawRoundedRect(x+2, y+2, size-4, size-4, 6);
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,255,255,.25)";
      ctx.stroke();

      if(isHead){
        ctx.beginPath();
        ctx.arc(x+size*0.7, y+size*0.35, 2, 0, Math.PI*2);
        ctx.fillStyle = "#fff";
        ctx.fill();
      }
      ctx.restore();
    }

    function drawCoin(x, y, size){
      ctx.save();
      const r = size/2;
      const cx = x + r, cy = y + r;
      ctx.shadowColor = "#ffd54d";
      ctx.shadowBlur = 14;
      const g = ctx.createRadialGradient(cx, cy, r*0.2, cx, cy, r);
      g.addColorStop(0, "#ffe27a");
      g.addColorStop(0.6, "#ffca28");
      g.addColorStop(1, "#ffb300");
      ctx.beginPath();
      ctx.arc(cx, cy, r-2, 0, Math.PI*2);
      ctx.fillStyle = g;
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,255,255,.35)";
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(cx - r*0.3, cy - r*0.3, r*0.5, Math.PI*1.1, Math.PI*1.8);
      ctx.strokeStyle = "rgba(255,255,255,.5)";
      ctx.lineWidth = 1;
      ctx.stroke();
      ctx.restore();
    }

    function step(){
      // apply pending direction at tick start (prevents 180¬∞)
      if(nextDir) { direction = nextDir; nextDir = null; }

      // compute next head
      let x=snake[0].x, y=snake[0].y;
      if(direction==="LEFT") x-=box;
      if(direction==="UP")   y-=box;
      if(direction==="RIGHT")x+=box;
      if(direction==="DOWN") y+=box;

      // wrap walls if enabled
      if(wrapChk.checked){
        const W = canvas.width, H = canvas.height;
        if(x < 0) x = W - box; else if(x >= W) x = 0;
        if(y < 0) y = H - box; else if(y >= H) y = 0;
      }

      // eat
      if(x===food.x && y===food.y){
        score++;
        food=randFood();
        if(navigator.vibrate) navigator.vibrate(15);
      }else{
        snake.pop();
      }

      const head={x,y};

      // collisions
      const hitWall = !wrapChk.checked && (x<0||y<0||x>=canvas.width||y>=canvas.height);
      const hitSelf = snake.some(s=>s.x===x&&s.y===y);
      if(hitWall || hitSelf){
        stopGame();
        if(navigator.vibrate) navigator.vibrate(60);
        onGameOver(score);
        renderFrame(); // final frame
        return;
      }
      snake.unshift(head);

      renderFrame();
    }

    function renderFrame(){
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      drawCoin(food.x, food.y, box);

      for(let i=snake.length-1;i>=0;i--){
        drawNeonSegment(snake[i].x, snake[i].y, box, i===0);
      }

      ctx.fillStyle="#fff";
      ctx.font="18px Orbitron";
      ctx.fillText("Score: "+score, box, 20);
    }

    function startGame(){
      initGame();
      stopGame();
      game = setInterval(step, Number(speedSel.value)||100);
      document.getElementById("playBtn").blur();
    }
    function stopGame(){ if(game){ clearInterval(game); game=null; } }
    function restartWithNewSpeed(){ if(game){ clearInterval(game); game=setInterval(step, Number(speedSel.value)||100); } }

    // ===== Name overlay & saving =====
    const overlay = document.getElementById("nameOverlay");
    const nameInput = document.getElementById("nameInput");
    const err = document.getElementById("error");
    const saveBtn = document.getElementById("saveBtn");
    const lbNote = document.getElementById("lbNote");

    function onGameOver(sc){
      pendingScore = Number.isFinite(sc) ? sc : 0;
      overlay.style.display = "flex";
      nameInput.value = "";
      err.style.display = "none";
      setTimeout(()=>nameInput.focus(), 30);
    }
    function cancelName(){ overlay.style.display = "none"; pendingScore = null; }

    let savingTimeout = null;
    async function submitName(){
      if(saving) return;
      const name = (nameInput.value || "").trim();
      if(!name){ err.textContent="Name is required."; err.style.display="block"; return; }
      if(name.length>30){ err.textContent="Max 30 characters."; err.style.display="block"; return; }

      err.style.display="none";
      saveBtn.disabled = true; saving = true;
      clearTimeout(savingTimeout);
      savingTimeout = setTimeout(()=>{ saving=false; saveBtn.disabled=false; }, 8000);

      const sc = pendingScore ?? 0;
      overlay.style.display="none";
      try{
        const ok = await saveScoreToCloud(name, sc);
        if(!ok){ putLocalScore(name, sc); alert("Cloud save failed. Saved locally instead."); }
      }catch{
        putLocalScore(name, sc); alert("Save failed unexpectedly. Saved locally instead.");
      }finally{
        pendingScore = null;
        await renderCloudBoard();
        saving=false; saveBtn.disabled=false; clearTimeout(savingTimeout);
      }
    }
    nameInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); submitName(); } });

    async function saveScoreToCloud(name, score){
      if(!Number.isFinite(score) || score<0) score = 0;
      try{
        const { error } = await sb.from(TABLE).insert([{ name, score }]);
        if(error){ console.error("Supabase insert error:", error); return false; }
        return true;
      }catch(e){ console.error("Supabase insert threw:", e); return false; }
    }

    // ===== Leaderboard: ONLY TOP-3 =====
    async function renderCloudBoard(){
      const tbody=document.getElementById("leaderboardBody");
      tbody.innerHTML = "<tr><td colspan='3' class='muted'>Loading‚Ä¶</td></tr>";
      lbNote.style.display = "none";

      let rows=null;
      try{
        const { data, error } = await sb
          .from(TABLE)
          .select("*")
          .order("score", { ascending:false })
          .order("created_at", { ascending:true })
          .limit(3);
        if(error) throw error;
        rows = data || [];
      }catch(e){
        console.warn("Cloud leaderboard failed, using local:", e);
      }

      if(!rows || rows.length===0){
        const local = getLocalScores()
          .sort((a,b)=> b.score - a.score || new Date(a.created_at)-new Date(b.created_at))
          .slice(0,3);
        rows = local;
        lbNote.style.display = "block";
      }

      tbody.innerHTML="";
      rows.forEach((r,i)=>{
        const tr=document.createElement("tr");
        const safeName = escapeHtml((r.name||"").toString().slice(0,30) || "Anonymous");
        const safeScore = Number.isFinite(r.score)? r.score : 0;
        tr.innerHTML = `<td>${i+1}</td><td>${safeName}</td><td>${safeScore}</td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    // Wallet connect (demo)
    async function connectWallet(){
      if(window.solana && window.solana.isPhantom){
        try{
          const r=await window.solana.connect();
          alert("Connected: "+r.publicKey.toString());
        }catch(e){ console.error(e); }
      } else { alert("Phantom Wallet not found."); }
    }

    // Initial load
    (async ()=>{ 
      try{ await renderCloudBoard(); } catch(e){ console.error(e); }
      initGame(); renderFrame(); // toon direct een frame
    })();
  </script>
</body>
</html>

