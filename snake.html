<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBS Snake Game</title>
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    :root { --bg1:#0f0f0f; --bg2:#1a1a1a; --fg:#00ffcc; --accent:#00ffff; --panel:#111; --border:#00ffcc; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Orbitron',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--fg);display:flex;flex-direction:column;align-items:center;padding:1rem;min-height:100vh}
    header{display:flex;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;text-align:center;justify-content:center}
    header img{height:50px}
    h1{font-size:clamp(1.5rem,4vw,2rem);color:var(--accent)}
    .panel{background:var(--panel);border:2px solid var(--border);border-radius:1rem;padding:1rem;margin:0.5rem;box-shadow:0 0 20px rgba(0,255,204,0.3);max-width:95vw;width:100%;max-width:640px}
    canvas{display:block;margin:0 auto;border:2px solid var(--accent);width:100%;max-width:400px;height:auto;background:#000;touch-action:none}
    button{background:var(--fg);color:#000;border:none;padding:0.8rem 1.5rem;border-radius:0.5rem;cursor:pointer;font-weight:bold;margin:0.5rem;font-size:1rem}
    button:hover{background:var(--accent)}
    #boardWrap{margin-top:1rem;overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:clamp(0.8rem,2vw,1rem)}
    th,td{padding:0.5rem;border-bottom:1px solid var(--border);text-align:center}
    .muted{color:#9aa}
    /* Name overlay */
    #nameOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:50;
    }
    #nameCard{
      background:#111;border:2px solid var(--border);border-radius:12px;
      padding:1rem 1.25rem;box-shadow:0 0 18px rgba(0,255,204,.35);width:min(92vw,420px);
    }
    #nameInput{
      width:100%;padding:.75rem 1rem;border:2px solid var(--border);
      border-radius:.6rem;background:#000;color:#fff;font-family:inherit;font-size:1rem;
    }
    #error{color:#ff5d7a;font-size:.85rem;margin-top:.35rem;display:none}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="CBS Logo">
    <h1>CBS Snake Game</h1>
  </header>

  <div style="margin-bottom:1rem;">
    <button onclick="connectWallet()">üîó Connect Wallet</button>
  </div>

  <div class="panel">
    <p style="text-align:center;"><strong>Entry fee:</strong> 100 CBS <span class="muted">(demo mode, free play)</span></p>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div style="text-align:center;">
      <button onclick="startGame()">‚ñ∂Ô∏è Play Snake</button>
    </div>
  </div>

  <div class="panel" id="boardWrap">
    <h2 style="text-align:center;">üèÜ Wall of Fame</h2>
    <p class="muted" style="text-align:center;margin-top:-.25rem">High scores are shared for everyone.</p>
    <table>
      <thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>

  <!-- Name input overlay (shown after game over) -->
  <div id="nameOverlay">
    <div id="nameCard">
      <h3 style="margin:.2rem 0 .6rem;color:var(--accent)">Save your score</h3>
      <p class="muted" style="margin:.1rem 0 .6rem">Type your name and press <b>Enter</b> to submit.</p>
      <input id="nameInput" maxlength="30" placeholder="Your name or wallet‚Ä¶" autocomplete="off" />
      <div id="error">Name is required.</div>
      <div style="margin-top:.8rem;text-align:right">
        <button onclick="submitName()">Save</button>
        <button onclick="cancelName()" style="background:#333;color:#ddd">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ===== Supabase config (your values) =====
    const SUPABASE_URL = "https://aiawteejixsgsunmefpi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpYXd0ZWVqaXhzZ3N1bm1lZnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NDExODIsImV4cCI6MjA3MTAxNzE4Mn0.aMbRUM0YebNMfZhSLb9PFdSHAZ-D5WpACPefCfjSLqI";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE = "leaderboard"; // jouw tabelnaam

    // ===== Game state =====
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const logo = new Image(); logo.src = "logo.png"; // CBS-logo = snake & food
    let box=20, snake, direction, food, score, game;
    let pendingScore = null; // score waiting to be saved

    function randFood(){ return { x:Math.floor(Math.random()*19+1)*box, y:Math.floor(Math.random()*19+1)*box }; }

    function initGame(){
      snake=[{x:9*box,y:10*box}];
      direction=null;
      food=randFood();
      score=0;
    }

    document.addEventListener("keydown", e=>{
      if(e.key==="ArrowLeft" && direction!=="RIGHT") direction="LEFT";
      else if(e.key==="ArrowUp" && direction!=="DOWN") direction="UP";
      else if(e.key==="ArrowRight" && direction!=="LEFT") direction="RIGHT";
      else if(e.key==="ArrowDown" && direction!=="UP") direction="DOWN";
    });

    // Tap controls
    canvas.addEventListener("touchstart", e=>{
      e.preventDefault();
      const r=canvas.getBoundingClientRect();
      const cx=r.left+r.width/2, cy=r.top+r.height/2;
      const dx=e.changedTouches[0].clientX-cx, dy=e.changedTouches[0].clientY-cy;
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>0 && direction!=="LEFT") direction="RIGHT";
        else if(dx<0 && direction!=="RIGHT") direction="LEFT";
      }else{
        if(dy>0 && direction!=="UP") direction="DOWN";
        else if(dy<0 && direction!=="DOWN") direction="UP";
      }
    }, {passive:false});

    function draw(){
      ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);

      for(const seg of snake) ctx.drawImage(logo, seg.x, seg.y, box, box);
      ctx.drawImage(logo, food.x, food.y, box, box);

      let x=snake[0].x, y=snake[0].y;
      if(direction==="LEFT") x-=box;
      if(direction==="UP")   y-=box;
      if(direction==="RIGHT")x+=box;
      if(direction==="DOWN") y+=box;

      if(x===food.x && y===food.y){ score++; food=randFood(); } else { snake.pop(); }

      const head={x,y};
      if(x<0||y<0||x>=canvas.width||y>=canvas.height|| snake.slice(1).some(s=>s.x===x&&s.y===y)){
        clearInterval(game);
        onGameOver(score);
        return;
      }
      snake.unshift(head);

      ctx.fillStyle="#fff"; ctx.font="18px Orbitron";
      ctx.fillText("Score: "+score, box, 20);
    }

    function startGame(){ initGame(); clearInterval(game); game=setInterval(draw,100); }

    // ===== Name overlay & save to Supabase =====
    const overlay = document.getElementById("nameOverlay");
    const nameInput = document.getElementById("nameInput");
    const err = document.getElementById("error");

    function onGameOver(sc){
      pendingScore = sc;
      overlay.style.display = "flex";
      nameInput.value = "";
      nameInput.focus();
    }

    function cancelName(){
      overlay.style.display = "none";
      pendingScore = null;
    }

    async function submitName(){
      const name = (nameInput.value || "").trim();
      if(!name){ err.style.display="block"; return; }
      err.style.display="none";
      overlay.style.display="none";
      const ok = await saveScoreToCloud(name, pendingScore ?? 0);
      pendingScore = null;
      if(!ok) alert("Saving failed. Please try again.");
      await renderCloudBoard(); // refresh table
    }

    nameInput.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); submitName(); }
    });

    async function saveScoreToCloud(name, score){
      try{
        const { error } = await sb.from(TABLE).insert([{ name, score }]);
        if(error){ console.error(error); return false; }
        return true;
      }catch(e){ console.error(e); return false; }
    }

    async function renderCloudBoard(){
      const tbody=document.getElementById("leaderboardBody");
      tbody.innerHTML = "<tr><td colspan='3' class='muted'>Loading‚Ä¶</td></tr>";
      const { data, error } = await sb
        .from(TABLE)
        .select("*")
        .order("score", { ascending:false })
        .order("created_at", { ascending:true })
        .limit(10);
      if(error){ console.error(error); tbody.innerHTML="<tr><td colspan='3'>Error loading leaderboard</td></tr>"; return; }
      tbody.innerHTML="";
      data.forEach((r,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.score}</td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    // Wallet connect (demo)
    async function connectWallet(){
      if(window.solana && window.solana.isPhantom){
        try{ const r=await window.solana.connect(); alert("Connected: "+r.publicKey.toString()); }
        catch(e){ console.error(e); }
      } else { alert("Phantom Wallet not found."); }
    }

    // Initial load
    renderCloudBoard();
  </script>
</body>
</html>
