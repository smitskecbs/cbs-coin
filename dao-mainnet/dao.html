<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO â€“ Stemmen (Mainnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--green:#39ff14;--muted:#66ffff;--panel:#0b0f16;--accent:#16a34a}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(960px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan);text-align:left}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .q{display:flex;gap:10px;align-items:center;font-size:18px;margin:10px 0 14px;color:var(--green)}
    .fl{font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    button,a.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;align-items:center}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:320px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
    .meter{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .bar{height:10px;border-radius:8px;background:#041a17;border:1px solid #064e3b;overflow:hidden;flex:1}
    .fill{height:100%;background:linear-gradient(90deg,#00ffcc,#39ff14)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO â€“ Stemmen op proposal</h1>
    <p class="sub">Netwerk: <b>Mainnet-beta</b> â€¢ RPC: <code>https://api.mainnet-beta.solana.com</code></p>

    <div class="q">
      <span class="fl">ðŸ”¥</span><b>Vraag:</b>
      <span id="question">â€”</span>
      <span class="fl">ðŸ”¥</span>
    </div>

    <div class="kv">
      <b>Wallet:</b> <code id="wallet">niet verbonden</code>
    </div>
    <div class="kv">
      <b>Program ID:</b> <code id="prog"></code>
    </div>
    <div class="kv">
      <b>Proposal:</b> <code id="prop"></code>
    </div>
    <div class="kv">
      <b>Vote receipt PDA:</b> <code id="receipt">-</code>
    </div>
    <div class="kv">
      <b>Status:</b> <span id="status" class="status warn">ladenâ€¦</span>
    </div>

    <div class="row">
      <button id="btnYes" class="secondary" disabled>Stem YES</button>
      <button id="btnNo" class="secondary" disabled>Stem NO</button>
      <button id="btnRefresh" class="secondary">Ververs teller</button>
      <button id="btnConnect">Connect Phantom</button>
    </div>

    <div class="meter">
      <div class="bar"><div class="fill" id="fill" style="width:0%"></div></div>
      <div><b>YES</b> <span id="yesPct">0%</span></div>
      <div style="margin-left:auto"><b>NO</b> <span id="noPct">0%</span></div>
    </div>

    <pre id="log"></pre>
  </div>

  <!-- Web3 IIFE (gÃ©Ã©n modules/bundler nodig) -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <script>
    // ---- Config (JOUW adressen) ----
    const CLUSTER_URL = 'https://api.mainnet-beta.solana.com';
    const PROGRAM_ID = new solanaWeb3.PublicKey('FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY');
    const PROPOSAL_PUBKEY = new solanaWeb3.PublicKey('FUpzQRQfu35NEmqp9pjqnkad3R2K1p5XzM6sLDfXcizx');

    // Anchor discriminator voor `vote(bool yes)`
    const VOTE_DISCRIM = Uint8Array.of(227,110,155,23,136,126,172,25);

    // ---- UI refs ----
    const $ = sel => document.querySelector(sel);
    const log = (m) => { const p = $('#log'); p.textContent += (typeof m === 'string' ? m : JSON.stringify(m,null,2)) + '\n'; p.scrollTop = p.scrollHeight; };
    $('#prog').textContent = PROGRAM_ID.toBase58();
    $('#prop').textContent = PROPOSAL_PUBKEY.toBase58();

    // ---- Solana connection ----
    const conn = new solanaWeb3.Connection(CLUSTER_URL, 'confirmed');
    let wallet = null; // Phantom provider
    let walletPk = null;

    function getProvider() {
      const p = window.solana;
      if (!p || !p.isPhantom) throw new Error('Phantom wallet niet gevonden');
      return p;
    }

    async function connectWallet() {
      try {
        const prov = getProvider();
        const resp = await prov.connect();
        wallet = prov;
        walletPk = new solanaWeb3.PublicKey(resp.publicKey.toString());
        $('#wallet').textContent = walletPk.toBase58();
        $('#btnYes').disabled = false;
        $('#btnNo').disabled = false;
        $('#status').textContent = 'wallet verbonden';
        await deriveVoteReceiptPda(); // toont PDA
      } catch (e) {
        $('#status').textContent = 'wallet connect geannuleerd';
        log(e.message || e);
      }
    }

    // seeds = ["vote", proposal, voter]
    let voteReceiptPda = null;
    async function deriveVoteReceiptPda() {
      if (!walletPk) { $('#receipt').textContent = '-'; return; }
      const [pda] = await solanaWeb3.PublicKey.findProgramAddress(
        [
          Buffer.from('vote'),
          PROPOSAL_PUBKEY.toBuffer(),
          walletPk.toBuffer(),
        ],
        PROGRAM_ID
      );
      voteReceiptPda = pda;
      $('#receipt').textContent = pda.toBase58();
    }

    // ---- Borsh helpers to lezen proposal account ----
    const td = new TextDecoder();
    function readU32LE(d, o){ return new DataView(d.buffer, d.byteOffset, d.byteLength).getUint32(o,true); }
    function readU64LE(d, o){ const v = new DataView(d.buffer, d.byteOffset, d.byteLength).getBigUint64(o,true); return Number(v); }
    function readI64LE(d, o){ const v = new DataView(d.buffer, d.byteOffset, d.byteLength).getBigInt64(o,true); return Number(v); }

    async function loadProposal() {
      const info = await conn.getAccountInfo(PROPOSAL_PUBKEY);
      if (!info) { $('#status').textContent = 'proposal niet gevonden'; return; }
      const data = new Uint8Array(info.data);
      let off = 0;

      // creator (32)
      off += 32;

      // question (borsh string)
      const sl = readU32LE(data, off); off += 4;
      const q = td.decode(data.slice(off, off + sl)); off += sl;
      $('#question').textContent = q || '(onbekend)';

      const yes = readU64LE(data, off); off += 8;
      const no  = readU64LE(data, off); off += 8;
      const createdAt = readI64LE(data, off); off += 8;
      const endsAt    = readI64LE(data, off); off += 8;

      const total = Math.max(1, yes + no);
      const yesPct = Math.round(yes * 100 / total);
      const noPct  = 100 - yesPct;

      $('#yesPct').textContent = yesPct + '%';
      $('#noPct').textContent = noPct + '%';
      $('#fill').style.width = yesPct + '%';

      const now = Math.floor(Date.now()/1000);
      if (now > endsAt) {
        $('#status').className = 'status warn';
        $('#status').textContent = 'gesloten';
        $('#btnYes').disabled = true;
        $('#btnNo').disabled = true;
      } else {
        $('#status').className = 'status ok';
        $('#status').textContent = 'open tot ' + new Date(endsAt*1000).toLocaleString();
      }
    }

    async function sendVote(yesFlag) {
      if (!walletPk) { await connectWallet(); if (!walletPk) return; }
      await deriveVoteReceiptPda();

      const keys = [
        { pubkey: PROPOSAL_PUBKEY, isSigner: false, isWritable: true },
        { pubkey: walletPk,        isSigner: true,  isWritable: true },
        { pubkey: voteReceiptPda,  isSigner: false, isWritable: true },
        { pubkey: solanaWeb3.SystemProgram.programId, isSigner:false, isWritable:false },
      ];

      // Anchor data: 8-byte discriminator + 1 byte voor bool
      const data = new Uint8Array(9);
      data.set(VOTE_DISCRIM, 0);
      data[8] = yesFlag ? 1 : 0;

      const ix = new solanaWeb3.TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
      });

      // Standaard Phantom flow (signTransaction)
      const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash('finalized');
      const tx = new solanaWeb3.Transaction().add(ix);
      tx.recentBlockhash = blockhash;
      tx.feePayer = walletPk;

      try {
        const signed = await wallet.signTransaction(tx);
        const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false });
        log('âœ… TX: ' + sig);
        await conn.confirmTransaction({ signature: sig, blockhash, lastValidBlockHeight }, 'confirmed');
        $('#status').className = 'status ok';
        $('#status').textContent = 'Stem geregistreerd';
        await loadProposal();
      } catch (e) {
        $('#status').className = 'status err';
        $('#status').textContent = 'Stemmen mislukt';
        log(e.message || e);
      }
    }

    // UI events
    $('#btnConnect').onclick = connectWallet;
    $('#btnYes').onclick = () => sendVote(true);
    $('#btnNo').onclick  = () => sendVote(false);
    $('#btnRefresh').onclick = loadProposal;

    // init
    (async () => {
      try {
        await loadProposal();
        // auto-connect als toegestaan
        if (window.solana?.isPhantom) {
          try {
            const resp = await window.solana.connect({ onlyIfTrusted:true });
            if (resp?.publicKey) {
              wallet = window.solana; walletPk = new solanaWeb3.PublicKey(resp.publicKey.toString());
              $('#wallet').textContent = walletPk.toBase58();
              $('#btnYes').disabled = false; $('#btnNo').disabled = false;
              await deriveVoteReceiptPda();
            }
          } catch {}
        } else {
          log('Installeer Phantom om te stemmen: https://phantom.app');
        }
      } catch (e) {
        $('#status').className = 'status err';
        $('#status').textContent = 'Fout bij laden';
        log(e.message || e);
      }
    })();
  </script>
</body>
</html>

