<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO â€“ Stemmen (Mainnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--muted:#66ffff;--panel:#0b0f16}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(980px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan);text-align:left}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .tag{background:#031a18;border:1px solid #064e3b;color:var(--fg);padding:3px 8px;border-radius:999px;font-size:12px}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    .meter{height:10px;background:#09151a;border:1px solid #0e2b2a;border-radius:8px;overflow:hidden}
    .yes{height:100%;background:#00ffc3}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:260px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO â€“ Stemmen op voorstel</h1>
    <div class="sub">Netwerk: <b>Mainnet</b> â€¢ RPC:
      <a id="rpcLink" href="#" target="_blank" rel="noreferrer"></a>
    </div>

    <div class="row"><b>ðŸ”¥ Vraag:</b> <span id="question">ladenâ€¦</span></div>

    <div class="row">Wallet:&nbsp;<code id="wallet">niet verbonden</code></div>
    <div class="row">Program ID:&nbsp;<code id="programId">-</code></div>
    <div class="row">Proposal:&nbsp;<code id="proposalPk">-</code></div>
    <div class="row">Vote receipt PDA:&nbsp;<code id="receiptPk">-</code></div>
    <div class="row">Status:&nbsp;<span id="status" class="status warn">wachtenâ€¦</span></div>

    <div class="row">
      <button id="btnYes">YES: +</button>
      <button id="btnNo" class="secondary">NO: âˆ’</button>
      <button id="btnRefresh" class="secondary">Ververs teller</button>
      <a id="explorerLink" class="tag" target="_blank" rel="noreferrer">Proposal in Explorer</a>
    </div>

    <div class="row" style="align-items:center;">
      <div style="flex:1 1 auto">
        <div class="meter"><div id="yesBar" class="yes" style="width:0%"></div></div>
      </div>
      <div style="min-width:140px;text-align:right">
        <span id="yesPct">YES 0%</span>&nbsp;&nbsp;<span id="noPct">NO 0%</span>
      </div>
    </div>

    <div class="row" style="gap:12px;margin-top:10px">
      <button id="btnConnect" class="secondary">Connect Phantom</button>
    </div>

    <details style="margin-top:10px">
      <summary>Geavanceerd</summary>
      <pre id="log"></pre>
    </details>
  </div>

  <script type="module">
    import { Connection, PublicKey, SystemProgram } from "https://esm.sh/@solana/web3.js@1.95.3";
    import { AnchorProvider, Program, BN } from "https://esm.sh/@coral-xyz/anchor@0.31.1?external=@solana/web3.js";

    // ===== 1) CONFIG =====
    const HELIUS_KEY = "3d335769-1880-4497-8fd0-ac7ed0701a7c";
    const RPC_URL = `https://rpc.helius.xyz/?api-key=${HELIUS_KEY}`;
    const PROPOSAL_PUBKEY = new PublicKey("FUpzQRQfu35NEmqp9Pjqnkad3R2K1p5XzM6sLDFXcizx");

    // ===== DOM =====
    const $  = (s)=>document.querySelector(s);
    const logEl=$("#log"), walletEl=$("#wallet"), programIdEl=$("#programId");
    const proposalPkEl=$("#proposalPk"), receiptPkEl=$("#receiptPk");
    const statusEl=$("#status"), questionEl=$("#question");
    const yesBarEl=$("#yesBar"), yesPctEl=$("#yesPct"), noPctEl=$("#noPct");
    const explorerLink=$("#explorerLink"), rpcLink=$("#rpcLink");
    const enc=new TextEncoder();
    function log(m){ logEl.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; logEl.scrollTop=logEl.scrollHeight; }
    function setStatus(t,cls=""){ statusEl.className="status "+cls; statusEl.textContent=t; }

    // ===== Phantom detectie =====
    function getPhantom(){ const w=window; return w?.solana?.isPhantom?w.solana:(w?.phantom?.solana?.isPhantom?w.phantom.solana:null); }
    function anchorWalletFromPhantom(w){ return { publicKey:w.publicKey, signTransaction:(tx)=>w.signTransaction(tx), signAllTransactions:(txs)=>w.signAllTransactions(txs) }; }

    // ===== State =====
    const connection = new Connection(RPC_URL,"confirmed");
    rpcLink.href = RPC_URL; rpcLink.textContent = RPC_URL;
    proposalPkEl.textContent = PROPOSAL_PUBKEY.toString();
    explorerLink.href = "https://solscan.io/account/"+PROPOSAL_PUBKEY.toString();

    let wallet=null, provider=null, program=null, idl=null, PROGRAM_ID=null;
    let myReceiptPda=null;

    // ===== Helper: PDA zonder Buffer =====
    function voteReceiptPDA(proposal,voter){
      const [pda]=PublicKey.findProgramAddressSync([enc.encode("vote"),proposal.toBuffer(),voter.toBuffer()], PROGRAM_ID);
      return pda;
    }

    // ===== 2) IDL laden (lokaal) =====
    async function loadIdlFromFile(){
      try{
        const res=await fetch("./idl.json",{cache:"no-cache"});
        const j=await res.json();
        idl=j;
        PROGRAM_ID=new PublicKey(j.address || j.metadata?.address);
        programIdEl.textContent=PROGRAM_ID.toString();
        log("IDL geladen (bestand) âœ”");
        return true;
      }catch(e){
        log("IDL laden (bestand) mislukt: "+(e?.message||e));
        return false;
      }
    }

    // ===== 3) Program bouwen met fallback on-chain IDL =====
    async function buildProgram({readOnly=false}={}){
      try{
        const w=readOnly?{
          publicKey:new PublicKey("11111111111111111111111111111111"),
          signTransaction:async(tx)=>tx, signAllTransactions:async(txs)=>txs
        } : (wallet?anchorWalletFromPhantom(wallet):null);

        if(!w){ log("Geen wallet beschikbaar voor Program"); return null; }

        const prov=new AnchorProvider(connection,w,{preflightCommitment:"confirmed"});

        if(!idl || !PROGRAM_ID){
          // Probeer eerst lokaal te laden
          const ok=await loadIdlFromFile();
          if(!ok){ /* noop, we gaan direct chain proberen hieronder */ }
        }

        // 1e poging: lokaal
        if(idl && PROGRAM_ID){
          try{
            program=new Program(idl, PROGRAM_ID, prov);
            log("Program opgebouwd met lokale IDL âœ”");
            return program;
          }catch(e1){
            log("Program (lokale IDL) faalde: "+(e1?.message||e1));
          }
        }

        // 2e poging: IDL van chain
        try{
          const fetched = await Program.fetchIdl(PROGRAM_ID ?? new PublicKey((await (await fetch("./idl.json")).json()).address), prov);
          if(fetched){
            idl=fetched;
            program=new Program(idl, PROGRAM_ID, prov);
            log("IDL opgehaald van chain en Program opgebouwd âœ”");
            return program;
          }else{
            log("Geen IDL gevonden op chain.");
          }
        }catch(e2){
          log("Chain-IDL ophalen faalde: "+(e2?.message||e2));
        }

        program=null; return null;
      }catch(e){
        log("buildProgram error: "+(e?.message||e));
        program=null; return null;
      }
    }

    // ===== 4) Connect Phantom =====
    async function connectPhantom(){
      const prov=getPhantom();
      if(!prov){ alert("Phantom wallet niet gevonden."); return; }
      try{
        await prov.connect({onlyIfTrusted:false});
      }catch(e){
        setStatus("Connect geannuleerd of mislukt.","err"); log(e); return;
      }
      wallet=prov; walletEl.textContent=wallet.publicKey.toString(); setStatus("Verbonden.","ok");
      try{ myReceiptPda=voteReceiptPDA(PROPOSAL_PUBKEY,wallet.publicKey); receiptPkEl.textContent=myReceiptPda.toString(); }catch{}
      program=null; // forceer herbouw met echte wallet
      await refreshTeller();
    }

    // ===== 5) Proposal lezen =====
    async function fetchProposal(){
      const p = await buildProgram({readOnly:true});
      if(!p){
        questionEl.textContent = "niet beschikbaar (IDL probleem)";
        return null;
      }
      try{
        if(!p.account?.proposal){ // IDL bevat account niet
          questionEl.textContent = "niet beschikbaar met deze IDL";
          return null;
        }
        const acc = await p.account.proposal.fetch(PROPOSAL_PUBKEY);
        return acc;
      }catch(e){
        log("fetchProposal error: "+(e?.message||e));
        return null;
      }
    }

    async function refreshTeller(){
      setStatus("Verversenâ€¦");
      const prop = await fetchProposal();
      if(!prop){ setStatus("Fout bij verbinden of IDL.","err"); return; }

      try{ questionEl.textContent = prop.question || "â€”"; }catch{}

      const yes = Number(new BN(prop.yesVotes ?? prop.yes_votes ?? 0));
      const no  = Number(new BN(prop.noVotes  ?? prop.no_votes  ?? 0));
      const tot = Math.max(yes+no,1);
      const pctYes = Math.round((yes/tot)*100);
      const pctNo  = 100 - pctYes;

      yesBarEl.style.width = pctYes+"%";
      yesPctEl.textContent = `YES ${pctYes}%`;
      noPctEl.textContent  = `NO ${pctNo}%`;
      setStatus("Klaar.","ok");
    }

    // ===== 6) Stemmen =====
    async function vote(yesFlag){
      if(!wallet?.publicKey){ alert("Verbind eerst je Phantom wallet."); return; }

      const p = await buildProgram({readOnly:false});
      if(!p){ setStatus("Stemmen uitgeschakeld (IDL probleem).","err"); return; }

      const voteReceipt = voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey);
      setStatus("Stem versturenâ€¦");

      try{
        const sig = await p.methods
          .vote(yesFlag)
          .accounts({
            proposal: PROPOSAL_PUBKEY,
            voter: wallet.publicKey,
            voteReceipt,
            systemProgram: SystemProgram.programId,
          })
          .rpc();

        log("âœ… Tx: "+sig);
        setStatus("Stem geregistreerd.","ok");
        await refreshTeller();
      }catch(e){
        const msg=(e?.message||e).toString();
        log("âŒ vote error: "+msg);
        if(msg.includes("AlreadyVoted")) setStatus("Je hebt al gestemd met deze wallet.","warn");
        else if(msg.includes("AlreadyEnded")) setStatus("De stemperiode is voorbij.","warn");
        else if(msg.toLowerCase().includes("constraintseeds")) setStatus("Seeds/PDA mismatch: controleer Program ID & proposal ID.","err");
        else setStatus("Stemmen mislukt.","err");
      }
    }

    // ===== 7) Events =====
    $("#btnConnect").addEventListener("click", connectPhantom);
    $("#btnRefresh").addEventListener("click", refreshTeller);
    $("#btnYes").addEventListener("click", ()=>vote(true));
    $("#btnNo").addEventListener("click",  ()=>vote(false));

    // ===== 8) Boot =====
    (async()=>{
      setStatus("Startâ€¦");
      // Probeer alvast idl.json; mislukt? geen probleemâ€”fallback pakt het over bij eerste buildProgram
      await loadIdlFromFile();
      await refreshTeller();
      setStatus("Klaar.","ok");
      log("Init klaar.");
    })();
  </script>
</body>
</html>

