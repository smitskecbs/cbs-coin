<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO – Mainnet</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b0b0f; color:#eaeaea; margin:0; }
    .wrap { max-width: 900px; margin: 32px auto; padding: 0 16px; }
    .card { background:#14141a; border:1px solid #23232b; border-radius:16px; padding:20px; margin-bottom:16px; }
    button { cursor:pointer; border:none; padding:12px 16px; border-radius:12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    code { background:#1a1a22; padding:2px 6px; border-radius:6px; }
    .muted { color:#aaa; font-size:14px; }
    .ok { color:#7CFC00; } .warn { color:#FFD700; } .err { color:#ff6b6b; }
    input[type="text"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #2a2a33; background:#0f0f14; color:#eaeaea; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO – Mainnet</h1>

    <div class="card">
      <div class="row">
        <button id="btnConnect">Connect Phantom</button>
        <button id="btnDisconnect">Disconnect</button>
      </div>
      <p id="wallet" class="muted">Wallet: <em>niet verbonden</em></p>
      <p id="network" class="muted">RPC: <code>(nog niet geïnitialiseerd)</code></p>
      <p id="programInfo" class="muted">Program: <code>—</code></p>
      <p id="proposalInfo" class="muted">Proposal: <code>—</code></p>
      <p class="muted">Tip: voeg queryparameters toe:<br>
        <code>?program=FZ...&proposal=FUpz...&rpc=https://api.mainnet-beta.solana.com</code>
      </p>
    </div>

    <div class="card">
      <h2>Status</h2>
      <div id="status">Nog niet geladen…</div>
    </div>

    <div class="card">
      <h2>Acties</h2>
      <div class="row">
        <button id="btnFetch">Fetch proposal</button>
        <button id="btnVoteYes">Vote YES</button>
        <button id="btnVoteNo">Vote NO</button>
      </div>
      <p id="result" class="muted">Resultaat: —</p>
    </div>

    <div class="card">
      <h2>Handmatig invullen</h2>
      <label class="muted">Program ID</label>
      <input id="inpProgram" type="text" placeholder="FZ... (Program ID)" />
      <label class="muted">Proposal Pubkey</label>
      <input id="inpProposal" type="text" placeholder="... (Proposal account pubkey)" />
      <label class="muted">RPC endpoint</label>
      <input id="inpRpc" type="text" placeholder="https://api.mainnet-beta.solana.com" />
      <div class="row" style="margin-top:10px">
        <button id="btnApply">Apply</button>
      </div>
    </div>

    <p class="muted">Console openen (F12) voor gedetailleerde logs. Als dit laadt zónder 404, dan staan je bestanden goed en kunnen we je echte scripts er direct in hangen.</p>
  </div>

  <!-- CDN's: web3 + Anchor (ES modules) -->
  <script type="module">
    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // UI refs
    const walletEl = $("wallet");
    const networkEl = $("network");
    const programInfoEl = $("programInfo");
    const proposalInfoEl = $("proposalInfo");
    const statusEl = $("status");
    const resultEl = $("result");

    // Inputs
    const inpProgram = $("inpProgram");
    const inpProposal = $("inpProposal");
    const inpRpc = $("inpRpc");

    // Query params fallback
    let PROGRAM_ID = (qs.get("program") || "").trim();
    let PROPOSAL_PUBKEY = (qs.get("proposal") || "").trim();
    let RPC_URL = (qs.get("rpc") || "https://api.mainnet-beta.solana.com").trim();

    inpProgram.value = PROGRAM_ID;
    inpProposal.value = PROPOSAL_PUBKEY;
    inpRpc.value = RPC_URL;

    programInfoEl.innerHTML = "Program: <code>" + (PROGRAM_ID || "—") + "</code>";
    proposalInfoEl.innerHTML = "Proposal: <code>" + (PROPOSAL_PUBKEY || "—") + "</code>";
    networkEl.innerHTML = "RPC: <code>" + RPC_URL + "</code>";

    // Load libs
    const [{ Connection, PublicKey, clusterApiUrl }, anchor] = await Promise.all([
      import("https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js").then(m => m.default ? m.default : window.solanaWeb3),
      import("https://unpkg.com/@coral-xyz/anchor@0.29.0/dist/esm/index.js")
    ]);

    // Phantom detect
    const getProvider = () => window?.solana?.isPhantom ? window.solana : null;

    // Anchor setup (lazy; na connect + apply)
    let connection = null;
    let wallet = null;
    let provider = null;
    let program = null;
    let idl = null;

    async function initAnchor() {
      connection = new Connection(RPC_URL, "confirmed");
      provider = new anchor.AnchorProvider(connection, wallet, { commitment: "confirmed" });
      anchor.setProvider(provider);

      // idl.json moet in dezelfde map staan!
      idl = await fetch("./idl.json").then(r => {
        if (!r.ok) throw new Error("idl.json 404: Zet idl.json naast dao.html in dao-mainnet/");
        return r.json();
      });

      if (!PROGRAM_ID) throw new Error("Geen Program ID opgegeven. Vul in of zet ?program=… in de URL.");
      const programId = new PublicKey(PROGRAM_ID);
      program = new anchor.Program(idl, programId, provider);

      statusEl.innerHTML = `<span class="ok">Anchor klaar</span>`;
      programInfoEl.innerHTML = "Program: <code>" + PROGRAM_ID + "</code>";
    }

    // Wallet connect/disconnect
    $("btnConnect").onclick = async () => {
      const phantom = getProvider();
      if (!phantom) {
        alert("Phantom niet gevonden. Installeer Phantom of open in een browser met Phantom.");
        return;
      }
      const resp = await phantom.connect();
      wallet = {
        publicKey: resp.publicKey,
        signTransaction: phantom.signTransaction,
        signAllTransactions: phantom.signAllTransactions,
        signMessage: phantom.signMessage
      };
      walletEl.innerHTML = "Wallet: <code>" + wallet.publicKey.toBase58() + "</code>";
      statusEl.textContent = "Verbonden. Anchor initialiseren…";
      try {
        await initAnchor();
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="err">${e.message}</span>`;
      }
    };

    $("btnDisconnect").onclick = async () => {
      try { await window.solana?.disconnect(); } catch {}
      wallet = null; program = null; provider = null;
      walletEl.innerHTML = "Wallet: <em>niet verbonden</em>";
      statusEl.textContent = "Losgekoppeld.";
    };

    $("btnApply").onclick = async () => {
      PROGRAM_ID = inpProgram.value.trim();
      PROPOSAL_PUBKEY = inpProposal.value.trim();
      RPC_URL = inpRpc.value.trim() || "https://api.mainnet-beta.solana.com";
      networkEl.innerHTML = "RPC: <code>" + RPC_URL + "</code>";
      programInfoEl.innerHTML = "Program: <code>" + (PROGRAM_ID || "—") + "</code>";
      proposalInfoEl.innerHTML = "Proposal: <code>" + (PROPOSAL_PUBKEY || "—") + "</code>";
      statusEl.textContent = "Herinitialiseren…";
      try {
        if (!wallet) {
          statusEl.innerHTML = `<span class="warn">Verbind eerst je wallet.</span>`;
          return;
        }
        await initAnchor();
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="err">${e.message}</span>`;
      }
    };

    // Fetch proposal (leest raw account data via getAccountInfo als fallback)
    $("btnFetch").onclick = async () => {
      try {
        if (!PROPOSAL_PUBKEY) throw new Error("Geen proposal pubkey ingesteld.");
        const pub = new PublicKey(PROPOSAL_PUBKEY);
        const acc = await connection.getAccountInfo(pub);
        if (!acc) {
          resultEl.innerHTML = `<span class="warn">Proposal account niet gevonden op dit RPC.</span>`;
          return;
        }
        console.log("AccountInfo", acc);
        resultEl.innerHTML = `Account gevonden. Owner: <code>${acc.owner.toBase58()}</code>, data len: ${acc.data?.length ?? 0}`;
      } catch (e) {
        console.error(e);
        resultEl.innerHTML = `<span class="err">${e.message}</span>`;
      }
    };

    // Stemmen (veronderstelt methods idl: create_proposal / vote)
    async function vote(yes) {
      try {
        if (!program) throw new Error("Program niet geïnitialiseerd.");
        if (!PROPOSAL_PUBKEY) throw new Error("Geen proposal pubkey ingesteld.");
        const proposalPk = new PublicKey(PROPOSAL_PUBKEY);
        // NB: Deze aanroepnaam moet overeenkomen met je IDL (camelCase of snake_case).
        // Pas dit zonodig aan: program.methods.vote(yes) of program.methods.vote({ yes })
        const txSig = await program.methods
          .vote(yes)                 // ← pas aan indien je IDL andere signatuur heeft
          .accounts({ proposal: proposalPk })
          .rpc();
        resultEl.innerHTML = `<span class="ok">✅ TX: ${txSig}</span>`;
      } catch (e) {
        console.error(e);
        resultEl.innerHTML = `<span class="err">❌ ${e.message}</span>`;
      }
    }

    $("btnVoteYes").onclick = () => vote(true);
    $("btnVoteNo").onclick = () => vote(false);

    // Init status
    statusEl.textContent = "Pagina geladen. Verbind je wallet en vul Program/Proposal/RPC in of gebruik queryparameters.";
    console.log("[DAO] start", { PROGRAM_ID, PROPOSAL_PUBKEY, RPC_URL });
  </script>
</body>
</html>

