<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO – Mainnet (no-Anchor)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#eaeaea; margin:0; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    .card { background:#13131a; border:1px solid #23232b; border-radius:16px; padding:20px; margin-bottom:16px; }
    h1, h2 { margin: 0 0 12px; }
    button { cursor:pointer; border:none; padding:12px 16px; border-radius:12px; background:#1f2430; color:#eaeaea; }
    button:hover { filter: brightness(1.1); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted { color:#a6a6b3; font-size:14px; }
    code { background:#1a1a22; padding:2px 6px; border-radius:6px; }
    input[type="text"], input[type="number"], input[type="datetime-local"]{
      width:100%; padding:10px; border-radius:10px; border:1px solid #2a2a33; background:#0f0f14; color:#eaeaea;
    }
    .ok { color:#79e07f; } .warn { color:#ffd75e; } .err { color:#ff7575; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3 { display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid, .grid3{ grid-template-columns: 1fr; } }
    a { color: #8ab4ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>CBS DAO – Mainnet (no-Anchor)</h1>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <button id="btnConnect">Connect Phantom</button>
        <button id="btnDisconnect">Disconnect</button>
      </div>
      <div><span class="muted">Query:</span> <code>?program=...&rpc=...</code></div>
    </div>
    <p id="wallet" class="muted">Wallet: <em>niet verbonden</em></p>
    <p id="network" class="muted">RPC: <code>(niet ingesteld)</code></p>
    <p id="programInfo" class="muted">Program: <code>—</code></p>
  </div>

  <div class="card">
    <h2>Status</h2>
    <div id="status">Pagina geladen.</div>
  </div>

  <div class="card">
    <h2>CreatorState</h2>
    <div class="row">
      <button id="btnInitState">Init CreatorState</button>
      <button id="btnShowIndex">Toon index</button>
    </div>
    <p id="state" class="muted">—</p>
  </div>

  <div class="card">
    <h2>Proposal aanmaken</h2>
    <div class="grid3">
      <div>
        <label class="muted" for="inpQuestion">Vraag</label>
        <input id="inpQuestion" type="text" placeholder="Bijv. 'Steun je CBS DAO?'" />
      </div>
      <div>
        <label class="muted" for="inpMinutes">Duur (minuten)</label>
        <input id="inpMinutes" type="number" min="1" value="60" />
      </div>
      <div>
        <label class="muted" for="inpEndsAtDT">of Eindtijd</label>
        <input id="inpEndsAtDT" type="datetime-local" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnCreate">Create Proposal</button>
    </div>
    <p id="lastCreate" class="muted">—</p>
  </div>

  <div class="card">
    <h2>Acties op proposal</h2>
    <div class="grid">
      <div>
        <label class="muted" for="inpProposal">Proposal Pubkey</label>
        <input id="inpProposal" type="text" placeholder="Proposal account pubkey" />
      </div>
      <div style="display:flex;align-items:end;gap:8px">
        <button id="btnFetch">Fetch</button>
        <button id="btnYes">Vote YES</button>
        <button id="btnNo">Vote NO</button>
      </div>
    </div>
    <p id="result" class="muted">—</p>
  </div>

  <div class="card">
    <h2>Logs</h2>
    <pre id="logs" class="muted" style="white-space:pre-wrap;word-break:break-word;max-height:360px;overflow:auto;">—</pre>
  </div>
</div>

<script>
const { Connection, PublicKey, SystemProgram, Transaction, TransactionInstruction } = solanaWeb3;
const $ = (id)=>document.getElementById(id);
const statusEl=$("status"), walletEl=$("wallet"), networkEl=$("network"), programInfoEl=$("programInfo"), logsEl=$("logs");
const stateEl=$("state"), lastCreateEl=$("lastCreate"), resultEl=$("result");
const inpQuestion=$("inpQuestion"), inpMinutes=$("inpMinutes"), inpEndsAtDT=$("inpEndsAtDT"), inpProposal=$("inpProposal");

const enc = (s)=> new TextEncoder().encode(s);
const dec = (b)=> new TextDecoder().decode(b);

// === Discriminators (Anchor 0.31) ===
const DISC_INIT_STATE    = Uint8Array.from([105,60,2,31,14,151,165,18]);   // global:init_creator_state
const DISC_CREATE        = Uint8Array.from([132,116,68,174,216,160,198,22]); // global:create_proposal
const DISC_VOTE          = Uint8Array.from([227,110,155,23,136,126,172,25]); // global:vote
// account discriminators alleen voor sanity (niet strikt nodig)
const DISC_ACC_CREATOR   = Uint8Array.from([158,29,241,193,175,176,255,100]); // account:creator_state

function u32le(n){ const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,n>>>0,true); return b; }
function i64le(n){ let x=BigInt(n); if(x<0n)x=(1n<<64n)+x; const b=new Uint8Array(8); for(let i=0;i<8;i++) b[i]=Number((x>>BigInt(8*i))&0xffn); return b; }
function encodeString(str){ const s=enc(str); const out=new Uint8Array(4+s.length); out.set(u32le(s.length),0); out.set(s,4); return out; }

function pdaCreatorState(programId, creatorPk){
  return PublicKey.findProgramAddressSync([enc("creator_state"), creatorPk.toBytes()], programId)[0];
}
function pdaProposal(programId, creatorPk, index){
  return PublicKey.findProgramAddressSync([enc("proposal"), creatorPk.toBytes(), u32le(index)], programId)[0];
}
function pdaVoteReceipt(programId, proposalPk, voterPk){
  return PublicKey.findProgramAddressSync([enc("vote"), proposalPk.toBytes(), voterPk.toBytes()], programId)[0];
}

function ixInitCreatorState(programId, creator, creatorStatePda){
  return new TransactionInstruction({
    programId,
    keys: [
      { pubkey: creatorStatePda, isSigner:false, isWritable:true },
      { pubkey: creator,         isSigner:true,  isWritable:true },
      { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
    ],
    data: DISC_INIT_STATE // geen args
  });
}

function ixCreateProposal(programId, creator, creatorStatePda, proposalPda, question, endsAt, index){
  const q = encodeString(question);
  const data = new Uint8Array(DISC_CREATE.length + q.length + 8 + 4);
  let o=0; data.set(DISC_CREATE,o); o+=DISC_CREATE.length;
  data.set(q,o); o+=q.length;
  data.set(i64le(endsAt),o); o+=8;
  data.set(u32le(index),o);
  return new TransactionInstruction({
    programId,
    keys: [
      { pubkey: creatorStatePda, isSigner:false, isWritable:true },
      { pubkey: proposalPda,     isSigner:false, isWritable:true },
      { pubkey: creator,         isSigner:true,  isWritable:true },
      { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
    ],
    data
  });
}

function ixVote(programId, proposalPk, voter, voteReceiptPda, yes){
  const data = new Uint8Array(DISC_VOTE.length + 1);
  data.set(DISC_VOTE,0); data[DISC_VOTE.length] =
