<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO â€“ Stemmen (Mainnet)</title>

  <!-- Import map: zorg dat alle imports van '@solana/web3.js'
       (ook die binnen Anchor) naar deze CDN-URL wijzen -->
  <script type="importmap">
  {
    "imports": {
      "@solana/web3.js": "https://esm.sh/@solana/web3.js@1.95.3?target=es2020"
    }
  }
  </script>

  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--green:#39ff14;--muted:#66ffff;--panel:#0b0f16;--accent:#16a34a}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(980px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan);text-align:left}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .tag{background:#031a18;border:1px solid #064e3b;color:var(--fg);padding:3px 8px;border-radius:999px;font-size:12px}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    .meter{height:10px;background:#09151a;border:1px solid #0e2b2a;border-radius:8px;overflow:hidden}
    .yes{height:100%;background:#00ffc3}
    .no{height:100%;background:#ff7b7b}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:260px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO â€“ Stemmen op voorstel</h1>
    <div class="sub">Netwerk: <b>Mainnet</b> â€¢ RPC:
      <a id="rpcLink" href="#" target="_blank" rel="noreferrer"></a>
    </div>

    <div class="row"><b>ðŸ”¥ Vraag:</b> <span id="question">ladenâ€¦</span></div>

    <div class="row">Wallet:&nbsp;<code id="wallet">niet verbonden</code></div>
    <div class="row">Program ID:&nbsp;<code id="programId">-</code></div>
    <div class="row">Proposal:&nbsp;<code id="proposalPk">-</code></div>
    <div class="row">Vote receipt PDA:&nbsp;<code id="receiptPk">-</code></div>
    <div class="row">Status:&nbsp;<span id="status" class="status warn">wachtenâ€¦</span></div>

    <div class="row">
      <button id="btnYes">YES: +</button>
      <button id="btnNo" class="secondary">NO: âˆ’</button>
      <button id="btnRefresh" class="secondary">Ververs teller</button>
      <a id="explorerLink" class="tag" target="_blank" rel="noreferrer">Proposal in Explorer</a>
    </div>

    <div class="row" style="align-items:center;">
      <div style="flex:1 1 auto">
        <div class="meter"><div id="yesBar" class="yes" style="width:0%"></div></div>
      </div>
      <div style="min-width:140px;text-align:right">
        <span id="yesPct">YES 0%</span>&nbsp;&nbsp;<span id="noPct">NO 0%</span>
      </div>
    </div>

    <div class="row" style="gap:12px;margin-top:10px">
      <button id="btnConnect" class="secondary">Connect Phantom</button>
    </div>

    <details style="margin-top:10px">
      <summary>Geavanceerd</summary>
      <pre id="log"></pre>
    </details>
  </div>

  <script type="module">
    // Gebruik de import map voor web3.js
    import { Connection, PublicKey, SystemProgram } from "@solana/web3.js";

    // Anchor laadt intern '@solana/web3.js' â€” import map regelt de resolutie.
    import { AnchorProvider, Program, BN }
      from "https://esm.sh/@coral-xyz/anchor@0.31.1?target=es2020";

    // ====== 1) CONFIG ======
    const HELIUS_KEY = "3d335769-1880-4497-8fd0-ac7ed0701a7c";   // jouw Helius key
    const RPC_URL = `https://rpc.helius.xyz/?api-key=${HELIUS_KEY}`;

    // Vast mainnet voorstel
    const PROPOSAL_PUBKEY = new PublicKey("FUpzQRQfu35NEmqp9Pjqnkad3R2K1p5XzM6sLDFXcizx");

    // ====== DOM helpers ======
    const $ = (s) => document.querySelector(s);
    const logEl = $("#log");
    const walletEl = $("#wallet");
    const questionEl = $("#question");
    const programIdEl = $("#programId");
    const proposalPkEl = $("#proposalPk");
    const receiptPkEl = $("#receiptPk");
    const statusEl = $("#status");
    const yesBarEl = $("#yesBar");
    const yesPctEl = $("#yesPct");
    const noPctEl = $("#noPct");
    const explorerLink = $("#explorerLink");
    const rpcLink = $("#rpcLink");
    const enc = new TextEncoder();

    function log(m){ logEl.textContent += (typeof m==="string"?m:JSON.stringify(m,null,2)) + "\n"; logEl.scrollTop = logEl.scrollHeight; }
    function setStatus(t, cls=""){ statusEl.className="status "+cls; statusEl.textContent=t; }

    // ====== Phantom detectie ======
    function getPhantomProvider() {
      const w = window;
      if (w?.solana?.isPhantom) return w.solana;
      if (w?.phantom?.solana?.isPhantom) return w.phantom.solana;
      return null;
    }
    function anchorWalletFromPhantom(w) {
      return {
        publicKey: w.publicKey,
        signTransaction: (tx) => w.signTransaction(tx),
        signAllTransactions: (txs) => w.signAllTransactions(txs),
      };
    }

    // ====== App state ======
    const connection = new Connection(RPC_URL, "confirmed");
    let wallet = null;
    let provider = null;
    let program = null;
    let idl = null;
    let PROGRAM_ID = null;
    let myReceiptPda = null;

    // ====== PDA helpers (zonder Buffer) ======
    function voteReceiptPDA(proposal, voter) {
      const [pda] = PublicKey.findProgramAddressSync(
        [enc.encode("vote"), proposal.toBuffer(), voter.toBuffer()],
        PROGRAM_ID
      );
      return pda;
    }

    // ====== Init basis UI ======
    rpcLink.href = RPC_URL;
    rpcLink.textContent = RPC_URL;
    proposalPkEl.textContent = PROPOSAL_PUBKEY.toString();
    explorerLink.href = "https://solscan.io/account/" + PROPOSAL_PUBKEY.toString();

    // ====== IDL laden ======
    async function loadIdl() {
      try {
        const res = await fetch("./idl.json", { cache: "no-cache" });
        idl = await res.json();
        PROGRAM_ID = new PublicKey(idl.address);
        programIdEl.textContent = PROGRAM_ID.toString();
        log("IDL geladen âœ”");
        return true;
      } catch (e) {
        log("IDL laden mislukt: " + (e?.message || e));
        return false;
      }
    }

    // Maak (of hergebruik) een Program, read-only indien nodig
    function ensureProgram(readOnly=false) {
      if (program) return program;
      if (!idl || !PROGRAM_ID) return null;

      if (readOnly) {
        // dummy wallet voor read-only fetch
        const dummyWallet = {
          publicKey: new PublicKey("11111111111111111111111111111111"),
          signTransaction: async (tx)=>tx,
          signAllTransactions: async (txs)=>txs,
        };
        const roProv = new AnchorProvider(connection, dummyWallet, { preflightCommitment: "confirmed" });
        program = new Program(idl, PROGRAM_ID, roProv);
      } else if (wallet?.publicKey) {
        const aWallet = anchorWalletFromPhantom(wallet);
        provider = new AnchorProvider(connection, aWallet, { preflightCommitment: "confirmed" });
        program = new Program(idl, PROGRAM_ID, provider);
      }
      return program;
    }

    // ====== Connect ======
    async function connectPhantom() {
      const prov = getPhantomProvider();
      if (!prov) {
        alert("Phantom wallet niet gevonden. Installeer de Phantom extensie.");
        return;
      }
      try {
        await prov.connect({ onlyIfTrusted: false });
      } catch (e) {
        log("wallet.connect error: " + (e?.message || e));
        setStatus("Connect geannuleerd of mislukt.", "err");
        return;
      }

      wallet = prov;
      walletEl.textContent = wallet.publicKey.toString();
      setStatus("Verbonden.", "ok");

      try {
        myReceiptPda = voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey);
        receiptPkEl.textContent = myReceiptPda.toString();
      } catch {}

      // opnieuw Program opbouwen nu met echte wallet
      program = null;
      ensureProgram(false);

      wallet.on?.("disconnect", () => {
        wallet = null;
        walletEl.textContent = "niet verbonden";
        setStatus("Wallet losgekoppeld.", "warn");
        program = null;
      });
      wallet.on?.("accountChanged", async () => {
        walletEl.textContent = wallet.publicKey ? wallet.publicKey.toString() : "niet verbonden";
        program = null;
        if (wallet?.publicKey) {
          myReceiptPda = voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey);
          receiptPkEl.textContent = myReceiptPda.toString();
        } else {
          receiptPkEl.textContent = "-";
        }
        await refreshTeller();
      });

      await refreshTeller();
    }

    // ====== Teller + fetch proposal ======
    async function fetchProposal() {
      const p = ensureProgram(true); // read-only genoeg
      if (!p) return null;
      try {
        const acc = await p.account.proposal.fetch(PROPOSAL_PUBKEY);
        return acc;
      } catch (e) {
        log("fetchProposal error: " + (e?.message || e));
        return null;
      }
    }

    async function refreshTeller() {
      setStatus("Verversenâ€¦");
      const p = await fetchProposal();
      if (!p) {
        setStatus("Fout bij verbinden.", "err");
        return;
      }
      try { questionEl.textContent = p.question || "â€”"; } catch {}

      const yes = Number(new BN(p.yesVotes ?? p.yes_votes ?? 0));
      const no  = Number(new BN(p.noVotes  ?? p.no_votes  ?? 0));
      const tot = Math.max(yes + no, 1);
      const pctYes = Math.round((yes / tot) * 100);
      const pctNo  = 100 - pctYes;

      yesBarEl.style.width = pctYes + "%";
      yesPctEl.textContent = `YES ${pctYes}%`;
      noPctEl.textContent  = `NO ${pctNo}%`;
      setStatus("Klaar.", "ok");
    }

    // ====== Stemmen ======
    async function vote(yesFlag) {
      if (!wallet?.publicKey) {
        alert("Verbind eerst je Phantom wallet.");
        return;
      }
      ensureProgram(false);

      const voteReceipt = voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey);
      log("Stem txâ€¦ (yes=" + yesFlag + ")");
      setStatus("Stem versturenâ€¦");

      try {
        const sig = await program.methods
          .vote(yesFlag)
          .accounts({
            proposal: PROPOSAL_PUBKEY,
            voter: wallet.publicKey,
            voteReceipt,
            systemProgram: SystemProgram.programId,
          })
          .rpc();

        log("âœ… Tx: " + sig);
        setStatus("Stem geregistreerd.", "ok");
        await refreshTeller();
      } catch (e) {
        const msg = (e?.message || e).toString();
        log("âŒ vote error: " + msg);
        if (msg.includes("AlreadyVoted")) {
          setStatus("Je hebt al gestemd met deze wallet.", "warn");
        } else if (msg.includes("AlreadyEnded")) {
          setStatus("De stemperiode is voorbij.", "warn");
        } else if (msg.includes("0x1771") || msg.toLowerCase().includes("constraintseeds")) {
          setStatus("Seeds/PDA mismatch: controleer Program ID & proposal ID.", "err");
        } else {
          setStatus("Stemmen mislukt.", "err");
        }
      }
    }

    // ====== Events ======
    $("#btnConnect").addEventListener("click", connectPhantom);
    $("#btnRefresh").addEventListener("click", refreshTeller);
    $("#btnYes").addEventListener("click", () => vote(true));
    $("#btnNo").addEventListener("click",  () => vote(false));

    // ====== Boot ======
    (async () => {
      setStatus("Startâ€¦");
      const ok = await loadIdl();
      if (!ok) { setStatus("IDL niet gevonden/laden mislukt.", "err"); return; }
      await refreshTeller();
      setStatus("Klaar.", "ok");
      log("Init klaar.");
    })();
  </script>
</body>
</html>


