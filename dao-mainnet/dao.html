# backup
cp dao.html dao.html.bak.$(date +%s) 2>/dev/null || true

# overschrijf met mainnet-versie
cat > dao.html <<'HTML'
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO â€“ Stemmen (Mainnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--green:#39ff14;--muted:#66ffff;--panel:#0b0f16;--accent:#16a34a}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(960px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan);text-align:left}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .q{display:flex;gap:10px;align-items:center;font-size:18px;margin:10px 0 14px;color:var(--green)}
    .fl{font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    button,a.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;align-items:center}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:320px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
    .meter{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .bar{flex:1;height:10px;background:#0a1f1a;border-radius:8px;overflow:hidden;border:1px solid #064e3b}
    .bar>span{display:block;height:100%;background:var(--fg)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO â€“ Stemmen op voorstel</h1>
    <div class="sub">Netwerk: <b>Mainnet</b> â€¢ RPC: <code>https://api.mainnet-beta.solana.com</code></div>

    <div class="q"><span class="fl">ðŸ”¥</span><b>Vraag:</b><span id="vraag">ladenâ€¦</span><span class="fl">ðŸ”¥</span></div>

    <div class="kv">Wallet: <code id="wallet">niet verbonden</code></div>
    <div class="kv">Program ID: <code id="pid">â€”</code></div>
    <div class="kv">Proposal: <code id="prop">â€”</code></div>
    <div class="kv">Vote receipt PDA: <code id="vr">â€”</code></div>
    <div class="kv">Status: <span id="status" class="status warn">wachtenâ€¦</span></div>

    <div class="row">
      <button id="btnYes" disabled>YES: âž•</button>
      <button id="btnNo" class="secondary" disabled>NO: âž–</button>
      <button id="btnRefresh" class="secondary">Ververs teller</button>
    </div>

    <div class="meter">
      <div>YES <span id="tYes">0</span>%</div>
      <div class="bar"><span id="barYes" style="width:0%"></span></div>
      <div>NO <span id="tNo">0</span>%</div>
    </div>

    <div class="row">
      <button id="btnConnect">Connect Phantom</button>
    </div>

    <pre id="log"></pre>
  </div>

  <!-- Browser ESM import â€“ gÃ©Ã©n bare specifier -->
  <script type="module">
    import {
      Connection, PublicKey, Transaction, TransactionInstruction, SystemProgram
    } from "https://esm.sh/@solana/web3.js@1.95.3";

    // ==== CONFIG ====
    const RPC_URL   = "https://api.mainnet-beta.solana.com";
    const PROGRAM_ID = new PublicKey("FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY");
    // Laat deze op jouw laatst gemaakte proposal
    const PROPOSAL   = new PublicKey("FUpzQRQfu35NEmqp9pjqnkad3R2K1p5XzM6sLDfXcizx");

    // UI refs
    const el = (id)=>document.getElementById(id);
    const log = (...a)=>{ el('log').textContent += a.join(' ') + "\\n"; el('log').scrollTop = el('log').scrollHeight; };

    const conn = new Connection(RPC_URL, "confirmed");
    el('pid').textContent  = PROGRAM_ID.toBase58();
    el('prop').textContent = PROPOSAL.toBase58();

    // ===== Helpers =====
    async function anchorDisc(name){ // 8-byte discriminator
      const h = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(name));
      return new Uint8Array(h).slice(0,8);
    }
    function u32le(d,off){ return new DataView(d.buffer,d.byteOffset,d.byteLength).getUint32(off,true); }
    function u64le(d,off){ const v=new DataView(d.buffer,d.byteOffset,d.byteLength); const lo=v.getUint32(off,true), hi=v.getUint32(off+4,true); return hi*2**32+lo; }

    async function loadProposal() {
      const acc = await conn.getAccountInfo(PROPOSAL);
      if (!acc){ el('status').textContent="proposal bestaat niet"; el('status').className="status err"; return; }
      const d = new Uint8Array(acc.data); // Anchor account lay-out:
      // [8 disc][32 creator][4 strlen][str][8 yes][8 no][8 created][8 ends]
      let off = 8 + 32;
      const slen = u32le(d, off); off += 4;
      const vraag = new TextDecoder().decode(d.slice(off, off+slen)); off += slen;
      const yes = u64le(d, off); off += 8;
      const no  = u64le(d, off);
      el('vraag').textContent = vraag || "â€”";
      updateMeter(yes, no);
      el('status').textContent = "geladen";
      el('status').className = "status ok";
    }

    function updateMeter(yes,no){
      const tot = yes+no || 1;
      const py  = Math.round(yes*100/tot);
      const pn  = 100-py;
      el('tYes').textContent = py;
      el('tNo').textContent  = pn;
      el('barYes').style.width = py + "%";
    }

    function getProvider(){
      const p = window.solana;
      if (p?.isPhantom) return p;
      alert("Phantom niet gevonden. Installeer Phantom en zet netwerk op Mainnet.");
      throw new Error("Phantom missing");
    }

    async function connectWallet(){
      const provider = getProvider();
      const r = await provider.connect();
      const pub = new PublicKey(r.publicKey.toString());
      el('wallet').textContent = pub.toBase58();
      // derive vote_receipt PDA: ["vote", proposal, voter]
      const [vr] = PublicKey.findProgramAddressSync(
        [ new TextEncoder().encode("vote"), PROPOSAL.toBuffer(), pub.toBuffer() ],
        PROGRAM_ID
      );
      el('vr').textContent = vr.toBase58();
      el('btnYes').disabled = false;
      el('btnNo').disabled  = false;
      log("Wallet verbonden:", pub.toBase58());
    }

    async function sendVote(yes){
      try{
        const provider = getProvider();
        const kp = new PublicKey(provider.publicKey.toString());

        const [voteReceiptPda] = PublicKey.findProgramAddressSync(
          [ new TextEncoder().encode("vote"), PROPOSAL.toBuffer(), kp.toBuffer() ],
          PROGRAM_ID
        );

        // Anchor ix data: discriminator("global:vote") + bool
        const disc = await anchorDisc("global:vote");
        const data = new Uint8Array(9); data.set(disc,0); data[8] = yes ? 1 : 0;

        const keys = [
          { pubkey: PROPOSAL,        isSigner:false, isWritable:true  },
          { pubkey: kp,              isSigner:true,  isWritable:true  },
          { pubkey: voteReceiptPda,  isSigner:false, isWritable:true  },
          { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
        ];

        const ix  = new TransactionInstruction({ programId: PROGRAM_ID, keys, data });
        const tx  = new Transaction().add(ix);
        tx.feePayer = kp;
        tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;

        const signed = await provider.signTransaction(tx);
        const sig = await conn.sendRawTransaction(signed.serialize());
        await conn.confirmTransaction(sig, "confirmed");
        log("âœ… Vote tx:", sig);
        await loadProposal();
      } catch(e){
        console.error(e); log("âŒ Fout:", e.message || e);
        alert("Stemmen mislukt: " + (e.message || e));
      }
    }

    // UI wiring
    el('btnConnect').onclick = connectWallet;
    el('btnYes').onclick = () => sendVote(true);
    el('btnNo').onclick  = () => sendVote(false);
    el('btnRefresh').onclick = loadProposal;

    // start
    loadProposal().catch(e=>log("init:",e));
  </script>
</body>
</html>
HTML

