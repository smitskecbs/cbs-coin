<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO ‚Äì Stemmen (Mainnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--green:#39ff14;--muted:#66ffff;--panel:#0b0f16;--accent:#16a34a}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:flex-start;justify-content:center;padding:20px}
    .wrap{width:min(960px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan);text-align:left}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .q{display:flex;gap:10px;align-items:center;font-size:18px;margin:10px 0 14px;color:var(--green)}
    .fl{font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    button,a.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button.warn{background:#332000;color:#ffd166;border:1px solid #775500}
    button:disabled{opacity:.55;cursor:not-allowed}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;align-items:center}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:320px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
    .meter{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .bar{height:10px;background:#061a17;border:1px solid #064e3b;border-radius:12px;overflow:hidden;flex:1}
    .yes{height:100%;background:#17cf7a;width:0%}
    .badge{background:#061016;border:1px solid #0b3b33;border-radius:8px;padding:3px 7px}
    input[type=text]{background:#061016;border:1px solid #0b3b33;color:var(--fg);padding:8px 10px;border-radius:8px;min-width:340px}
    small.muted{color:#79ffe1;opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO ‚Äì Stemmen op voorstel</h1>
    <div class="sub">Netwerk: <b>Mainnet</b> ‚Ä¢ RPC: <code id="rpcLbl"></code></div>

    <div class="q"><span class="fl">üî•</span> <b>Vraag:</b>&nbsp;<span id="question">laden‚Ä¶</span> <span class="fl">üî•</span></div>

    <div class="kv"><b>Wallet:</b> <span id="wallet" class="badge">niet verbonden</span></div>
    <div class="kv"><b>Program ID:</b> <code id="pid"></code></div>
    <div class="kv"><b>Proposal:</b> <code id="prop"></code></div>
    <div class="kv"><b>Vote receipt PDA:</b> <code id="vr">-</code></div>
    <div class="kv"><b>Status:</b> <span id="status" class="status warn">wachten‚Ä¶</span></div>

    <div class="row">
      <button id="bYes" class="secondary" disabled>YES: ‚ûï</button>
      <button id="bNo"  class="secondary" disabled>NO: ‚ûñ</button>
      <button id="bRefresh" class="secondary">Ververs teller</button>
    </div>

    <div class="meter">
      <div class="bar"><div id="barYes" class="yes"></div></div>
      <div><b>YES <span id="yesPct">0%</span></b></div>
      <div style="margin-left:auto">NO <span id="noPct">0%</span></div>
    </div>

    <div class="row">
      <button id="bConnect">Connect Phantom</button>
      <button id="bDisconnect" class="warn" style="display:none">Disconnect</button>
    </div>

    <details style="margin-top:8px">
      <summary>Geavanceerd (RPC of Proposal overschrijven)</summary>
      <div class="row">
        <input id="rpcIn" type="text" placeholder="https://rpc.helius.xyz/?api-key=..." />
        <button id="bUseRpc" class="secondary">Gebruik RPC</button>
      </div>
      <div class="row">
        <input id="propIn" type="text" placeholder="Proposal pubkey" />
        <button id="bUseProp" class="secondary">Gebruik proposal</button>
      </div>
      <small class="muted">Tip: je kunt ook query-params gebruiken:
        <code>?proposal=&lt;PUBKEY&gt;&amp;rpc=&lt;URL&gt;</code>
      </small>
    </details>

    <pre id="log">init‚Ä¶</pre>
  </div>

  <script type="module">
    // --- imports (browser via esm) ---
    import {
      Connection, PublicKey, SystemProgram, Transaction,
      TransactionInstruction
    } from "https://esm.sh/@solana/web3.js@1.95.3";
    import * as anchor from "https://esm.sh/@coral-xyz/anchor@0.31.1";
    import { Buffer } from "https://esm.sh/buffer@6.0.3";
    window.Buffer = Buffer;

    // --- constants (jouw gegevens) ---
    const PROGRAM_ID = new PublicKey("FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY");
    // Default proposal uit jouw succesvolle creatie:
    const DEFAULT_PROPOSAL = new PublicKey("FUpzQRQfu35NEmqp9pjqnkad3R2K1p5XzM6sLDfXcizx");
    // Jouw Helius key:
    const DEFAULT_RPC = "https://rpc.helius.xyz/?api-key=3d335769-1880-4497-8fd0-ac7ed0701a7c";

    // --- UI refs ---
    const els = {
      rpcLbl:    document.getElementById("rpcLbl"),
      pid:       document.getElementById("pid"),
      prop:      document.getElementById("prop"),
      wallet:    document.getElementById("wallet"),
      question:  document.getElementById("question"),
      status:    document.getElementById("status"),
      vr:        document.getElementById("vr"),
      bYes:      document.getElementById("bYes"),
      bNo:       document.getElementById("bNo"),
      bRefresh:  document.getElementById("bRefresh"),
      bConnect:  document.getElementById("bConnect"),
      bDisconnect:document.getElementById("bDisconnect"),
      yesPct:    document.getElementById("yesPct"),
      noPct:     document.getElementById("noPct"),
      barYes:    document.getElementById("barYes"),
      rpcIn:     document.getElementById("rpcIn"),
      bUseRpc:   document.getElementById("bUseRpc"),
      propIn:    document.getElementById("propIn"),
      bUseProp:  document.getElementById("bUseProp"),
      log:       document.getElementById("log"),
    };

    const qs = new URLSearchParams(location.search);
    let RPC_URL = qs.get("rpc") || DEFAULT_RPC;
    let PROPOSAL_PK = new PublicKey(qs.get("proposal") || DEFAULT_PROPOSAL);

    els.rpcLbl.textContent = RPC_URL;
    els.pid.textContent = PROGRAM_ID.toBase58();
    els.prop.textContent = PROPOSAL_PK.toBase58();

    const connection = new Connection(RPC_URL, { commitment: "confirmed" });

    // load IDL (moet naast deze html staan als 'idl.json')
    let idl;
    try {
      idl = await (await fetch("./idl.json", { cache: "no-store" })).json();
    } catch (e) {
      log(`‚ö†Ô∏è kon idl.json niet laden: ${e}`);
    }
    const coder = idl ? new anchor.BorshAccountsCoder(idl) : null;
    const ixCoder = idl ? new anchor.BorshInstructionCoder(idl) : null;

    // logging helper
    function log(msg){ els.log.textContent += (typeof msg === "string" ? msg : JSON.stringify(msg,null,2)) + "\n"; }

    // Phantom helpers
    function getWalletAdapter(){
      const p = window.solana;
      if (!p || !p.isPhantom) throw new Error("Phantom niet gevonden");
      return p;
    }

    async function connect(){
      const p = getWalletAdapter();
      const res = await p.connect();
      els.wallet.textContent = res.publicKey.toBase58();
      els.bConnect.style.display = "none";
      els.bDisconnect.style.display = "inline-block";
      await refreshAll();
      await computeVoteReceiptPda();
      els.bYes.disabled = els.bNo.disabled = false;
    }

    async function disconnect(){
      try{ await getWalletAdapter().disconnect(); }catch{}
      els.wallet.textContent = "niet verbonden";
      els.bConnect.style.display = "inline-block";
      els.bDisconnect.style.display = "none";
      els.vr.textContent = "-";
      els.bYes.disabled = els.bNo.disabled = true;
    }

    // PDA vote_receipt = ["vote", proposal, voter]
    async function computeVoteReceiptPda(){
      const p = getWalletAdapter();
      const [pda] = PublicKey.findProgramAddressSync(
        [Buffer.from("vote"), PROPOSAL_PK.toBuffer(), p.publicKey.toBuffer()],
        PROGRAM_ID
      );
      els.vr.textContent = pda.toBase58();
      return pda;
    }

    // decode Proposal via IDL coder
    async function getProposal(){
      const ai = await connection.getAccountInfo(PROPOSAL_PK);
      if (!ai){ throw new Error("Proposal account niet gevonden"); }
      if (!coder) throw new Error("IDL coder niet beschikbaar (idl.json?)");
      const acc = coder.decode("Proposal", ai.data);
      return acc;
    }

    function pct(a,b){
      const t = Number(a)+Number(b);
      if (t===0) return { y:0, n:0 };
      const y = Math.round((Number(a)*10000)/t)/100;
      return { y, n: Math.round(10000 - y*100)/100 };
    }

    async function refreshAll(){
      try{
        els.status.textContent = "laden‚Ä¶";
        const p = await getProposal();
        els.question.textContent = p.question;
        const { y, n } = pct(p.yesVotes, p.noVotes);
        els.yesPct.textContent = y + "%";
        els.noPct.textContent  = n + "%";
        els.barYes.style.width = y + "%";

        const now = Math.floor(Date.now()/1000);
        const ended = Number(p.endsAt) <= now;
        const msg = ended ? "stemperiode is voorbij" :
          `loopt tot ${new Date(Number(p.endsAt)*1000).toLocaleString()}`;
        els.status.textContent = msg;
        els.status.className = "status " + (ended ? "err":"ok");
        els.bYes.disabled = els.bNo.disabled = ended || (els.wallet.textContent==="niet verbonden");
      }catch(e){
        els.status.textContent = "fout";
        els.status.className = "status err";
        log("init: " + (e?.message || e));
      }
    }

    async function vote(yes){
      const p = getWalletAdapter();
      const walletPk = p.publicKey;
      const voteReceipt = await computeVoteReceiptPda();

      // instr data via IDL coder (vote(bool))
      if (!ixCoder) throw new Error("IDL instruction coder ontbreekt");
      const data = ixCoder.encode("vote", { yes });

      const keys = [
        { pubkey: PROPOSAL_PK, isSigner:false, isWritable:true },
        { pubkey: walletPk,    isSigner:true,  isWritable:true },
        { pubkey: voteReceipt, isSigner:false, isWritable:true },
        { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
      ];
      const ix = new TransactionInstruction({ programId: PROGRAM_ID, keys, data });

      const { blockhash, lastValidBlockHeight } =
        await connection.getLatestBlockhash("confirmed");
      const tx = new Transaction({ feePayer: walletPk, recentBlockhash: blockhash })
        .add(ix);

      let sig;
      if (p.signAndSendTransaction){
        const res = await p.signAndSendTransaction(tx);
        sig = res.signature;
      }else{
        const signed = await p.signTransaction(tx);
        sig = await connection.sendRawTransaction(signed.serialize());
      }
      await connection.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
      log("‚úÖ vote tx: " + sig);
      await refreshAll();
    }

    // Events
    els.bConnect.onclick    = connect;
    els.bDisconnect.onclick = disconnect;
    els.bRefresh.onclick    = refreshAll;
    els.bYes.onclick        = () => vote(true);
    els.bNo.onclick         = () => vote(false);
    els.bUseRpc.onclick     = () => {
      const u = els.rpcIn.value.trim();
      if (!u) return;
      location.search = new URLSearchParams({
        proposal: PROPOSAL_PK.toBase58(),
        rpc: u
      }).toString();
    };
    els.bUseProp.onclick    = () => {
      const p = els.propIn.value.trim();
      if (!p) return;
      location.search = new URLSearchParams({
        proposal: p,
        rpc: RPC_URL
      }).toString();
    };

    // init
    await refreshAll();
    log("init: klaar");
  </script>
</body>
</html>

