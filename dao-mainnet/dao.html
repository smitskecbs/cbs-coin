<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO – Stemmen (Mainnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--muted:#66ffff;--panel:#0b0f16}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(980px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan)}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .tag{background:#031a18;border:1px solid #064e3b;color:var(--fg);padding:3px 8px;border-radius:999px;font-size:12px}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    .meter{height:10px;background:#09151a;border:1px solid #0e2b2a;border-radius:8px;overflow:hidden}
    .yes{height:100%;background:#00ffc3}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:260px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO – Stemmen op voorstel</h1>
    <div class="sub">Netwerk: <b>Mainnet</b> • RPC:
      <!-- alleen host tonen, niet de api key -->
      <a id="rpcLink" href="https://rpc.helius.xyz" target="_blank" rel="noreferrer">https://rpc.helius.xyz</a>
    </div>

    <div class="row"><b>🔥 Vraag 1 miljoen tokens verbranden ja of nee:</b> <span id="question">laden…</span></div>

    <div class="row">Wallet:&nbsp;<code id="wallet">niet verbonden</code></div>
    <div class="row">Program ID:&nbsp;<code id="programId">-</code></div>
    <div class="row">Proposal:&nbsp;<code id="proposalPk">-</code></div>
    <div class="row">Vote receipt PDA:&nbsp;<code id="receiptPk">-</code></div>
    <div class="row">Status:&nbsp;<span id="status" class="status warn">wachten…</span></div>

    <div class="row">
      <button id="btnYes">YES: +</button>
      <button id="btnNo" class="secondary">NO: −</button>
      <button id="btnRefresh" class="secondary">Ververs teller</button>
      <a id="explorerLink" class="tag" target="_blank" rel="noreferrer">Proposal in Explorer</a>
      <button id="btnAdminCreate" class="secondary" style="display:none">Maak proposal (admin)</button>
    </div>

    <div class="row" style="align-items:center;">
      <div style="flex:1 1 auto">
        <div class="meter"><div id="yesBar" class="yes" style="width:0%"></div></div>
      </div>
      <div style="min-width:140px;text-align:right">
        <span id="yesPct">YES 0%</span>&nbsp;&nbsp;<span id="noPct">NO 0%</span>
      </div>
    </div>

    <div class="row" style="gap:12px;margin-top:10px">
      <button id="btnConnect" class="secondary">Connect Phantom</button>
    </div>

    <details style="margin-top:10px">
      <summary>Geavanceerd</summary>
      <pre id="log"></pre>
    </details>
  </div>

  <!-- Buffer polyfill -->
  <script type="module">
    import { Buffer } from "https://esm.sh/buffer@6.0.3";
    // @ts-ignore
    window.Buffer = Buffer;
  </script>

  <script type="module">
    import {
      Connection, PublicKey, SystemProgram,
      Transaction, TransactionInstruction, ComputeBudgetProgram
    } from "https://esm.sh/@solana/web3.js@1.95.3";
    import { AnchorProvider, Program, BN } from "https://esm.sh/@coral-xyz/anchor@0.31.1?deps=@solana/web3.js@1.95.3";

    // ===== Inline IDL (met correcte Program ID: vswS) =====
    const IDL = {
      "version":"0.1.0","name":"cbs_dao",
      "address":"FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY",
      "metadata":{"spec":"0.1.0"},
      "instructions":[
        {"name":"create_proposal","discriminator":[132,116,68,174,216,160,198,22],
         "accounts":[
           {"name":"proposal","writable":true,"pda":{"seeds":[
             {"kind":"const","value":[112,114,111,112,111,115,97,108]},
             {"kind":"account","path":"creator"},
             {"kind":"account","path":"creator"}]}},
           {"name":"creator","writable":true,"signer":true},
           {"name":"system_program","address":"11111111111111111111111111111111"}],
         "args":[{"name":"question","type":"string"},{"name":"ends_at","type":"i64"}]},
        {"name":"vote","discriminator":[227,110,155,23,136,126,172,25],
         "accounts":[
           {"name":"proposal","writable":true},
           {"name":"voter","writable":true,"signer":true},
           {"name":"vote_receipt","writable":true,"pda":{"seeds":[
             {"kind":"const","value":[118,111,116,101]},
             {"kind":"account","path":"proposal"},
             {"kind":"account","path":"voter"}]}},
           {"name":"system_program","address":"11111111111111111111111111111111"}],
         "args":[{"name":"yes","type":"bool"}]}],
      "accounts":[
        {"name":"proposal","discriminator":[26,94,189,187,116,136,53,33],
         "type":{"kind":"struct","fields":[
           {"name":"creator","type":"pubkey"},
           {"name":"question","type":"string"},
           {"name":"yes_votes","type":"u64"},
           {"name":"no_votes","type":"u64"},
           {"name":"created_at","type":"i64"},
           {"name":"ends_at","type":"i64"}]}},
        {"name":"voteReceipt","discriminator":[104,20,204,252,45,84,37,195],
         "type":{"kind":"struct","fields":[
           {"name":"proposal","type":"pubkey"},
           {"name":"voter","type":"pubkey"},
           {"name":"has_voted","type":"bool"}]}}],
      "errors":[
        {"code":6000,"name":"QuestionTooLong","msg":"Vraag is te lang"},
        {"code":6001,"name":"AlreadyEnded","msg":"Stemperiode is voorbij"},
        {"code":6002,"name":"AlreadyVoted","msg":"Je hebt al gestemd"},
        {"code":6003,"name":"Overflow","msg":"Overflow"}]
    };

    // ===== RPC via jouw Vercel proxy (key blijft server-side) =====
    const RPC_URL = "https://cbs-coin.vercel.app/api/rpc";

    // ===== Ketting / DOM =====
    const connection = new Connection(RPC_URL,"confirmed");
    const PROGRAM_ID = new PublicKey(IDL.address);
    const CREATOR_PUBKEY = new PublicKey("76SjWWFoJ1NQEWXVWbbqYR8112FAEyWGQT1PS1DeLmEg");

    const $=(s)=>document.querySelector(s);
    const logEl=$("#log"), walletEl=$("#wallet"), programIdEl=$("#programId");
    const proposalPkEl=$("#proposalPk"), receiptPkEl=$("#receiptPk");
    const statusEl=$("#status"), questionEl=$("#question");
    const yesBarEl=$("#yesBar"), yesPctEl=$("#yesPct"), noPctEl=$("#noPct");
    const explorerLink=$("#explorerLink"), btnAdminCreate=$("#btnAdminCreate");
    const enc=new TextEncoder();
    function log(m){ logEl.textContent+=(typeof m==="string"?m:JSON.stringify(m,null,2))+"\n"; logEl.scrollTop=logEl.scrollHeight; }
    function setStatus(t,cls=""){ statusEl.className="status "+cls; statusEl.textContent=t; }

    programIdEl.textContent = PROGRAM_ID.toBase58();

    function deriveProposalPDA(creator){
      const [pda]=PublicKey.findProgramAddressSync(
        [enc.encode("proposal"), creator.toBuffer(), creator.toBuffer()],
        PROGRAM_ID
      ); return pda;
    }
    const PROPOSAL_PUBKEY = deriveProposalPDA(CREATOR_PUBKEY);
    proposalPkEl.textContent = PROPOSAL_PUBKEY.toBase58();
    explorerLink.href = "https://solscan.io/account/"+PROPOSAL_PUBKEY.toBase58();

    function voteReceiptPDA(proposal,voter){
      const [pda]=PublicKey.findProgramAddressSync([enc.encode("vote"),proposal.toBuffer(),voter.toBuffer()], PROGRAM_ID);
      return pda;
    }

    function getPhantom(){ const w=window; return w?.solana?.isPhantom?w.solana:(w?.phantom?.solana?.isPhantom?w.phantom.solana:null); }
    function anchorWalletFromPhantom(w){ return { publicKey:w.publicKey, signTransaction:(tx)=>w.signTransaction(tx), signAllTransactions:(txs)=>w.signAllTransactions(txs) }; }

    let wallet=null, program=null;

    async function buildProgram(readOnly=false){
      try{
        const w=readOnly?{
          publicKey:new PublicKey("11111111111111111111111111111111"),
          signTransaction:async(tx)=>tx, signAllTransactions:async(txs)=>txs
        }:(wallet?anchorWalletFromPhantom(wallet):null);
        if(!w) return null;
        const prov=new AnchorProvider(connection,w,{preflightCommitment:"confirmed"});
        program=new Program(IDL, PROGRAM_ID, prov);
        return program;
      }catch(e){ log("Program ctor error: "+(e?.message||e)); return null; }
    }

    // Stabiel verzenden via Phantom
    async function sendWithPhantom(tx){
      const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();
      tx.recentBlockhash = blockhash;
      tx.feePayer = wallet.publicKey;
      const res = await wallet.signAndSendTransaction(tx);
      const sig = res.signature ?? res;
      await connection.confirmTransaction({ signature: sig, blockhash, lastValidBlockHeight }, "confirmed");
      return sig;
    }

    async function checkProposalAccount(){
      const info = await connection.getAccountInfo(PROPOSAL_PUBKEY, "confirmed");
      if(!info){ log("❌ Proposal account niet gevonden op RPC."); return { ok:false, why:"not_found" }; }
      const ownerOK = PROGRAM_ID.equals(info.owner);
      const discPre=new TextEncoder().encode("account:proposal"); // lowercase!
      const discHash=new Uint8Array(await crypto.subtle.digest("SHA-256",discPre)).slice(0,8);
      const discOK = info.data?.length>=8 && discHash.every((b,i)=>info.data[i]===b);
      log({proposal_exists:true, owner:info.owner.toBase58(), expected:PROGRAM_ID.toBase58(), owner_match:ownerOK, disc_match:discOK, data_len:info.data?.length ?? 0});
      if(!ownerOK) return { ok:false, why:"owner_mismatch" };
      if(!discOK)  return { ok:false, why:"disc_mismatch" };
      return { ok:true };
    }

    // Connect
    $("#btnConnect").addEventListener("click", async ()=>{
      const prov=getPhantom();
      if(!prov){ alert("Phantom wallet niet gevonden."); return; }
      try{ await prov.connect({onlyIfTrusted:false}); }catch(e){ setStatus("Connect geannuleerd of mislukt.","err"); log(e); return; }
      wallet=prov;
      walletEl.textContent=wallet.publicKey.toString();
      const receiptPda = voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey);
      $("#receiptPk").textContent = receiptPda.toBase58();
      setStatus("Verbonden.","ok");
      btnAdminCreate.style.display = wallet.publicKey.equals(CREATOR_PUBKEY) ? "inline-block" : "none";
      await refreshTeller();
    });

    // Teller
    async function fetchProposal(){
      const p = await buildProgram(true);
      if(!p || !p.account?.proposal) return null;
      try{ return await p.account.proposal.fetch(PROPOSAL_PUBKEY); }
      catch(e){ log("fetchProposal error: "+(e?.message||e)); return null; }
    }

    async function refreshTeller(){
      setStatus("Verversen…");
      const sanity = await checkProposalAccount();
      if(!sanity.ok){
        let msg = "Proposal onjuist: ";
        if(sanity.why==="not_found") msg += "account bestaat niet op deze RPC/cluster.";
        if(sanity.why==="owner_mismatch") msg += "owner ≠ PROGRAM_ID.";
        if(sanity.why==="disc_mismatch") msg += "discriminator klopt niet.";
        setStatus(msg, "err");
        questionEl.textContent = "—";
        yesBarEl.style.width = "0%";
        yesPctEl.textContent = "YES 0%";
        noPctEl.textContent  = "NO 0%";
        return;
      }
      const prop = await fetchProposal();
      if(!prop){
        questionEl.textContent = "niet beschikbaar (IDL probleem)";
        yesBarEl.style.width = "0%";
        yesPctEl.textContent = "YES 0%";
        noPctEl.textContent  = "NO 0%";
        setStatus("Klaar (teller niet beschikbaar).","warn");
        return;
      }
      try{ questionEl.textContent = prop.question || "—"; }catch{}
      const yes = Number(new BN(prop.yesVotes ?? prop.yes_votes ?? 0));
      const no  = Number(new BN(prop.noVotes  ?? prop.no_votes  ?? 0));
      const tot = Math.max(yes+no,1);
      const pctYes = Math.round((yes/tot)*100);
      yesBarEl.style.width = pctYes+"%";
      yesPctEl.textContent = `YES ${pctYes}%`;
      noPctEl.textContent  = `NO ${100-pctYes}%`;
      setStatus("Klaar.","ok");
    }

    // Stemmen
    $("#btnYes").addEventListener("click", ()=>vote(true));
    $("#btnNo").addEventListener("click",  ()=>vote(false));
    $("#btnRefresh").addEventListener("click", refreshTeller);

    async function vote(yesFlag){
      if(!wallet?.publicKey){ alert("Verbind eerst je Phantom wallet."); return; }

      // Probeer Anchor
      const p = await buildProgram(false);
      if(p){
        try{
          setStatus("Stem versturen…");
          const sig = await p.methods
            .vote(yesFlag)
            .accounts({
              proposal: PROPOSAL_PUBKEY,
              voter: wallet.publicKey,
              voteReceipt: voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey),
              systemProgram: SystemProgram.programId,
            })
            .rpc();
          log("✅ Tx (anchor): "+sig);
          setStatus("Stem geregistreerd.","ok");
          await refreshTeller();
          return;
        }catch(e){ log("Anchor vote mislukte, probeer raw… ("+(e?.message||e)+")"); }
      }

      // Raw fallback
      try{
        const disc = new Uint8Array(await crypto.subtle.digest("SHA-256", new TextEncoder().encode("global:vote"))).slice(0,8);
        const data = new Uint8Array(9); data.set(disc,0); data[8] = yesFlag ? 1 : 0;
        const ix = new TransactionInstruction({
          programId: PROGRAM_ID,
          keys: [
            { pubkey: PROPOSAL_PUBKEY, isSigner:false, isWritable:true },
            { pubkey: wallet.publicKey, isSigner:true, isWritable:true },
            { pubkey: voteReceiptPDA(PROPOSAL_PUBKEY, wallet.publicKey), isSigner:false, isWritable:true },
            { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
          ],
          data
        });
        const tx = new Transaction()
          .add(ComputeBudgetProgram.setComputeUnitLimit({ units: 200000 }))
          .add(ComputeBudgetProgram.setComputeUnitPrice({ microLamports: 1000 }))
          .add(ix);
        const sig = await sendWithPhantom(tx);
        log("✅ Tx (raw): "+sig);
        setStatus("Stem geregistreerd (raw).","ok");
        await refreshTeller();
      }catch(e){
        const msg=(e?.message||e).toString();
        log("❌ vote (raw) error: "+msg);
        if(msg.includes("AlreadyVoted")) setStatus("Je hebt al gestemd met deze wallet.","warn");
        else if(msg.includes("AlreadyEnded")) setStatus("De stemperiode is voorbij.","warn");
        else setStatus("Stemmen mislukt.","err");
      }
    }

    // Admin: proposal aanmaken (Anchor → raw)
    $("#btnAdminCreate").addEventListener("click", adminCreateProposal);

    async function adminCreateProposal(){
      if(!wallet?.publicKey || !wallet.publicKey.equals(CREATOR_PUBKEY)){
        alert("Verbind met de creator-wallet om een proposal aan te maken.");
        return;
      }
      const p = await buildProgram(false);
      const ENDS_AT = Math.floor(Date.now()/1000) + 7*24*3600;
      const QUESTION = "Vraag 1 miljoen tokens verbranden ja of nee";

      // Anchor
      if(p){
        try{
          setStatus("Proposal aanmaken…");
          const sig = await p.methods
            .createProposal(QUESTION, new BN(ENDS_AT))
            .accounts({
              proposal: PROPOSAL_PUBKEY,
              creator: wallet.publicKey,
              systemProgram: SystemProgram.programId
            })
            .rpc();
          log("✅ create_proposal (anchor): "+sig);
          setStatus("Proposal aangemaakt.","ok");
          await refreshTeller();
          return;
        }catch(e){ log("create_proposal via Anchor faalde: "+(e?.message||e)); }
      }

      // Raw
      try{
        const disc=Uint8Array.from([132,116,68,174,216,160,198,22]);
        const qBytes=new TextEncoder().encode(QUESTION);
        const qLen=new Uint8Array(4); new DataView(qLen.buffer).setUint32(0,qBytes.length,true);
        const ends=new Uint8Array(8); new DataView(ends.buffer).setBigInt64(0, BigInt(ENDS_AT), true);

        const data=new Uint8Array(disc.length+qLen.length+qBytes.length+ends.length);
        data.set(disc,0); data.set(qLen,disc.length); data.set(qBytes,disc.length+qLen.length); data.set(ends,disc.length+qLen.length+qBytes.length);

        const ix=new TransactionInstruction({
          programId: PROGRAM_ID,
          keys: [
            { pubkey: PROPOSAL_PUBKEY, isSigner:false, isWritable:true },
            { pubkey: wallet.publicKey, isSigner:true, isWritable:true },
            { pubkey: SystemProgram.programId, isSigner:false, isWritable:false },
          ],
          data
        });
        const tx=new Transaction()
          .add(ComputeBudgetProgram.setComputeUnitLimit({ units: 200000 }))
          .add(ComputeBudgetProgram.setComputeUnitPrice({ microLamports: 1000 }))
          .add(ix);

        const sig = await sendWithPhantom(tx);
        log("✅ create_proposal (raw): "+sig);
        setStatus("Proposal aangemaakt.","ok");
        await refreshTeller();
      }catch(e){
        log("❌ create_proposal (raw) error: "+(e?.message||e));
        setStatus("Aanmaken mislukt.","err");
      }
    }

    // Boot
    (async()=>{
      setStatus("Start…");
      await refreshTeller();
      setStatus("Klaar.","ok");
      log("Init klaar. Program: "+PROGRAM_ID.toBase58()+", Proposal: "+PROPOSAL_PUBKEY.toBase58());
    })();
  </script>
</body>
</html>

