<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO ‚Äì Stemmen (Mainnet)</title>
  <style>
    :root{--bg:#000;--fg:#00ffcc;--cyan:#00ffff;--green:#39ff14;--muted:#66ffff;--panel:#0b0f16;--accent:#16a34a}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--fg);font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(960px,100%);background:#070707;border:1px solid #111;border-radius:16px;box-shadow:0 10px 40px rgba(0,255,204,.08);padding:22px}
    h1{margin:0 0 6px;color:var(--cyan)}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px}
    .q{display:flex;gap:10px;align-items:center;font-size:18px;margin:10px 0 14px;color:var(--green)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--fg);color:#001815}
    button.secondary{background:#001a17;color:var(--fg);border:1px solid #064e3b}
    button:disabled{opacity:.55;cursor:not-allowed}
    code{background:#061016;color:var(--fg);padding:2px 6px;border-radius:6px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;align-items:center}
    .status.ok{color:#5aff5a}.status.warn{color:#ffd166}.status.err{color:#ff6b6b}
    pre{background:var(--panel);color:#b7fff1;border-radius:12px;padding:12px;max-height:320px;overflow:auto;font-size:12px;margin:12px 0 0}
    a{color:var(--fg);text-decoration:none}
    .meter{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .bar{flex:1;height:10px;border-radius:8px;background:#062227;position:relative;overflow:hidden}
    .fill{position:absolute;left:0;top:0;bottom:0;background:var(--fg);width:0%}
    .chip{background:#062227;padding:5px 8px;border-radius:8px}
    .note{font-size:12px;color:#8ee}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO ‚Äì Stemmen op voorstel</h1>
    <div class="sub">
      Netwerk: <b>Mainnet</b> ‚Ä¢ RPC: 
      <a id="rpcLink" href="#" target="_blank" rel="noreferrer"></a>
    </div>

    <div class="q">üî• <b>Vraag:</b>&nbsp;<span id="vraag">laden‚Ä¶</span> üî•</div>

    <div class="kv">Wallet: <code id="wallet">niet verbonden</code></div>
    <div class="kv">Program ID: <code id="programId"></code></div>
    <div class="kv">Proposal: <code id="proposalPk"></code></div>
    <div class="kv">Vote receipt PDA: <code id="receiptPk">-</code></div>
    <div class="kv">Status: <span id="status" class="status warn">wachten‚Ä¶</span></div>

    <div class="row">
      <button id="btnYes" class="secondary">YES: ‚ûï</button>
      <button id="btnNo" class="secondary">NO: ‚ûñ</button>
      <button id="btnRefresh" class="secondary">Ververs teller</button>
    </div>

    <div class="meter">
      <div class="bar"><div class="fill" id="barFill"></div></div>
      <div><span id="pctYes">YES 0%</span>&nbsp;&nbsp;<span id="pctNo">NO 0%</span></div>
    </div>

    <div class="row">
      <button id="btnConnect">Connect Phantom</button>
      <button id="btnExplorer" class="secondary">Proposal in Explorer</button>
    </div>

    <details style="margin-top:8px">
      <summary>Geavanceerd</summary>
      <div class="note">Als IDL of coder niet laadt, wordt dat hieronder gelogd. Zolang de IDL in <code>idl.json</code> staat, kun je stemmen.</div>
      <pre id="log"></pre>
    </details>
  </div>

  <script type="module">
    // ---- Imports via esm.sh (browser-friendly) ----
    import {
      Connection, PublicKey, SystemProgram, Transaction, TransactionInstruction
    } from "https://esm.sh/@solana/web3.js@1.95.3";
    import {
      Program, AnchorProvider, BN
    } from "https://esm.sh/@coral-xyz/anchor@0.29.0";

    // ---- Config (MAINNET) ----
    const RPC_URL = "https://rpc.helius.xyz/?api-key=3d335769-1880-4497-8fd0-ac7ed0701a7c";
    const PROGRAM_ID = new PublicKey("FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY");
    // Default bestaand voorstel (jij hebt dit op mainnet aangemaakt):
    const DEFAULT_PROPOSAL = new PublicKey("FUpzQRQfu35NEmqp9Pjqnkad3R2K1p5XzM6sLDFXcizx");

    // PDA seeds
    const SEED_VOTE = "vote";
    // (Voor de proposal-pda gebruiken we hier het vaste adres DEFAULT_PROPOSAL.)
    // Merk op: je on-chain create_proposal had seeds ["proposal", creator, creator]

    // ---- UI refs ----
    const el = (id) => document.getElementById(id);
    const logEl = el("log");
    const rpcLink = el("rpcLink");
    const walletEl = el("wallet");
    const programIdEl = el("programId");
    const proposalPkEl = el("proposalPk");
    const receiptPkEl = el("receiptPk");
    const statusEl = el("status");
    const barFill = el("barFill");
    const pctYesEl = el("pctYes");
    const pctNoEl = el("pctNo");
    const vraagEl = el("vraag");

    const btnConnect = el("btnConnect");
    const btnYes = el("btnYes");
    const btnNo = el("btnNo");
    const btnRefresh = el("btnRefresh");
    const btnExplorer = el("btnExplorer");

    // ---- State ----
    let connection;
    let idl = null;
    let program = null;
    let provider = null;
    let wallet = null;
    let currentProposal = DEFAULT_PROPOSAL;
    let myReceiptPda = null;

    // ---- Helpers ----
    const log = (m) => { logEl.textContent += (typeof m === 'string' ? m : JSON.stringify(m,null,2)) + "\n"; };
    const short = (pk) => pk.toString().slice(0,6) + "‚Ä¶" + pk.toString().slice(-6);

    function getAnchorWalletAdapter(solWallet) {
      return {
        publicKey: solWallet.publicKey,
        signTransaction: (tx) => solWallet.signTransaction(tx),
        signAllTransactions: (txs) => solWallet.signAllTransactions(txs)
      };
    }

    function voteReceiptPDA(proposalPk, voterPk) {
      return PublicKey.findProgramAddressSync(
        [Buffer.from(SEED_VOTE), proposalPk.toBuffer(), voterPk.toBuffer()],
        PROGRAM_ID
      )[0];
    }

    function setStatus(text, cls="warn") {
      statusEl.textContent = text;
      statusEl.className = "status " + cls;
    }

    function setProgress(yes, no) {
      const y = Number(yes) || 0;
      const n = Number(no) || 0;
      const tot = y + n;
      const p = tot === 0 ? 0 : Math.round((y * 100) / tot);
      barFill.style.width = p + "%";
      pctYesEl.textContent = `YES ${p}%`;
      pctNoEl.textContent = `NO ${100 - p}%`;
    }

    async function loadIDL() {
      try {
        const res = await fetch("./idl.json", { cache: "no-store" });
        const txt = await res.text();
        idl = JSON.parse(txt);
        log("IDL geladen.");
      } catch (e) {
        log(`‚ö†Ô∏è kon idl.json niet laden: ${e}`);
      }
    }

    async function init() {
      rpcLink.textContent = RPC_URL;
      rpcLink.href = RPC_URL;
      programIdEl.textContent = PROGRAM_ID.toString();
      proposalPkEl.textContent = DEFAULT_PROPOSAL.toString();
      vraagEl.textContent = "1 Miljoen CBS burnen ‚Äî YES of NO?";

      connection = new Connection(RPC_URL, "confirmed");
      await loadIDL();

      if (idl) {
        try {
          // Provider zonder wallet; wordt na connect vervangen
          const dummyWallet = { publicKey: null, signTransaction: async x=>x, signAllTransactions: async xs=>xs };
          provider = new AnchorProvider(connection, dummyWallet, { preflightCommitment: "confirmed" });
          program = new Program(idl, PROGRAM_ID, provider);
        } catch (e) {
          log("‚ö†Ô∏è IDL coder niet beschikbaar (anchor in browser): " + e);
        }
      }

      // eerste teller
      await refreshTeller();
    }

    async function connectPhantom() {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          alert("Phantom wallet niet gevonden.");
          return;
        }
        wallet = window.solana;
        await wallet.connect();

        walletEl.textContent = wallet.publicKey.toString();
        setStatus("Verbonden.", "ok");

        // provider opnieuw met echte wallet
        const aWallet = getAnchorWalletAdapter(wallet);
        provider = new AnchorProvider(connection, aWallet, { preflightCommitment: "confirmed" });
        if (idl) program = new Program(idl, PROGRAM_ID, provider);

        // afleiden vote-receipt pda
        myReceiptPda = voteReceiptPDA(currentProposal, wallet.publicKey);
        receiptPkEl.textContent = myReceiptPda.toString();

        await refreshTeller();
      } catch (e) {
        log("connect error: " + e);
        setStatus("Fout bij verbinden.", "err");
      }
    }

    async function fetchProposalAccount() {
      if (!program) throw new Error("Program/IDL niet klaar.");
      try {
        return await program.account.proposal.fetch(currentProposal);
      } catch (e) {
        // account bestaat mogelijk niet
        return null;
      }
    }

    async function fetchVoteReceipt() {
      if (!program || !wallet?.publicKey) return null;
      try {
        return await program.account.voteReceipt.fetch(myReceiptPda);
      } catch (e) {
        return null;
      }
    }

    async function refreshTeller() {
      try {
        setStatus("Ophalen teller‚Ä¶", "warn");
        const acc = await fetchProposalAccount();
        if (!acc) {
          setStatus("Proposal account niet gevonden.", "err");
          setProgress(0,0);
          return;
        }
        const yes = new BN(acc.yesVotes).toNumber();
        const no  = new BN(acc.noVotes).toNumber();
        setProgress(yes, no);

        // check of ik al gestemd heb
        if (wallet?.publicKey) {
          const r = await fetchVoteReceipt();
          if (r?.hasVoted) {
            setStatus("Je hebt al gestemd met deze wallet.", "ok");
          } else {
            setStatus("Nog niet gestemd met deze wallet.", "warn");
          }
        } else {
          setStatus("Niet verbonden.", "warn");
        }
      } catch (e) {
        log("refresh error: " + e);
        setStatus("Fout bij lezen teller.", "err");
      }
    }

    async function sendVote(yes) {
      try {
        if (!wallet?.publicKey) {
          alert("Eerst Phantom verbinden.");
          return;
        }
        if (!program) throw new Error("Program/IDL niet klaar.");

        const voter = wallet.publicKey;
        const voteReceipt = voteReceiptPDA(currentProposal, voter);

        const txSig = await program.methods
          .vote(yes)
          .accounts({
            proposal: currentProposal,
            voter,
            voteReceipt,
            systemProgram: SystemProgram.programId
          })
          .rpc();

        setStatus("Stem verzonden.", "ok");
        log("tx: " + txSig);
        await refreshTeller();
        window.open(`https://explorer.solana.com/tx/${txSig}?cluster=mainnet`, "_blank");
      } catch (e) {
        log("vote error: " + (e?.message || e));
        setStatus("Stemmen faalde.", "err");
        alert("Stemmen faalde. Zie log onderaan.");
      }
    }

    // ---- Events ----
    btnConnect.onclick = connectPhantom;
    btnRefresh.onclick = refreshTeller;
    btnYes.onclick = () => sendVote(true);
    btnNo.onclick = () => sendVote(false);
    btnExplorer.onclick = () => window.open(
      `https://explorer.solana.com/address/${currentProposal.toString()}?cluster=mainnet`,
      "_blank"
    );

    // ---- go ----
    init();
  </script>
</body>
</html>
