<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBS DAO – Mainnet</title>

  <!-- Import map voor bn.js -->
  <script type="importmap">
  {
    "imports": {
      "bn.js": "https://esm.sh/bn.js@5.2.1"
    }
  }
  </script>

  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#eaeaea; margin:0; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    .card { background:#13131a; border:1px solid #23232b; border-radius:16px; padding:20px; margin-bottom:16px; }
    h1, h2 { margin: 0 0 12px; }
    button { cursor:pointer; border:none; padding:12px 16px; border-radius:12px; background:#1f2430; color:#eaeaea; }
    button:hover { filter: brightness(1.1); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted { color:#a6a6b3; font-size:14px; }
    code { background:#1a1a22; padding:2px 6px; border-radius:6px; }
    input[type="text"], input[type="number"], input[type="datetime-local"]{
      width:100%; padding:10px; border-radius:10px; border:1px solid #2a2a33; background:#0f0f14; color:#eaeaea;
    }
    .ok { color:#79e07f; } .warn { color:#ffd75e; } .err { color:#ff7575; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3 { display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid, .grid3{ grid-template-columns: 1fr; } }
    a { color: #8ab4ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CBS DAO – Mainnet</h1>

    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div class="row">
          <button id="btnConnect">Connect Phantom</button>
          <button id="btnDisconnect">Disconnect</button>
        </div>
        <div>
          <span class="muted">Queryparams: </span>
          <code>?program=...&proposal=...&rpc=...</code>
        </div>
      </div>
      <p id="wallet" class="muted">Wallet: <em>niet verbonden</em></p>
      <p id="network" class="muted">RPC: <code>(niet ingesteld)</code></p>
      <p id="programInfo" class="muted">Program: <code>—</code></p>
      <p id="proposalInfo" class="muted">Proposal: <code>—</code></p>
    </div>

    <div class="card">
      <h2>Status</h2>
      <div id="status">Pagina geladen. Verbind je wallet.</div>
    </div>

    <div class="card">
      <h2>Proposal aanmaken</h2>
      <div class="grid3">
        <div>
          <label class="muted">Vraag (question)</label>
          <input id="inpQuestion" type="text" placeholder="Bijv. 'Steun je CBS DAO?'" />
        </div>
        <div>
          <label class="muted">Duur (minuten)</label>
          <input id="inpMinutes" type="number" min="1" value="60" />
        </div>
        <div>
          <label class="muted">of Eindtijd</label>
          <input id="inpEndsAtDT" type="datetime-local" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnCreate">Create Proposal</button>
        <button id="btnSimCreate">Simulate Create</button>
      </div>
    </div>

    <div class="card">
      <h2>Acties op proposal</h2>
      <div class="row">
        <button id="btnFetch">Fetch Proposal</button>
        <button id="btnVoteYes">Vote YES</button>
        <button id="btnVoteNo">Vote NO</button>
        <button id="btnSimYes">Sim YES</button>
        <button id="btnSimNo">Sim NO</button>
      </div>
      <p id="result" class="muted">Resultaat: —</p>
    </div>

    <div class="card">
      <h2>Instellingen</h2>
      <div class="grid">
        <div>
          <label class="muted">Program ID</label>
          <input id="inpProgram" type="text" placeholder="Program ID (Pubkey)" />
        </div>
        <div>
          <label class="muted">Proposal Pubkey</label>
          <input id="inpProposal" type="text" placeholder="Proposal account pubkey" />
        </div>
      </div>
      <div style="margin-top:12px">
        <label class="muted">RPC endpoint</label>
        <input id="inpRpc" type="text" placeholder="https://mainnet.helius-rpc.com/?api-key=YOUR_KEY_HERE" />
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnApply">Apply & re-init</button>
      </div>
    </div>

    <div class="card">
      <h2>Laatste fetch</h2>
      <pre id="lastFetch" class="muted" style="white-space:pre-wrap;word-break:break-word;">—</pre>
    </div>
  </div>

  <script type="module">
    import { Connection, PublicKey, SystemProgram } from "https://esm.sh/@solana/web3.js@1.95.3?bundle&target=es2020";
    import * as anchor from "https://esm.sh/@coral-xyz/anchor@0.29.0?bundle&target=es2020";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const walletEl = $("wallet");
    const networkEl = $("network");
    const programInfoEl = $("programInfo");
    const proposalInfoEl = $("proposalInfo");
    const resultEl = $("result");
    const lastFetchEl = $("lastFetch");

    const inpProgram = $("inpProgram");
    const inpProposal = $("inpProposal");
    const inpRpc = $("inpRpc");
    const inpQuestion = $("inpQuestion");
    const inpMinutes = $("inpMinutes");
    const inpEndsAtDT = $("inpEndsAtDT");

    function setStatus(msg, cls = "") {
      statusEl.innerHTML = cls ? `<span class="${cls}">${msg}</span>` : msg;
    }
    function setWallet(pk) {
      walletEl.innerHTML = pk ? `Wallet: <code>${pk}</code>` : "Wallet: <em>niet verbonden</em>";
    }

    const enc = (s) => new TextEncoder().encode(s);
    const qs = new URLSearchParams(location.search);
    const DEFAULT_RPC = "https://api.mainnet-beta.solana.com"; 
    let PROGRAM_ID = (qs.get("program") || "FZGYyZ9hwUBriGpCH65vswS2VDoCyoC92rPoBPeBsuUY").trim();
    let PROPOSAL_PUBKEY = (qs.get("proposal") || "").trim();
    let RPC_URL = (qs.get("rpc") || DEFAULT_RPC).trim();

    inpProgram.value = PROGRAM_ID;
    inpProposal.value = PROPOSAL_PUBKEY;
    inpRpc.value = RPC_URL;
    programInfoEl.innerHTML = "Program: <code>" + (PROGRAM_ID || "—") + "</code>";
    proposalInfoEl.innerHTML = "Proposal: <code>" + (PROPOSAL_PUBKEY || "—") + "</code>";
    networkEl.innerHTML = "RPC: <code>" + RPC_URL + "</code>";

    function getPhantomProvider() {
      if (window?.solana?.isPhantom) return window.solana;
      if (window?.phantom?.solana?.isPhantom) return window.phantom.solana;
      return null;
    }

    let connection = null;
    let wallet = null;
    let provider = null;
    let program = null;
    let idl = null;

    async function initAnchor() {
      if (!wallet?.publicKey) throw new Error("Wallet niet verbonden.");
      connection = new Connection(RPC_URL, "confirmed");
      provider = new anchor.AnchorProvider(connection, wallet, { commitment: "confirmed" });
      anchor.setProvider(provider);

      const res = await fetch("./idl.json");
      if (!res.ok) throw new Error("idl.json niet gevonden (404).");
      idl = await res.json();

      if (!PROGRAM_ID) throw new Error("Geen Program ID opgegeven.");
      const programId = new PublicKey(PROGRAM_ID);
      program = new anchor.Program(idl, programId, provider);

      setStatus("Anchor klaar.", "ok");
    }

    function pdaProposal(creatorPk) {
      return PublicKey.findProgramAddressSync(
        [enc("proposal"), creatorPk.toBytes(), creatorPk.toBytes()],
        new PublicKey(PROGRAM_ID)
      )[0];
    }
    function pdaVoteReceipt(proposalPk, voterPk) {
      return PublicKey.findProgramAddressSync(
        [enc("vote"), proposalPk.toBytes(), voterPk.toBytes()],
        new PublicKey(PROGRAM_ID)
      )[0];
    }

    $("btnConnect").onclick = async () => {
      try {
        const phantom = getPhantomProvider();
        if (!phantom) {
          setStatus("Phantom niet gevonden.", "err");
          alert("Installeer Phantom: https://phantom.app/");
          return;
        }
        const resp = await phantom.connect({ onlyIfTrusted: false });
        const pubkey = resp?.publicKey?.toBase58?.() || phantom.publicKey?.toBase58?.();
        setWallet(pubkey);
        wallet = {
          publicKey: phantom.publicKey,
          signTransaction: phantom.signTransaction?.bind(phantom),
          signAllTransactions: phantom.signAllTransactions?.bind(phantom),
          signMessage: phantom.signMessage?.bind(phantom),
        };
        await initAnchor();
        setStatus("Verbonden en klaar.", "ok");
      } catch (e) {
        console.error(e);
        setStatus("Connect mislukt: " + e.message, "err");
      }
    };

    $("btnDisconnect").onclick = async () => {
      try { await getPhantomProvider()?.disconnect?.(); } catch {}
      wallet = null; program = null; provider = null;
      setWallet(null);
      setStatus("Losgekoppeld.");
    };

    $("btnApply").onclick = async () => {
      PROGRAM_ID = inpProgram.value.trim();
      PROPOSAL_PUBKEY = inpProposal.value.trim();
      RPC_URL = inpRpc.value.trim() || DEFAULT_RPC;
      networkEl.innerHTML = "RPC: <code>" + RPC_URL + "</code>";
      programInfoEl.innerHTML = "Program: <code>" + (PROGRAM_ID || "—") + "</code>";
      proposalInfoEl.innerHTML = "Proposal: <code>" + (PROPOSAL_PUBKEY || "—") + "</code>";
      if (!wallet) { setStatus("Verbind eerst je wallet.", "warn"); return; }
      await initAnchor();
    };

    $("btnCreate").onclick = async () => {
      try {
        if (!program) throw new Error("Program niet geïnitialiseerd.");
        const creator = wallet.publicKey;
        const proposalPda = pdaProposal(creator);

        let endsAt = inpEndsAtDT.value
          ? Math.floor(new Date(inpEndsAtDT.value).getTime() / 1000)
          : Math.floor(Date.now()/1000) + (parseInt(inpMinutes.value) || 60) * 60;

        const question = inpQuestion.value.trim();
        if (!question) throw new Error("Vraag invullen.");
        const txSig = await program.methods.create_proposal(question, endsAt)
          .accounts({ proposal: proposalPda, creator, systemProgram: SystemProgram.programId })
          .rpc();

        PROPOSAL_PUBKEY = proposalPda.toBase58();
        inpProposal.value = PROPOSAL_PUBKEY;
        proposalInfoEl.innerHTML = "Proposal: <code>" + PROPOSAL_PUBKEY + "</code>";
        resultEl.innerHTML = `<span class="ok">✅ Proposal aangemaakt: ${PROPOSAL_PUBKEY}<br/>TX: ${txSig}</span>`;
      } catch (e) {
        resultEl.innerHTML = `<span class="err">❌ ${e.message}</span>`;
      }
    };

    $("btnFetch").onclick = async () => {
      try {
        if (!program) throw new Error("Program niet geïnitialiseerd.");
        if (!PROPOSAL_PUBKEY) throw new Error("Geen proposal pubkey ingevuld.");
        const data = await program.account.proposal.fetch(new PublicKey(PROPOSAL_PUBKEY));
        lastFetchEl.textContent = JSON.stringify({
          creator: data.creator.toBase58(),
          question: data.question,
          yes_votes: data.yesVotes.toString(),
          no_votes: data.noVotes.toString(),
          created_at: Number(data.createdAt),
          ends_at: Number(data.endsAt)
        }, null, 2);
        resultEl.innerHTML = `<span class="ok">✅ Proposal gelezen.</span>`;
      } catch (e) {
        resultEl.innerHTML = `<span class="err">${e.message}</span>`;
      }
    };

    async function vote(yes) {
      try {
        if (!program) throw new Error("Program niet geïnitialiseerd.");
        if (!PROPOSAL_PUBKEY) throw new Error("Geen proposal pubkey ingesteld.");
        const proposalPk = new PublicKey(PROPOSAL_PUBKEY);
        const voter = wallet.publicKey;
        const voteReceiptPda = pdaVoteReceipt(proposalPk, voter);
        const txSig = await program.methods.vote(yes)
          .accounts({
            proposal: proposalPk,
            voter,
            voteReceipt: voteReceiptPda,
            systemProgram: SystemProgram.programId
          })
          .rpc();
        resultEl.innerHTML = `<span class="ok">✅ Vote TX: ${txSig}</span>`;
      } catch (e) {
        resultEl.innerHTML = `<span class="err">❌ ${e.message}</span>`;
      }
    }
    $("btnVoteYes").onclick = () => vote(true);
    $("btnVoteNo").onclick = () => vote(false);

    // ---------- Simulaties (gratis) ----------
    $("btnSimCreate").onclick = async () => {
      try {
        if (!program) throw new Error("Program niet geïnitialiseerd.");
        const creator = wallet.publicKey;
        const proposalPda = pdaProposal(creator);

        let endsAt = inpEndsAtDT.value
          ? Math.floor(new Date(inpEndsAtDT.value).getTime() / 1000)
          : Math.floor(Date.now()/1000) + (parseInt(inpMinutes.value) || 60) * 60;

        const question = inpQuestion.value.trim();
        if (!question) throw new Error("Vul een vraag in.");

        const sim = await program.methods.create_proposal(question, endsAt)
          .accounts({ proposal: proposalPda, creator, systemProgram: SystemProgram.programId })
          .simulate();

        resultEl.innerHTML = `<span class="ok">✅ Simulate(create) OK</span>`;
        lastFetchEl.textContent = (sim?.logs || []).join("\n") || "—";
      } catch (e) {
        resultEl.innerHTML = `<span class="err">❌ Simulate(create) fail: ${e.message}</span>`;
      }
    };

    async function simulateVote(yes) {
      try {
        if (!program) throw new Error("Program niet geïnitialiseerd.");
        if (!PROPOSAL_PUBKEY) throw new Error("Geen proposal pubkey ingesteld.");
        const proposalPk = new PublicKey(PROPOSAL_PUBKEY);
        const voter = wallet.publicKey;
        const voteReceiptPda = pdaVoteReceipt(proposalPk, voter);

        const sim = await program.methods.vote(yes)
          .accounts({ proposal: proposalPk, voter, voteReceipt: voteReceiptPda, systemProgram: SystemProgram.programId })
          .simulate();

        resultEl.innerHTML = `<span class="ok">✅ Simulate(vote ${yes?"YES":"NO"}) OK</span>`;
        lastFetchEl.textContent = (sim?.logs || []).join("\n") || "—";
      } catch (e) {
        resultEl.innerHTML = `<span class="err">❌ Simulate(vote) fail: ${e.message}</span>`;
      }
    }
    $("btnSimYes").onclick = () => simulateVote(true);
    $("btnSimNo").onclick  = () => simulateVote(false);

    setStatus("Pagina geladen. Verbind je wallet.");
  </script>
</body>
</html>

