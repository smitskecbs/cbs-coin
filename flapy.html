<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBS Jump ‚Äì Community Builds Sovereignty</title>
  <style>
    :root{
      --bg1:#0b0b10; --bg2:#11131a; --mint:#00ffd1; --white:#eef2f7; --muted:#8aa1b4;
      --gold:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
    #wrap{display:flex;flex-direction:column;align-items:center;gap:.75rem;padding:1rem 1rem 2rem}
    h1{margin:.25rem 0 0;color:var(--mint);font-weight:800;letter-spacing:.5px}
    #hud{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;justify-content:center}
    .pill{padding:.35rem .75rem;border:1px solid #1f2330;border-radius:999px;background:#0e1118;color:var(--white);font-size:.9rem}
    .btn{padding:.5rem .9rem;border:1px solid #223046;background:#0f141f;color:var(--white);border-radius:.6rem;cursor:pointer;transition:transform .08s ease, background .2s ease}
    .btn:hover{transform:translateY(-1px);background:#121a29}
    .btn:active{transform:translateY(1px)}
    #canvas{width:min(100vw - 2rem, 900px);height:70vh;max-height:860px;border:1px solid #1e2433;border-radius:14px;background:#06070a;display:block}
    #tips{color:var(--muted);font-size:.9rem;text-align:center;max-width:900px}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .card{background:rgba(10,12,18,.75);backdrop-filter:blur(6px);border:1px solid #1f2937;border-radius:16px;padding:1rem 1.25rem;color:var(--white);box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:min(92vw,560px);text-align:center}
    .card h2{margin:.2rem 0 .6rem;color:var(--mint)}
    .card p{margin:.25rem 0;color:#c9d4e3}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.6rem}
    .kbd{border:1px solid #2b3344;background:#0e1320;padding:.3rem .5rem;border-radius:.5rem;color:#cfe9ff}
    .emph{color:var(--gold);font-weight:700}
    #foot{color:#6f8093;font-size:.85rem;text-align:center;margin-top:.5rem}
  </style>
</head>
<body>
  <div id="wrap">
    <h1>CBS Jump</h1>
    <div id="hud">
      <span class="pill">Score: <span id="score">0</span></span>
      <span class="pill">Hoogte: <span id="height">0</span> m</span>
      <span class="pill">Fase: <span id="phase">Grond</span></span>
      <button id="reset" class="btn">üîÑ Opnieuw</button>
      <button id="harder" class="btn" title="Schakel extra moeilijkheid">‚ö° Moeilijker: <span id="harderState">aan</span></button>
      <button id="mute" class="btn" title="Mute achtergrondgeluid">üîà Geluid: <span id="muteState">aan</span></button>
    </div>
    <canvas id="canvas"></canvas>
    <div id="tips">
      Spring nauwkeurig! Je klimt door <b>Grond</b> ‚Üí <b>Wolken</b> ‚Üí <b>Ruimte</b>. In wolken zie je subtiele vliegtuigjes,
      in de ruimte fonkelen sterren en vallen er meteoren. Na game over: <b>vuurwerk</b> üéÜ. Veel succes!
    </div>
    <div id="foot">¬© CBS Coin ‚Äì Community Builds Sovereignty</div>
  </div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="card">
      <h2>Klaar voor de sprong? üöÄ</h2>
      <p>Wolken pas na <span class="emph">20</span> platforms. Alleen <b>wolk-platforms</b> (geen volle wolkendeken).</p>
      <p class="row">
        <span class="kbd">‚Üê</span><span class="kbd">‚Üí</span> bewegen
        <span class="kbd">Spatie</span>/<span class="kbd">‚Üë</span> springen
      </p>
      <div class="row">
        <button id="startBtn" class="btn">Start</button>
      </div>
    </div>
  </div>

  <!-- Game over overlay -->
  <div class="overlay" id="overOverlay" style="display:none;">
    <div class="card">
      <h2>Game Over</h2>
      <p><b>Thanks for your support ‚ù§Ô∏è</b></p>
      <p>Score: <span id="finalScore" class="emph">0</span> ‚Äì Hoogte: <span id="finalHeight" class="emph">0</span> m</p>
      <div class="row">
        <button id="againBtn" class="btn">Nog een keer</button>
      </div>
    </div>
  </div>

<script>
(()=>{
  // ====== Canvas setup ======
  const cvs = document.getElementById('canvas');
  const ctx = cvs.getContext('2d');
  function fitCanvas(){
    const rect = cvs.getBoundingClientRect();
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    cvs.width  = Math.max(2, Math.floor(rect.width  * dpr));
    cvs.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', fitCanvas, {passive:true});
  window.addEventListener('load', fitCanvas, {once:true});

  // ====== UI ======
  const $ = id=>document.getElementById(id);
  const uiScore = $('score'), uiHeight=$('height'), uiPhase=$('phase');
  const btnReset=$('reset'), btnHarder=$('harder'), btnMute=$('mute');
  const harderState=$('harderState'), muteState=$('muteState');
  const startOverlay=$('startOverlay'), startBtn=$('startBtn');
  const overOverlay=$('overOverlay'), againBtn=$('againBtn');
  const finalScore=$('finalScore'), finalHeight=$('finalHeight');

  // ====== Audio (IPFS) ======
  const IPFS_CID = "bafybeif7okyipwq3m5fus33fpbxyd5byftb62m72xz4vvwkyf4cng6k2bq";
  const BGM_URLS = [
    `https://gateway.pinata.cloud/ipfs/${IPFS_CID}`,
    `https://ipfs.io/ipfs/${IPFS_CID}`,
    `https://cloudflare-ipfs.com/ipfs/${IPFS_CID}`
  ];
  let audioCtx, bgmSource, bgmGain, bgmBuffer=null;
  let muted=false; muteState.textContent='aan';

  function fetchWithTimeout(url, ms=12000){
    return new Promise((resolve,reject)=>{
      const ctrl=new AbortController(); const t=setTimeout(()=>{ctrl.abort();reject(new Error('timeout'))},ms);
      fetch(url,{signal:ctrl.signal}).then(r=>{clearTimeout(t); if(!r.ok) throw new Error('http '+r.status); return r.arrayBuffer();})
      .then(arr=>resolve(arr)).catch(e=>{clearTimeout(t); reject(e)});
    });
  }
  async function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      bgmGain = audioCtx.createGain();
      bgmGain.gain.value = 0.25;
      bgmGain.connect(audioCtx.destination);
    }
  }
  async function loadBGM(){
    if(bgmBuffer) return bgmBuffer;
    await ensureAudio();
    for(const u of BGM_URLS){
      try{
        const buf = await audioCtx.decodeAudioData(await fetchWithTimeout(u,12000));
        bgmBuffer = buf; return buf;
      }catch{}
    }
    throw new Error('BGM niet geladen');
  }
  async function toggleBGM(on){
    try{
      if(on){
        const buf = await loadBGM();
        if(bgmSource){ try{bgmSource.stop()}catch{} }
        bgmSource = audioCtx.createBufferSource();
        bgmSource.buffer = buf; bgmSource.loop=true;
        bgmSource.connect(bgmGain); bgmSource.start(0);
      }else{
        if(bgmSource){ try{bgmSource.stop()}catch{} }
      }
    }catch(e){ console.warn('BGM:',e.message); }
  }
  btnMute.addEventListener('click', async ()=>{
    muted=!muted; muteState.textContent = muted?'uit':'aan';
    await toggleBGM(!muted);
  });

  // ====== Game constants ======
  const GRAVITY=0.5, JUMP_VELOCITY=-10.8, PLAYER_SPEED=3.6;
  const PLATFORM_W=90, PLATFORM_H=10, START_PLATFORMS=10;
  const CLOUD_START_AFTER_JUMPS=20, SPACE_START_AFTER_JUMPS=60;
  const WORLD_WRAP=true;

  // ====== State ======
  let harder=true; harderState.textContent='aan';
  btnHarder.addEventListener('click',()=>{ harder=!harder; harderState.textContent=harder?'aan':'uit'; });

  let running=false, gameOver=false, last=0;

  const world={cameraY:0,height:0,score:0,jumps:0,phase:'ground',time:0};
  const player={x:100,y:0,vx:0,vy:0,w:28,h:36,onGround:false,color:'#00ffd1'};

  const platforms=[], birds=[], planes=[], stars=[], shooters=[], fireworks=[];

  // ====== Helpers ======
  const rand=(a,b)=>Math.random()*(b-a)+a;
  const irand=(a,b)=>Math.floor(rand(a,b));
  const intersects=(ax,ay,aw,ah,bx,by,bw,bh)=> ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;

  function setPhaseByJumps(){
    const jp=world.jumps, old=world.phase;
    world.phase = jp>=SPACE_START_AFTER_JUMPS ? 'space' : jp>=CLOUD_START_AFTER_JUMPS ? 'clouds' : 'ground';
    if(old!==world.phase){
      if(world.phase==='clouds'){
        planes.length=0;
        for(let i=0;i<4;i++) planes.push({x:rand(0,cvs.width/(window.devicePixelRatio||1)),y:world.cameraY-rand(200,800),vx:rand(.25,.6),scale:rand(.6,1)});
      }
      if(world.phase==='space'){
        stars.length=0;
        for(let i=0;i<120;i++) stars.push({x:rand(0,cvs.width),y:world.cameraY-rand(0,2000),tw:rand(0,Math.PI*2),r:rand(.5,1.8)});
      }
    }
  }

  function reset(){
    fitCanvas();
    running=false; gameOver=false;
    Object.assign(world,{cameraY:0,height:0,score:0,jumps:0,phase:'ground',time:0});
    Object.assign(player,{x:cvs.width/(2*(window.devicePixelRatio||1)),y:0,vx:0,vy:0,onGround:false});
    platforms.length=0; birds.length=0; planes.length=0; stars.length=0; shooters.length=0; fireworks.length=0;

    const baseY=40;
    for(let i=0;i<START_PLATFORMS;i++){
      const y=-i*70+baseY;
      platforms.push({x:(i===0? player.x-PLATFORM_W/2 : rand(30,(cvs.width/(window.devicePixelRatio||1))-PLATFORM_W-30)), y, w:PLATFORM_W, h:PLATFORM_H, type:'grass'});
    }
    for(let i=0;i<6;i++) birds.push({x:rand(0,cvs.width/(window.devicePixelRatio||1)), y:rand(-60,60), vx:rand(.3,.65), flap:rand(0,Math.PI*2), layer:'ground'});

    $('overOverlay').style.display='none';
    $('startOverlay').style.display='flex'; // force zichtbaar
    updateHUD(); draw(0);
  }

  function updateHUD(){
    uiScore.textContent = Math.floor(world.score);
    uiHeight.textContent = Math.floor(-world.cameraY/10);
    uiPhase.textContent = world.phase==='ground'?'Grond':(world.phase==='clouds'?'Wolken':'Ruimte');
  }

  // ====== Input (keyboard + tap) ======
  const keys={};
  const startIfNeeded=async ()=>{
    if(!running && !gameOver){
      startOverlay.style.display='none';
      running=true;
      if(!muted) await toggleBGM(true);
    }
  };
  window.addEventListener('keydown',e=>{
    keys[e.code]=true;
    if(['Space','ArrowUp','ArrowLeft','ArrowRight'].includes(e.code)) startIfNeeded();
  });
  window.addEventListener('keyup',e=>{ keys[e.code]=false; });
  startOverlay.addEventListener('click', startIfNeeded, {passive:true});
  document.addEventListener('touchstart', startIfNeeded, {passive:true});

  // ====== Platform generation ======
  const highestPlatformY=()=> platforms.reduce((m,p)=> p.y<m? p.y:m, Infinity);
  function platformDifficulty(){
    const j=world.jumps;
    return { gap: 65 + Math.min(80, j*0.9) + (harder?20:0), moveChance: Math.min(0.2, j*0.002 + (harder?0.05:0)) };
  }
  function spawnPlatformsIfNeeded(){
    const {gap, moveChance}=platformDifficulty();
    const targetTop = world.cameraY - 800;
    let top = highestPlatformY();
    while(top > targetTop){
      const y = top - gap;
      const type = (world.phase==='ground') ? 'grass' : 'cloud';
      const w = PLATFORM_W + (type==='cloud'?10:0);
      const x = rand(25, (cvs.width/(window.devicePixelRatio||1)) - w - 25);
      const plat = {x,y,w,h:PLATFORM_H,type};
      if(Math.random() < moveChance){
        plat.vx = rand(0.5,1.2) * (Math.random()<0.5?-1:1);
        plat.minX=20; plat.maxX=(cvs.width/(window.devicePixelRatio||1))-w-20;
      }
      platforms.push(plat);
      top = highestPlatformY();
    }
  }

  // ====== Effects ======
  function spawnJumpSpark(x,y,color='#aaf'){
    for(let i=0;i<6;i++) fireworks.push({x,y,vx:rand(-1,1),vy:rand(-2,-.5),life:irand(18,28),color,grav:.08,size:rand(1,2),mode:'spark'});
  }
  function spawnGameOverFireworks(){
    const cx=cvs.width/(2*(window.devicePixelRatio||1)), cy=cvs.height/(2*(window.devicePixelRatio||1))-40;
    const palette=['#ff6b6b','#ffd166','#4cc9f0','#b8f2e6','#f72585'];
    for(let k=0;k<6;k++) for(let i=0;i<60;i++){
      const a=rand(0,Math.PI*2), sp=rand(1.4,3.6);
      fireworks.push({x:cx+rand(-50,50), y:cy+rand(-20,20), vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:irand(38,62), color:palette[k%5], grav:.02, size:rand(1.2,2.2), mode:'boom'});
    }
  }

  // ====== Draw helpers ======
  function drawGradientSky(){
    const w=cvs.width/(window.devicePixelRatio||1), h=cvs.height/(window.devicePixelRatio||1);
    let g=ctx.createLinearGradient(0,h,0,0);
    if(world.phase==='ground'){ g.addColorStop(0,'#0d1320'); g.addColorStop(1,'#16263f'); }
    else if(world.phase==='clouds'){ g.addColorStop(0,'#0a1020'); g.addColorStop(1,'#1b2f55'); }
    else{ g.addColorStop(0,'#05060c'); g.addColorStop(1,'#0a0d18'); }
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  }
  function drawParallaxGround(){
    const w=cvs.width/(window.devicePixelRatio||1), h=cvs.height/(window.devicePixelRatio||1);
    const baseY = Math.floor(h - 30 + (world.cameraY*0.2)%60);
    ctx.fillStyle='#0a1a12'; ctx.fillRect(0,baseY,w,h-baseY);
    ctx.fillStyle='#0f3a28'; ctx.fillRect(0,baseY-6,w,6);
    ctx.fillStyle='#0c271b';
    for(let x=-100;x<w+100;x+=60){
      const r=10+((x/60)%2)*4; ctx.beginPath(); ctx.arc(x+(world.cameraY*0.15%60), baseY-8, r, 0, Math.PI*2); ctx.fill();
    }
  }
  function drawBird(b){
    ctx.save(); ctx.translate(b.x, b.y - world.cameraY*0.2);
    ctx.fillStyle='#dfe7f1'; ctx.beginPath(); ctx.ellipse(0,0,6,4,0,0,Math.PI*2); ctx.fill();
    const wing=Math.sin(b.flap)*5; ctx.beginPath(); ctx.moveTo(-2,0); ctx.lineTo(-10,-wing); ctx.lineTo(-6,0); ctx.fillStyle='#c5d3e4'; ctx.fill();
    ctx.beginPath(); ctx.moveTo(2,0); ctx.lineTo(10,-wing); ctx.lineTo(6,0); ctx.fill();
    ctx.fillStyle='#ffcc66'; ctx.fillRect(6,-1.2,2.5,2.4);
    ctx.restore();
  }
  function drawPlane(p){
    ctx.save(); ctx.translate(p.x, p.y - world.cameraY*0.3); ctx.scale(p.scale,p.scale); ctx.globalAlpha=0.45;
    ctx.fillStyle='#d0e2ff'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(24,2); ctx.lineTo(24,-2); ctx.closePath(); ctx.fill();
    ctx.fillRect(6,-1.5,10,3); ctx.fillRect(10,-5,6,3); ctx.fillRect(10,2,6,3);
    ctx.globalAlpha=1; ctx.restore();
  }
  function drawStars(){
    for(const s of stars){
      const yPar=s.y - world.cameraY*0.6;
      if(yPar>-50 && yPar<(cvs.height/(window.devicePixelRatio||1))+50){
        const tw=(Math.sin(world.time*0.05 + s.tw)+1)/2;
        ctx.fillStyle = `rgba(220,235,255,${0.35 + tw*0.55})`;
        ctx.beginPath(); ctx.arc(s.x,yPar,s.r,0,Math.PI*2); ctx.fill();
      }
    }
  }
  function drawShootingStars(){
    ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=1.5;
    for(const sh of shooters){ const yPar=sh.y - world.cameraY*0.7; ctx.beginPath(); ctx.moveTo(sh.x,yPar); ctx.lineTo(sh.x-sh.vx*6,yPar-sh.vy*6); ctx.stroke(); }
  }
  function roundRect(ctx,x,y,w,h,r,fill=true){
    if(w<2*r) r=w/2; if(h<2*r) r=h/2;
    ctx.beginPath(); ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill();
  }
  function drawPlatform(p){
    ctx.save(); ctx.translate(p.x, p.y - world.cameraY);
    if(p.type==='grass'){
      ctx.fillStyle='#1c8f65'; roundRect(ctx,0,0,p.w,p.h,4);
      ctx.fillStyle='#0f5d43'; ctx.fillRect(2,p.h-4,p.w-4,3);
    }else{
      ctx.fillStyle='rgba(240,248,255,.95)'; roundRect(ctx,0,0,p.w,p.h+8,8);
      ctx.fillStyle='rgba(200,220,240,.8)'; roundRect(ctx,4,3,p.w-8,p.h+5,6);
    }
    ctx.restore();
  }
  function drawPlayer(){
    const px=player.x, py=player.y - world.cameraY;
    ctx.fillStyle=player.color; roundRect(ctx,px,py-player.h,player.w,player.h,6);
    ctx.fillStyle='#092c24'; roundRect(ctx,px+4, py-player.h+6, player.w-8,10,4);
    ctx.fillStyle='#ffffff44'; ctx.fillRect(px+6, py-player.h+8, 3,6);
  }
  function drawFireworks(dt){
    for(let i=fireworks.length-1;i>=0;i--){
      const f=fireworks[i]; f.x+=f.vx*dt; f.y+=f.vy*dt; f.vy+=f.grav*dt; if(--f.life<=0) fireworks.splice(i,1);
      ctx.fillStyle=f.color; ctx.globalAlpha=Math.max(0,f.life/60);
      ctx.beginPath(); ctx.arc(f.x, f.y - world.cameraY, f.size||2, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    }
  }

  // ====== Game loop ======
  function loop(ts){
    if(!running && !gameOver){ draw(0); return requestAnimationFrame(loop); }
    const dt = Math.min(32, ts - (loop._last||ts)); loop._last=ts;
    world.time += dt;
    update(dt/16.6); draw(dt/16.6);
    requestAnimationFrame(loop);
  }

  function update(dt){
    const speedMul = 1 + (world.jumps*0.01) + (harder?0.2:0);
    const moveSpeed = PLAYER_SPEED * speedMul;

    if(keys['ArrowLeft']) player.vx = -moveSpeed;
    else if(keys['ArrowRight']) player.vx = moveSpeed;
    else player.vx *= 0.8;

    if((keys['Space']||keys['ArrowUp']) && player.onGround){
      player.vy = -10.8 * (1 + (harder?0.05:0)); player.onGround=false;
      world.jumps++; world.score+=10; setPhaseByJumps();
      fireworks.push({x:player.x+player.w/2,y:player.y-player.h,vx:0,vy:-1.5,life:18,color:'#aaf',grav:.08,size:2,mode:'spark'});
    }

    player.vy += 0.5 * dt; player.x += player.vx * dt; player.y += player.vy * dt;

    const viewW=cvs.width/(window.devicePixelRatio||1);
    if(WORLD_WRAP){ if(player.x < -player.w) player.x=viewW; if(player.x>viewW) player.x=-player.w; }
    else { player.x=Math.max(0,Math.min(viewW-player.w,player.x)); }

    let landed=false;
    for(const p of platforms){
      if(p.vx){ p.x+=p.vx*dt; if(p.x<p.minX){p.x=p.minX;p.vx*=-1} if(p.x>p.maxX){p.x=p.maxX;p.vx*=-1} }
      const wasAbove=(player.y-player.h)<=p.y && player.vy>0;
      if(wasAbove && intersects(player.x,player.y-player.h,player.w,player.h, p.x,p.y-2,p.w,p.h+6)){
        player.y=p.y+player.h; player.vy=0; player.onGround=true; landed=true;
      }
    }
    if(!landed) player.onGround=false;

    const marginY=(cvs.height/(window.devicePixelRatio||1))*0.45;
    world.cameraY = Math.min(world.cameraY, player.y - marginY);

    world.height = Math.max(world.height, -world.cameraY/10);
    world.score += dt * 0.6 + (player.vy < 0 ? 0.2 : 0);

    spawnPlatformsIfNeeded();

    // background actors
    for(const b of birds){
      const sp=b.layer==='ground'? b.vx : b.vx*0.85;
      b.x+=sp*dt; b.flap += dt*0.6;
      if(b.x > viewW+20){ b.x=-20; b.y+=rand(-10,10); }
      if(world.phase==='clouds' && b.layer==='ground'){ b.layer='clouds'; b.y=world.cameraY - rand(200,600); }
    }
    if(world.phase==='clouds' && Math.random()<0.01) planes.push({x:-30,y:world.cameraY-rand(300,1200),vx:rand(.25,.6),scale:rand(.6,1)});
    for(const pl of planes){ pl.x += pl.vx*dt*2.5; if(pl.x>viewW+40) pl.x=-40; }
    if(world.phase==='space' && Math.random()<0.01) shooters.push({x:rand(0,viewW), y:world.cameraY-rand(100,800), vx:rand(3,6), vy:rand(2,4), life:irand(30,60)});
    for(let i=shooters.length-1;i>=0;i--){ const sh=shooters[i]; sh.x+=sh.vx*dt; sh.y+=sh.vy*dt; if(--sh.life<=0) shooters.splice(i,1); }

    // fail
    const bottom=(cvs.height/(window.devicePixelRatio||1))-20;
    if((player.y - world.cameraY) > bottom + 60) triggerGameOver();
  }

  function triggerGameOver(){
    if(gameOver) return; gameOver=true; running=false;
    finalScore.textContent = Math.floor(world.score);
    finalHeight.textContent = Math.floor(world.height);
    overOverlay.style.display='flex';
    spawnGameOverFireworks();
  }

  function draw(dt){
    drawGradientSky();
    if(world.phase==='ground') drawParallaxGround();
    else if(world.phase==='space'){ drawStars(); drawShootingStars(); }
    if(world.phase==='clouds'){ for(const pl of planes) drawPlane(pl); }
    for(const b of birds) drawBird(b);
    for(const p of platforms) drawPlatform(p);
    drawPlayer();
    drawFireworks(dt);
    updateHUD();
  }

  // ====== Controls ======
  btnReset.addEventListener('click', reset);
  startBtn.addEventListener('click', async ()=>{ startOverlay.style.display='none'; running=true; if(!muted) await toggleBGM(true); });
  againBtn.addEventListener('click', ()=>{ reset(); startOverlay.style.display='none'; running=true; });

  // ====== Init ======
  reset(); requestAnimationFrame(loop);

  // Watchdog: als iemand het bestand in een vreemd iframe laadt
  setTimeout(()=>{ if(!running && !gameOver) draw(0); }, 500);
})();
</script>
</body>
</html>
