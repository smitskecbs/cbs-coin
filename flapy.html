<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CBS Jump — Realistic Earth Start</title>
<style>
  html,body{margin:0;height:100%;background:#0b0f18;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh}
  .hud{
    position:fixed;top:10px;left:50%;transform:translateX(-50%);
    color:#fff;font:700 20px system-ui,sans-serif;text-shadow:0 2px 4px rgba(0,0,0,.6);pointer-events:none
  }
  .audio-ui{
    position:fixed;top:10px;right:10px;display:flex;gap:8px;align-items:center;
    background:rgba(0,0,0,.35);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.15); padding:8px 10px; border-radius:12px;
    color:#fff;font:600 13px system-ui,sans-serif
  }
  .audio-btn{
    appearance:none;border:0;border-radius:10px;padding:6px 10px;cursor:pointer;
    background:#1f2937;color:#fff;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.35)
  }
  .audio-btn:active{transform:translateY(1px)}
  .vol{width:110px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud" class="hud">0 m</div>

<!-- Muziek UI -->
<div class="audio-ui">
  <button id="toggleAudio" class="audio-btn">▶︎ Play</button>
  <label>Vol.</label>
  <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="0.5"/>
  <span id="audioStatus" style="opacity:.8">klaar</span>
</div>

<script>
/* ========== Audio (Pinata CID) ========== */
const AUDIO_URL = 'https://gateway.pinata.cloud/ipfs/bafybeif7okyipwq3m5fus33fpbxyd5byftb62m72xz4vvwkyf4cng6k2bq';
const audio = new Audio(AUDIO_URL);
audio.loop = true; audio.preload = 'auto'; audio.volume = 0.5;
let audioReady=false, audioPlaying=false;
const btn=document.getElementById('toggleAudio'), vol=document.getElementById('vol'), aStatus=document.getElementById('audioStatus');
audio.addEventListener('canplaythrough',()=>{audioReady=true;aStatus.textContent='gereed';});
audio.addEventListener('error',()=>{aStatus.textContent='audio laadfout';});
async function safePlay(){try{await audio.play();audioPlaying=true;btn.textContent='⏸ Pause';aStatus.textContent='speelt';}catch(e){aStatus.textContent='tap om te spelen';}}
btn.addEventListener('click', async ()=>{ if(!audioReady){aStatus.textContent='laden…';return;} if(audioPlaying){audio.pause();audioPlaying=false;btn.textContent='▶︎ Play';aStatus.textContent='gepauzeerd';} else {await safePlay();}});
vol.addEventListener('input', ()=>{audio.volume=parseFloat(vol.value);});
['pointerdown','keydown'].forEach(evt=>{addEventListener(evt, async ()=>{if(audioReady&&!audioPlaying){await safePlay();}}, {once:false});});

/* ========== Canvas ========== */
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
let W=innerWidth,H=innerHeight; canvas.width=W; canvas.height=H;
addEventListener('resize',()=>{W=innerWidth;H=innerHeight;canvas.width=W;canvas.height=H; env.rebuild();});

/* ========== Assets ========== */
const logo=new Image(); logo.src='logo.png';
const isMobile=/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ========== Player/Physics ========== */
const GRAV=1600, JUMP=isMobile?-980:-1020, COYOTE=0.12;
let player={x:0,y:0,r:Math.max(26,Math.min(40,H*0.04)),vy:0,onGround:false,coyote:0};
let groundPlat=null, camY=0, score=0; const hud=document.getElementById('hud');

/* ========== Zones (we STARTEN op aarde) ========== */
const ALT_EARTH=0;          // 0 = aardniveau (start)
const ALT_CLOUDS=1500;
const ALT_SPACE =3500;
const ALT_HEAVEN=6200;
const BLEND=700;            // brede zachte overgang

const zoneSpec = {
  EARTH:{ colorTop:'#8ecae6', colorBot:'#86b1a2' },     // frisse hemel naar groener horizon
  CLOUDS:{ colorTop:'#dff0ff', colorBot:'#a7ccff' },
  SPACE:{ colorTop:'#0b0e2a', colorBot:'#000005' },
  HEAVEN:{ colorTop:'#f4ecff', colorBot:'#d9ccff' }
};

const ZEARTH=[-1e6, ALT_CLOUDS];
const ZCLOUDS=[ALT_CLOUDS, ALT_SPACE];
const ZSPACE=[ALT_SPACE, ALT_HEAVEN];
const ZHEAVEN=[ALT_HEAVEN, 1e6];

function smoothstep(edge0, edge1, x){ const t=Math.max(0,Math.min(1,(x-edge0)/(edge1-edge0))); return t*t*(3-2*t); }
function zoneAlpha(range, alt){
  const [a,b]=range;
  const fadeIn  = (alt<a)?0 : smoothstep(a, a+BLEND, alt);
  const fadeOut = (alt>b-BLEND)?(1-smoothstep(b-BLEND, b, alt)) : 1;
  return Math.max(0, Math.min(1, fadeIn*fadeOut));
}
function zoneByAlt(alt){
  if(alt<ALT_CLOUDS) return 'EARTH';
  if(alt<ALT_SPACE)  return 'CLOUDS';
  if(alt<ALT_HEAVEN) return 'SPACE';
  return 'HEAVEN';
}

/* ========== Platforms ========== */
let idSeq=1; const newId=()=>idSeq++;
let currentPlat=null, nextPlat=null;
const GAP_BASE=180, GAP_VAR=50;

function platformSpecForZone(zone){
  switch(zone){
    case 'EARTH':  return {type:'wood',   w:Math.max(150,W*0.26), h:22};
    case 'CLOUDS': return {type:'cloud',  w:Math.max(180,W*0.30), h:26};
    case 'SPACE':  return {type:'sat',    w:Math.max(150,W*0.25), h:18};
    case 'HEAVEN': return {type:'marble', w:Math.max(170,W*0.28), h:22};
  }
}
function makePlatform(x,y,zone,isBase=false){
  const s=platformSpecForZone(zone);
  const amp=isBase?0:(W/2-60), speed=isBase?0:(isMobile?0.9:1.05);
  return {id:newId(), x0:x, y, w:s.w, h:s.h, type:s.type, amp, speed, phase:Math.random()*6.28, isBase, lastX:x};
}
const platX=p=>p.x0+Math.sin(p.phase)*p.amp, platTop=p=>p.y-p.h/2;

function spawnNextAbove(ref){
  const alt=-ref.y, zone=zoneByAlt(alt);
  const diff=Math.min(220, Math.max(0, alt/10));
  const gap=GAP_BASE + Math.min(GAP_VAR, diff);
  return makePlatform(W/2, ref.y - (gap+Math.random()*20), zone, false);
}

/* ========== Input ========== */
function jump(){
  if(player.onGround||player.coyote>0){
    player.vy=JUMP; player.onGround=false; player.coyote=0; groundPlat=null;
  }
}
addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();jump();}});
addEventListener('pointerdown',jump);

/* ========== Environment (realistischer aarde + parallax) ========== */
const env={
  t:0,
  // Earth
  hillsNear:[], hillsFar:[], treeLine:[], city:[],
  birds:[],
  // Sky/Clouds
  clouds:[],
  // Space
  stars:[], planets:[],
  rebuild(){
    // Heuvels (zacht, realistisch)
    this.hillsFar = makeHills(0.58, 0.045, '#2b403e', 6);
    this.hillsNear= makeHills(0.66, 0.055, '#203331', 6);
    // Boomrij (silhouet)
    this.treeLine = makeTreeLine('#1a2a28');
    // Stad verder weg (subtiel)
    this.city=[makeCity(0.35,'#24353a',.10,.82), makeCity(0.55,'#1a2a2e',.12,.87)];
    // Vogels (subtiel)
    this.birds=[]; for(let i=0;i<4;i++) this.birds.push(makeBird());
    // Wolken
    this.clouds=[]; for(let i=0;i<20;i++) this.clouds.push({x:Math.random()*W,y:Math.random()*H*0.8,w:rnd(160,300),h:rnd(60,110),s:rnd(0.03,0.08)});
    // Sterren en enkele planeten voor latere zones
    this.stars=[]; for(let i=0;i<140;i++) this.stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.3+0.3, tw:Math.random()*6.28});
    this.planets=[]; for(let i=0;i<2;i++) this.planets.push(makePlanet());
    this.t=0;
  },
  update(dt){
    this.t+=dt;
    for(const c of this.clouds){ c.x-=8*c.s*dt; if(c.x<-c.w) c.x=W+c.w*0.5, c.y=rnd(0,H*0.8); }
    for(const b of this.birds){ b.x+=b.vx*dt; b.y += Math.sin(this.t*1.4 + b.phase)*0.25; if(b.x>W+40){b.x=-40; b.y=rnd(H*0.2,H*0.5);} }
  }
};

/* --- Earth helpers --- */
function makeHills(baseRatio, amp, color, nPts){
  const pts=[]; for(let i=0;i<=nPts;i++){ pts.push({x:i/nPts*W, y:H*baseRatio + Math.sin(i*0.7)*H*amp}); }
  return {pts,color,speed:20*(baseRatio)};
}
function drawHills(hill, mul){
  ctx.save(); ctx.fillStyle=hill.color;
  const shift=(env.t*hill.speed*mul)%W; ctx.translate(-shift,0);
  for(let k=0;k<2;k++){
    ctx.beginPath(); ctx.moveTo(-W+k*W,H);
    for(const p of hill.pts) ctx.lineTo(p.x+k*W, p.y);
    ctx.lineTo(W+k*W,H); ctx.closePath(); ctx.fill();
  } ctx.restore();
}
function makeTreeLine(color){
  const trees=[]; let x=0;
  while(x<W+60){
    const w=rnd(12,26), h=rnd(40,80);
    trees.push({x,y:H*0.76 - h, w, h});
    x += w + rnd(8,18);
  }
  return {trees,color,speed:28};
}
function drawTreeLine(tl, mul){
  ctx.save(); ctx.fillStyle=tl.color;
  const shift=(env.t*tl.speed*mul)%W; ctx.translate(-shift,0);
  for(let k=0;k<3;k++){
    for(const t of tl.trees){
      const X=t.x + k*(W+100), Y=t.y, Wd=t.w, Hd=t.h;
      // stam
      ctx.fillRect(X+Wd*0.45, Y+Hd*0.6, Wd*0.1, Hd*0.4);
      // kroon (den/breed mix)
      ctx.beginPath(); ctx.moveTo(X+Wd*0.5, Y);
      ctx.lineTo(X+Wd, Y+Hd*0.7);
      ctx.lineTo(X, Y+Hd*0.7);
      ctx.closePath(); ctx.fill();
    }
  }
  ctx.restore();
}
function makeCity(speed,color,windowProb,groundY){
  const yBase=H*groundY, buildings=[]; let x=0;
  while(x<W+140){ const w=rnd(60,120), h=rnd(80,170);
    buildings.push({x,y:yBase-h,w,h,roof:Math.random()<.3,color,windowProb});
    x += w + rnd(16,28);
  }
  return {speed, color, buildings, yBase};
}
function drawCity(layer, alpha=1){
  ctx.save(); ctx.globalAlpha=alpha;
  const shift=(env.t*40*layer.speed)%(W+140); ctx.translate(-shift,0);
  for(let k=0;k<2;k++) for(const b of layer.buildings){
    const X=b.x + k*(W+140), Y=b.y, Wd=b.w, Hd=b.h;
    ctx.fillStyle=b.color; ctx.fillRect(X,Y,Wd,Hd);
    if(b.roof){ ctx.beginPath(); ctx.moveTo(X,Y); ctx.lineTo(X+Wd/2,Y-10); ctx.lineTo(X+Wd,Y); ctx.closePath(); ctx.fill(); }
    // enkele ramen (subtiel)
    const cols=Math.max(2,Math.floor(Wd/20)), rows=Math.max(2,Math.floor(Hd/28));
    ctx.fillStyle='rgba(255,214,115,0.6)';
    for(let i=0;i<cols;i++) for(let j=0;j<rows;j++) if(Math.random()<b.windowProb){
      ctx.fillRect(X+6+i*(Wd-12)/cols, Y+6+j*(Hd-12)/rows, 5, 8);
    }
  }
  ctx.restore();
}
function makeBird(){ return {x:rnd(-200,W), y:rnd(H*0.2,H*0.5), vx:rnd(18,35), phase:Math.random()*6.28}; }
function drawBird(b){
  ctx.strokeStyle='rgba(0,0,0,.55)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(b.x-6,b.y); ctx.quadraticCurveTo(b.x,b.y-4,b.x+6,b.y); ctx.stroke();
}

/* --- Space helpers --- */
function makePlanet(){ return {x:rnd(60,W-60), y:rnd(H*0.2,H*0.7), r:rnd(18,36), hue:rnd(180,360)}; }
function drawPlanet(p){
  const grad=ctx.createRadialGradient(p.x-p.r*0.5,p.y-p.r*0.5,p.r*0.2,p.x,p.y,p.r*1.1);
  grad.addColorStop(0, `hsl(${p.hue},60%,75%)`);
  grad.addColorStop(1, `hsl(${p.hue},60%,35%)`);
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=.28; ctx.strokeStyle='#fff'; ctx.lineWidth=1.6;
  ctx.beginPath(); ctx.ellipse(p.x,p.y+3,p.r*1.2,p.r*0.35,0,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
}

/* ========== Background draw (natural crossfade) ========== */
function drawGradient(top,bottom){
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, top); g.addColorStop(1, bottom);
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
}
function drawEARTH(alpha){
  ctx.save(); ctx.globalAlpha=alpha;
  drawGradient(zoneSpec.EARTH.colorTop, zoneSpec.EARTH.colorBot);
  drawHills(env.hillsFar, .35);
  drawCity(env.city[0], 0.85);
  drawHills(env.hillsNear, .55);
  drawTreeLine(env.treeLine, .65);
  for(const b of env.birds) drawBird(b);
  ctx.restore();
}
function drawCLOUDS(alpha){
  ctx.save(); ctx.globalAlpha=alpha;
  drawGradient(zoneSpec.CLOUDS.colorTop, zoneSpec.CLOUDS.colorBot);
  for(const c of env.clouds){
    ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.beginPath(); ctx.ellipse(c.x,c.y,c.w,c.h,0,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=alpha*0.12; ctx.fillStyle='#6ea3d6';
    ctx.beginPath(); ctx.ellipse(c.x, c.y+c.h*0.25, c.w*0.8, c.h*0.9, 0, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha=alpha;
  }
  ctx.restore();
}
function drawSPACE(alpha){
  ctx.save(); ctx.globalAlpha=alpha;
  drawGradient(zoneSpec.SPACE.colorTop, zoneSpec.SPACE.colorBot);
  for(const p of env.planets) drawPlanet(p);
  for(const s of env.stars){
    const tw = 0.4 + 0.6*(0.5+0.5*Math.sin(env.t*2 + s.tw));
    ctx.globalAlpha = alpha*(0.18 + 0.6*tw);
    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fillStyle='#cfe6ff'; ctx.fill();
  }
  ctx.restore();
}
function drawHEAVEN(alpha){
  ctx.save(); ctx.globalAlpha=alpha;
  drawGradient(zoneSpec.HEAVEN.colorTop, zoneSpec.HEAVEN.colorBot);
  const cx=W*.5, cy=H*.25;
  for(let i=0;i<5;i++){
    const ang=i/5*Math.PI*2 + env.t*.04, x2=cx+Math.cos(ang)*W*.8, y2=cy+Math.sin(ang)*H*.8;
    const lg=ctx.createLinearGradient(cx,cy,x2,y2);
    lg.addColorStop(0,'rgba(255,255,255,.18)'); lg.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=lg; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x2,y2);
    ctx.lineTo(cx+Math.cos(ang+.12)*W*.6, cy+Math.sin(ang+.12)*H*.6); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}
function drawBackground(){
  const alt=-camY; // 0 bij start op aarde
  const aE=zoneAlpha(ZEARTH,alt), aC=zoneAlpha(ZCLOUDS,alt), aS=zoneAlpha(ZSPACE,alt), aH=zoneAlpha(ZHEAVEN,alt);
  drawEARTH(aE);
  drawCLOUDS(aC);
  drawSPACE(aS);
  drawHEAVEN(aH);
}

/* ========== Collision & Platforms Rendering ========== */
function tryLandOn(p,dt){
  if(!p) return false;
  if(groundPlat && groundPlat.id===p.id) return false;
  const px=platX(p), marginX=player.r*.25;
  if(player.x < px-p.w/2 - marginX || player.x > px+p.w/2 + marginX) return false;
  const top=platTop(p), prevBottom=(player.y - player.vy*dt) + player.r, nowBottom=player.y + player.r, TOL=4;
  if(player.vy>0 && prevBottom<=top+TOL && nowBottom>=top-TOL){
    player.y=top-player.r; player.vy=0; player.onGround=true; groundPlat=p; return true;
  }
  return false;
}
function rrPath(x,y,w,h,r=8){
  const hw=w/2, hh=h/2;
  ctx.beginPath();
  ctx.moveTo(x-hw+r,y-hh); ctx.lineTo(x+hw-r,y-hh);
  ctx.quadraticCurveTo(x+hw,y-hh,x+hw,y-hh+r);
  ctx.lineTo(x+hw,y+hh-r);
  ctx.quadraticCurveTo(x+hw,y+hh,x+hw-r,y+hh);
  ctx.lineTo(x-hw+r,y+hh);
  ctx.quadraticCurveTo(x-hw,y+hh,x-hw,y+hh-r);
  ctx.lineTo(x-hw,y-hh+r);
  ctx.quadraticCurveTo(x-hw,y-hh,x-hw+r,y-hh);
  ctx.closePath();
}
function drawPlatform(p){
  const x=platX(p), y=p.y, w=p.w, h=p.h, th=Math.max(10,h*1.1);
  if(p.type==='wood') drawWood(x,y,w,h,th);
  else if(p.type==='cloud') drawCloudPlat(x,y,w,h);
  else if(p.type==='sat') drawSat(x,y,w,h,th);
  else drawMarble(x,y,w,h,th);
}
function drawWood(x,y,w,h,th){
  const sg=ctx.createLinearGradient(x,y,x,y+th); sg.addColorStop(0,'#7a4a1e'); sg.addColorStop(1,'#4b2b12');
  ctx.fillStyle=sg; rrPath(x,y+th,w,h,10); ctx.fill();
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2); g.addColorStop(0,'#c08a4b'); g.addColorStop(1,'#8a5a2a');
  ctx.fillStyle=g; rrPath(x,y,w,h,10); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=2;
  for(let i=-1;i<=1;i++){ ctx.beginPath(); ctx.moveTo(x-w*.45,y+i*5); ctx.quadraticCurveTo(x,y+i*7, x+w*.45,y+i*5); ctx.stroke(); }
}
function drawCloudPlat(x,y,w,h){
  const r=h*.9; ctx.fillStyle='rgba(255,255,255,.96)';
  const n=5, step=w/(n+1);
  for(let i=0;i<n;i++){ const cx=x-w/2+step*(i+1); ctx.beginPath(); ctx.ellipse(cx,y,r,r*.7,0,0,Math.PI*2); ctx.fill(); }
  ctx.globalAlpha=.18; ctx.fillStyle='#6ea3d6'; ctx.beginPath(); ctx.ellipse(x,y+h*.34,w*.46,h*.6,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
}
function drawSat(x,y,w,h,th){
  const sg=ctx.createLinearGradient(x,y,x,y+th); sg.addColorStop(0,'#4b5360'); sg.addColorStop(1,'#2b313a');
  ctx.fillStyle=sg; rrPath(x,y+th,w,h,8); ctx.fill();
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2); g.addColorStop(0,'#8fa7d9'); g.addColorStop(1,'#4166b3');
  ctx.fillStyle=g; rrPath(x,y,w,h,8); ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.28)'; ctx.lineWidth=1;
  const cols=6, rows=3;
  for(let i=1;i<cols;i++){ const xx=x-w/2 + i*(w/cols); ctx.beginPath(); ctx.moveTo(xx,y-h/2+4); ctx.lineTo(xx,y+h/2-4); ctx.stroke(); }
  for(let j=1;j<rows;j++){ const yy=y-h/2 + j*(h/rows); ctx.beginPath(); ctx.moveTo(x-w/2+4,yy); ctx.lineTo(x+w/2-4,yy); ctx.stroke(); }
}
function drawMarble(x,y,w,h,th){
  const sg=ctx.createLinearGradient(x,y,x,y+th); sg.addColorStop(0,'#e9e9ee'); sg.addColorStop(1,'#bdbdd2');
  ctx.fillStyle=sg; rrPath(x,y+th,w,h,10); ctx.fill();
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2); g.addColorStop(0,'#ffffff'); g.addColorStop(1,'#e7e7f5');
  ctx.fillStyle=g; rrPath(x,y,w,h,10); ctx.fill();
  ctx.globalAlpha=.18; ctx.strokeStyle='rgba(120,120,160,.6)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(x-w*.45,y-h*.15); ctx.quadraticCurveTo(x-w*.2,y, x,y-h*.05);
  ctx.quadraticCurveTo(x+w*.2,y+h*.1, x+w*.45,y-h*.02); ctx.stroke(); ctx.globalAlpha=1;
}

/* ========== Player (CBS coin) ========== */
function drawPlayer(){
  const x=player.x,y=player.y,r=player.r;
  const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.2,x,y,r*1.15);
  g.addColorStop(0,'#fff6c8'); g.addColorStop(0.55,'#f6d36a'); g.addColorStop(1,'#b78628');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,.5)';
  ctx.beginPath(); ctx.arc(x,y,r-2,0,Math.PI*2); ctx.stroke();
  if(logo.complete){ ctx.save(); ctx.beginPath(); ctx.arc(x,y,r-3,0,Math.PI*2); ctx.clip(); ctx.drawImage(logo, x-r, y-r, r*2, r*2); ctx.restore(); }
}

/* ========== Lifecycle & Loop (start op aarde) ========== */
function startRun(){
  const startZone='EARTH';
  currentPlat=makePlatform(W/2,H-90,startZone,true);
  currentPlat.lastX=platX(currentPlat);
  const top=platTop(currentPlat);
  player.x=W/2; player.r=Math.max(26,Math.min(40,H*0.04));
  player.y=top-player.r; player.vy=0; player.onGround=true; player.coyote=0; groundPlat=currentPlat;
  nextPlat=spawnNextAbove(currentPlat); nextPlat.lastX=platX(nextPlat);
  camY=0; score=0; hud.textContent='0 m';
  env.rebuild();
}
startRun();

let last=performance.now(); requestAnimationFrame(loop);
function loop(now){
  let dt=(now-last)/1000; last=now; if(dt>0.05) dt=0.05;
  env.update(dt);

  const fixed=0.008, steps=Math.max(1,Math.ceil(dt/fixed)), h=dt/steps;
  for(let i=0;i<steps;i++){
    const prevXc=currentPlat?currentPlat.lastX:0, prevXn=nextPlat?nextPlat.lastX:0;
    if(nextPlat&&!nextPlat.isBase) nextPlat.phase+=nextPlat.speed*h;
    if(currentPlat&&!currentPlat.isBase) currentPlat.phase+=currentPlat.speed*h;
    if(currentPlat) currentPlat.lastX=platX(currentPlat); if(nextPlat) nextPlat.lastX=platX(nextPlat);
    const dxc=currentPlat?(currentPlat.lastX-prevXc):0, dxn=nextPlat?(nextPlat.lastX-prevXn):0;

    if(groundPlat){ // sticky follow
      const dx=(groundPlat.id===currentPlat?.id)?dxc:(groundPlat.id===nextPlat?.id?dxn:0);
      player.x=clamp(player.x+dx,player.r,W-player.r);
      player.y=platTop(groundPlat)-player.r; player.vy=Math.max(0,player.vy);
      player.onGround=true; player.coyote=COYOTE;
    }else{
      player.vy+=GRAV*h; player.y+=player.vy*h; player.coyote=Math.max(0,player.coyote-h); player.onGround=false;
      const landedNext=tryLandOn(nextPlat,h);
      if(landedNext){ currentPlat=nextPlat; nextPlat=spawnNextAbove(currentPlat); nextPlat.lastX=platX(nextPlat); }
    }
  }

  if(player.y<camY+H*0.45) camY=player.y-H*0.45;
  if(player.y-camY>H+200) startRun();

  const meters=Math.max(0,Math.floor((-(player.y - (H-140)))/6));
  if(meters!==score){ score=meters+" m"; hud.textContent=score; }

  ctx.clearRect(0,0,W,H);
  drawBackground();

  ctx.save(); ctx.translate(0,-camY);
  if(currentPlat) drawPlatform(currentPlat);
  if(nextPlat) drawPlatform(nextPlat);
  drawPlayer();
  ctx.restore();

  requestAnimationFrame(loop);
}

/* ========== Utils ========== */
function rnd(a,b){return a+Math.random()*(b-a)}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
</script>
</body>
</html>
