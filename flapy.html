<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CBS Jump — Langere Lagen, Subtiele Vliegtuigen & Gebalanceerde Moeilijkheid</title>
<style>
  html,body{margin:0;height:100%;background:#0b0f18;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh}
  .hud{
    position:fixed;top:10px;left:50%;transform:translateX(-50%);
    color:#fff;font:700 20px system-ui,sans-serif;text-shadow:0 2px 4px rgba(0,0,0,.6);pointer-events:none
  }
  .audio-ui{
    position:fixed;top:10px;right:10px;display:flex;gap:8px;align-items:center;
    background:rgba(0,0,0,.35);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.15); padding:8px 10px; border-radius:12px;
    color:#fff;font:600 13px system-ui,sans-serif
  }
  .audio-btn{
    appearance:none;border:0;border-radius:10px;padding:6px 10px;cursor:pointer;
    background:#1f2937;color:#fff;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.35)
  }
  .audio-btn:active{transform:translateY(1px)}
  .vol{width:110px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud" class="hud">0 m</div>

<!-- Muziek UI -->
<div class="audio-ui">
  <button id="toggleAudio" class="audio-btn">▶︎ Play</button>
  <label>Vol.</label>
  <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="0.5"/>
  <span id="audioStatus" style="opacity:.8">klaar</span>
</div>

<script>
/* ================= Audio ================= */
const AUDIO_URL='https://gateway.pinata.cloud/ipfs/bafybeif7okyipwq3m5fus33fpbxyd5byftb62m72xz4vvwkyf4cng6k2bq';
const audio=new Audio(AUDIO_URL);
audio.loop=true; audio.preload='auto';
audio.volume=parseFloat(localStorage.getItem('cbs_audio_vol')||'0.5');
let audioReady=false,audioPlaying=false;
const btn=document.getElementById('toggleAudio'),vol=document.getElementById('vol'),aStatus=document.getElementById('audioStatus');
vol.value=audio.volume.toString();
audio.addEventListener('canplaythrough',()=>{audioReady=true;aStatus.textContent='gereed';});
audio.addEventListener('error',()=>{aStatus.textContent='audio laadfout';});
async function safePlay(){try{await audio.play();audioPlaying=true;btn.textContent='⏸ Pause';aStatus.textContent='speelt';}catch(e){aStatus.textContent='tap om te spelen';}}
btn.addEventListener('click',async()=>{if(!audioReady){aStatus.textContent='laden…';return;} if(audioPlaying){audio.pause();audioPlaying=false;btn.textContent='▶︎ Play';aStatus.textContent='gepauzeerd';}else{await safePlay();}});
vol.addEventListener('input',()=>{audio.volume=parseFloat(vol.value);localStorage.setItem('cbs_audio_vol',audio.volume.toString());});
['pointerdown','keydown'].forEach(evt=>{addEventListener(evt,async()=>{if(audioReady&&!audioPlaying){await safePlay();}},{once:false});});

/* ================ Canvas (HiDPI) ================ */
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
let W=0,H=0,DPR=1;
function resize(){
  DPR=Math.max(1,Math.min(2,devicePixelRatio||1));
  W=innerWidth; H=innerHeight;
  canvas.width=Math.floor(W*DPR); canvas.height=Math.floor(H*DPR);
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize',resize);

/* ================ Assets & device tuning ================ */
const logo=new Image(); logo.src='logo.png';
const isMobile=/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* Balans mobiel vs desktop */
const DIFF = isMobile
  ? { jump:-820, gapBase:125, gapVar:34, widthMul:0.92, ampMul:1.10 } // mobiel iets moeilijker
  : { jump:-920, gapBase:100, gapVar:26, widthMul:1.08, ampMul:0.85 }; // desktop iets makkelijker

/* ================ Lagen — véél verder uit elkaar ================ */
const GROUND_Y   = 460;
const TROPO_TOP  = -6000;   // wolken start véél later → lang op aarde
const STRATO_TOP = -14000;  // vliegtuigen later
const SPACE_TOP  = -24000;  // sterren later
const DEEP_SPACE = -30000;  // planeten pas diep in space
const HEAVEN_TOP = -36000;  // hemel begint
const BEYOND_HEAVEN = -41000; // variatie na poort
const BIG_COIN_Y = HEAVEN_TOP - 8000; // grote coin véél later in heaven

/* ================ Fysica/Speler ================ */
const GRAV=1600, JUMP=DIFF.jump, COYOTE=0.12;
let player={x:0,y:0,r:36,vy:0,onGround:false,coyote:0};
let groundPlat=null, camY=0, meters=0; const hud=document.getElementById('hud');

/* ================ Platforms ================ */
let idSeq=1; const newId=()=>idSeq++;
let currentPlat=null, nextPlat=null;

const GAP_BASE=DIFF.gapBase, GAP_VAR=DIFF.gapVar;

function platformSpecForAlt(y){
  const wMul=DIFF.widthMul;
  if(y > TROPO_TOP)  return {type:'wood',        w:Math.max(160,W*0.28)*wMul, h:24};  // Aarde
  if(y > STRATO_TOP) return {type:'cloud',       w:Math.max(190,W*0.32)*wMul, h:30};  // Wolken
  if(y > SPACE_TOP)  return {type:'plane',       w:Math.max(205,W*0.36)*wMul, h:34};  // Vliegtuig
  if(y > HEAVEN_TOP) return {type:'rocket',      w:Math.max(175,W*0.30)*wMul, h:32};  // Ruimte
  if(y > BEYOND_HEAVEN){
    const r=Math.random();
    if(r<0.4)  return {type:'heavenCloud', w:Math.max(210,W*0.36)*wMul, h:30};
    if(r<0.75) return {type:'goldBridge',  w:Math.max(220,W*0.40)*wMul, h:26};
    return {type:'haloRing', w:Math.max(180,W*0.30)*wMul, h:26};
  }
  const r=Math.random();
  if(r<0.33) return {type:'heavenCloud', w:Math.max(220,W*0.38)*wMul, h:30};
  if(r<0.66) return {type:'goldBridge',  w:Math.max(240,W*0.42)*wMul, h:26};
  return {type:'haloRing', w:Math.max(200,W*0.34)*wMul, h:26};
}
function makePlatform(x,y,isBase=false){
  const s=platformSpecForAlt(y);
  const amp=isBase?0:(W/2-80)*DIFF.ampMul, speed=isBase?0:(isMobile?0.75:0.9)*DIFF.ampMul;
  return {id:newId(), x0:x, y, w:s.w, h:s.h, type:s.type, amp, speed, phase:Math.random()*6.28, isBase, lastX:x};
}
const platX=p=>p.x0+Math.sin(p.phase)*p.amp, platTop=p=>p.y-p.h/2;
function spawnNextAbove(ref){
  const alt=-ref.y;
  const diff=Math.min(220, Math.max(0, alt/16));
  const gap=GAP_BASE + Math.min(GAP_VAR, diff);
  const y = ref.y - (gap+Math.random()*20);
  return makePlatform(W/2, y, false);
}

/* ================ Input ================ */
function jump(){ if(player.onGround||player.coyote>0){ player.vy=JUMP; player.onGround=false; player.coyote=0; groundPlat=null; } }
addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();jump();}});
addEventListener('pointerdown',jump);

/* ================ Wereldobjecten ================ */
const env={
  t:0,
  hills:null, trees:null, city:[],
  birds:[], groundClouds:[],
  clouds:[], planes:[],
  stars:[], moon:null, planets:[],
  bigCoin:{x:0,y:BIG_COIN_Y,r:230},
  heavenGate:{x:0,y:HEAVEN_TOP-260,w:540,h:490},
  heavenCoins:[],
  rebuild(){
    // Aarde
    this.hills = makeHillsBand(GROUND_Y+130,'#203331',0.55);
    this.trees = makeTreeLineBand(GROUND_Y+70,'#1a2a28');
    this.city  = makeCityBand(GROUND_Y+50,['#24353a','#1a2a2e']);

    // Vogels
    this.birds=[]; for(let i=0;i<12;i++) this.birds.push(makeBird(GROUND_Y - rnd(140,320)));

    // Verre aardwolken
    this.groundClouds=[];
    for(let i=0;i<16;i++){
      const y=rnd(GROUND_Y - H*0.95, GROUND_Y - H*0.6);
      this.groundClouds.push({x:Math.random()*W,y,w:rnd(140,260),h:rnd(50,100),s:rnd(0.01,0.03)});
    }

    // Wolkenlaag
    this.clouds=[];
    for(let i=0;i<50;i++){
      const y=rnd(TROPO_TOP-1800, -120);
      this.clouds.push({x:Math.random()*W,y,w:rnd(180,360),h:rnd(70,140),s:rnd(0.02,0.07)});
    }

    // Achtergrond-vliegtuigen (subtieler & trager)
    this.planes=[];
    for(let i=0;i<8;i++){
      this.planes.push(makePlane(rnd(STRATO_TOP-1900, TROPO_TOP-380)));
    }

    // Sterren
    this.stars=[];
    for(let i=0;i<340;i++){
      this.stars.push({x:Math.random()*W,y:rnd(SPACE_TOP-2600, SPACE_TOP-200),r:Math.random()*1.2+0.3,tw:Math.random()*6.28});
    }

    // Maan
    this.moon = makeMoon(rnd(SPACE_TOP-1300, SPACE_TOP-700), rnd(W*0.25, W*0.75), rnd(34,58));

    // Planeten (diep)
    this.planets=[];
    for(let i=0;i<3;i++){
      this.planets.push(makePlanet(rnd(DEEP_SPACE-2600, DEEP_SPACE-800)));
    }

    // Heaven coins rond poort
    this.heavenCoins=[];
    const gate=this.heavenGate;
    for(let i=0;i<28;i++){
      const ang=(i/28)*Math.PI*2;
      const rx=gate.w*0.48+rnd(-20,20), ry=gate.h*0.36+rnd(-20,20);
      const cx=W*0.5+Math.cos(ang)*rx+rnd(-12,12);
      const cy=gate.y+gate.h*0.05+Math.sin(ang)*ry+rnd(-12,12);
      this.heavenCoins.push({x:cx,y:cy,r:rnd(12,18),phase:Math.random()*6.28,vy:rnd(-10,-6)});
    }

    this.t=0;
  },
  update(dt){
    this.t+=dt;
    for(const b of this.birds){
      b.x+=b.vx*dt; b.y+=Math.sin(this.t*1.8+b.phase)*0.25;
      if(b.x>W+40){b.x=-40; b.y=GROUND_Y - rnd(140,320);}
    }
    for(const c of this.groundClouds){ c.x-=8*c.s*dt; if(c.x<-c.w) c.x=W+c.w*0.5; }
    for(const c of this.clouds){ c.x-=8*c.s*dt; if(c.x<-c.w) c.x=W+c.w*0.5; }
    for(const p of this.planes){
      p.x += p.vx*dt; p.trail=Math.max(0,Math.min(1,p.trail+dt*0.06));
      if(p.vx>0 && p.x>W+140){p.x=-140;p.y+=rnd(-80,80);}
      if(p.vx<0 && p.x<-140){p.x=W+140;p.y+=rnd(-80,80);}
    }
    for(const c of this.heavenCoins){
      c.y += c.vy*dt + Math.sin(this.t*1.5 + c.phase)*0.2;
      c.x += Math.cos(this.t*0.8 + c.phase)*0.1;
    }
  }
};

/* ---------- Aarde helpers ---------- */
function makeHillsBand(yBase,color,amp){
  const pts=[], nPts=6;
  for(let i=0;i<=nPts;i++){ pts.push({x:i/nPts*W, y:yBase + Math.sin(i*0.7)*60*amp}); }
  return {y:yBase, pts, color, speed:20};
}
function drawHillsBand(h){
  ctx.save(); ctx.fillStyle=h.color;
  const shift=(env.t*h.speed)%W; ctx.translate(-shift,0);
  for(let k=0;k<2;k++){
    ctx.beginPath(); ctx.moveTo(-W+k*W, h.y+320);
    for(const p of h.pts) ctx.lineTo(p.x+k*W, p.y);
    ctx.lineTo(W+k*W, h.y+320); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}
function makeTreeLineBand(yBase,color){
  const trees=[]; let x=0;
  while(x<W+60){
    const w=rnd(12,26), h=rnd(40,80);
    trees.push({x,y:yBase-h,w,h}); x+=w+rnd(8,18);
  }
  return {y:yBase, trees, color, speed:28};
}
function drawTreeLineBand(tl){
  ctx.save(); ctx.fillStyle=tl.color;
  const shift=(env.t*tl.speed)%W; ctx.translate(-shift,0);
  for(let k=0;k<3;k++){
    for(const t of tl.trees){
      const X=t.x+k*(W+100), Y=t.y, Wd=t.w, Hd=t.h;
      ctx.fillRect(X+Wd*0.45, Y+Hd*0.6, Wd*0.1, Hd*0.4);
      ctx.beginPath(); ctx.moveTo(X+Wd*0.5, Y);
      ctx.lineTo(X+Wd, Y+Hd*0.7); ctx.lineTo(X, Y+Hd*0.7);
      ctx.closePath(); ctx.fill();
    }
  }
  ctx.restore();
}
function makeCityBand(yBase, colors){
  const layer=(speed,color)=>{
    const buildings=[]; let x=0;
    while(x<W+140){ const w=rnd(60,120), h=rnd(80,170);
      buildings.push({x,y:yBase-h,w,h,roof:Math.random()<.3,color}); x+=w+rnd(16,28);
    }
    return {y:yBase, speed, color, buildings};
  };
  return [layer(20,colors[0]), layer(32,colors[1])];
}
function drawCityBand(l){
  ctx.save();
  const shift=(env.t*l.speed)%(W+140); ctx.translate(-shift,0);
  for(let k=0;k<2;k++) for(const b of l.buildings){
    const X=b.x+k*(W+140), Y=b.y, Wd=b.w, Hd=b.h;
    ctx.fillStyle=b.color; ctx.fillRect(X,Y,Wd,Hd);
    if(b.roof){ ctx.beginPath(); ctx.moveTo(X,Y); ctx.lineTo(X+Wd/2,Y-10); ctx.lineTo(X+Wd,Y); ctx.closePath(); ctx.fill(); }
    const cols=Math.max(2,Math.floor(Wd/20)), rows=Math.max(2,Math.floor(Hd/28));
    ctx.fillStyle='rgba(255,214,115,0.6)';
    for(let i=0;i<cols;i++) for(let j=0;j<rows;j++) if(Math.random()<.08){
      ctx.fillRect(X+6+i*(Wd-12)/cols, Y+6+j*(Hd-12)/rows, 5, 8);
    }
  }
  ctx.restore();
}

/* ---------- Dieren & wolken ---------- */
function makeBird(y){ return {x:rnd(-200,W), y, vx:rnd(25,45), phase:Math.random()*6.28}; }
function drawBird(b){
  ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(b.x-6,b.y); ctx.quadraticCurveTo(b.x,b.y-4,b.x+6,b.y); ctx.stroke();
}
function drawCloud(c){
  ctx.fillStyle='rgba(255,255,255,.96)';
  ctx.beginPath(); ctx.ellipse(c.x,c.y,c.w,c.h,0,0,Math.PI*2); ctx.fill();
  ctx.save();
  const sh=ctx.createLinearGradient(c.x,c.y,c.x,c.y+c.h*0.9);
  sh.addColorStop(0,'rgba(0,0,0,0)'); sh.addColorStop(1,'rgba(0,0,0,0.08)');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.ellipse(c.x,c.y+c.h*0.15,c.w*0.9,c.h*0.9,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.globalAlpha=.7; ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.ellipse(c.x,c.y-c.h*0.15,c.w*0.95,c.h*0.65,0,0,Math.PI*2); ctx.stroke();
  ctx.globalAlpha=1;
}

/* ---------- Platforms ---------- */
function drawPlatform(p){
  const x=platX(p), y=p.y, w=p.w, h=p.h;
  if(p.type==='wood')        drawWood(x,y,w,h);
  else if(p.type==='cloud')  drawCloudPlat(x,y,w,h);
  else if(p.type==='plane')  drawPlanePlat(x,y,w,h);
  else if(p.type==='rocket') drawRocketPlat(x,y,w,h);
  else if(p.type==='goldBridge') drawGoldBridgePlat(x,y,w,h);
  else if(p.type==='haloRing')   drawHaloRingPlat(x,y,w,h);
  else                          drawHeavenCloudPlat(x,y,w,h); // heavenCloud
}

/* Hout: planken + spijkers */
function rrPath(x,y,w,h,r=8){
  const hw=w/2, hh=h/2;
  ctx.beginPath();
  ctx.moveTo(x-hw+r,y-hh); ctx.lineTo(x+hw-r,y-hh);
  ctx.quadraticCurveTo(x+hw,y-hh,x+hw,y-hh+r);
  ctx.lineTo(x+hw,y+hh-r);
  ctx.quadraticCurveTo(x+hw,y+hh,x+hw-r,y+hh);
  ctx.lineTo(x-hw+r,y+hh);
  ctx.quadraticCurveTo(x-hw,y+hh,x-hw,y+hh-r);
  ctx.lineTo(x-hw,y-hh+r);
  ctx.quadraticCurveTo(x-hw,y-hh,x-hw+r,y-hh);
  ctx.closePath();
}
function drawWood(x,y,w,h){
  const th=h*1.08;
  const sg=ctx.createLinearGradient(x,y,x,y+th); sg.addColorStop(0,'#6f3f19'); sg.addColorStop(1,'#3e220f');
  ctx.fillStyle=sg; rrPath(x,y+th,w,h,10); ctx.fill();
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2); g.addColorStop(0,'#c8924f'); g.addColorStop(1,'#8b592b');
  ctx.fillStyle=g; rrPath(x,y,w,h,10); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.28)'; ctx.lineWidth=1.5;
  const planks=4; for(let i=1;i<planks;i++){ const px=x-w/2 + (w/planks)*i; ctx.beginPath(); ctx.moveTo(px,y-h/2+4); ctx.lineTo(px,y+h/2-4); ctx.stroke(); }
  ctx.fillStyle='rgba(255,255,255,.35)';
  for(let i=0;i<planks;i++){
    const px=x-w/2 + (w/planks)*(i+0.5);
    ctx.beginPath(); ctx.arc(px, y-h*0.28, 1.8, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(px, y+h*0.28, 1.8, 0, Math.PI*2); ctx.fill();
  }
}

/* Wolk-platform */
function drawCloudPlat(x,y,w,h){
  const lobes=7, r=h*0.95, step=w/(lobes+1);
  ctx.save();
  for(let i=0;i<lobes;i++){
    const cx=x-w/2+step*(i+1), ry=r*(0.6+0.22*Math.sin(i*1.7));
    ctx.fillStyle='rgba(255,255,255,.99)';
    ctx.beginPath(); ctx.ellipse(cx,y,r,ry,0,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=.25; ctx.fillStyle='#6ea3d6';
  ctx.beginPath(); ctx.ellipse(x, y+h*.34, w*.58, h*.74, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=.7; ctx.strokeStyle='rgba(255,255,255,.97)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.ellipse(x, y-h*0.28, w*0.92, h*0.72, 0, 0, Math.PI*2); ctx.stroke();
  ctx.restore();
}

/* Vliegtuig-platform (speelbaar) */
function roundRect(x,y,w,h,r){
  const x2=x+w,y2=y+h; r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x2,y,x2,y+r,r);
  ctx.arcTo(x2,y2,x2-r,y2,r);
  ctx.arcTo(x,y2,x,y2-r,r);
  ctx.arcTo(x,y,x+r,y,r);
  ctx.closePath();
}
function drawPlanePlat(x,y,w,h){
  ctx.save();
  const fusGrad=ctx.createLinearGradient(x,y-h/2,x,y+h/2);
  fusGrad.addColorStop(0,'#f3f8ff'); fusGrad.addColorStop(1,'#c9d9f6');
  ctx.fillStyle=fusGrad; roundRect(x-w/2, y-h/2, w, h, h*0.5); ctx.fill();
  ctx.fillStyle='#b9cbed'; roundRect(x-w*0.62, y-h*0.20, w*1.24, h*0.40, 10); ctx.fill();
  roundRect(x-w*0.34, y+h*0.14, w*0.68, h*0.22, 10); ctx.fill();
  ctx.fillStyle='#a4b8d8';
  const engW=Math.max(16, w*0.08), engH=h*0.36;
  roundRect(x-w*0.28-engW/2, y+h*0.02, engW, engH, 6); ctx.fill();
  roundRect(x+w*0.28-engW/2, y+h*0.02, engW, engH, 6); ctx.fill();
  ctx.fillStyle='#5fa3e3'; roundRect(x-w*0.15, y-h*0.36, w*0.30, h*0.24, 6); ctx.fill();
  ctx.fillStyle='#8fc3ff';
  const n=7; for(let i=0;i<n;i++){ ctx.beginPath(); ctx.arc(x-w*0.32+i*(w*0.64/(n-1)), y, 4.2,0,Math.PI*2); ctx.fill(); }
  ctx.strokeStyle='rgba(0,0,0,.12)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(x-w*0.46,y); ctx.lineTo(x+w*0.46,y); ctx.stroke();
  ctx.restore();
}

/* Raket-platform */
function drawRocketPlat(x,y,w,h){
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2);
  g.addColorStop(0,'#eeeeee'); g.addColorStop(1,'#9aa2ad');
  ctx.fillStyle=g; roundRect(x-w/2, y-h/2, w, h, 10); ctx.fill();
  ctx.fillStyle='#8aa0b5';
  ctx.beginPath(); ctx.moveTo(x-w/2, y+h*0.15); ctx.lineTo(x-w/2-16, y+h*0.35); ctx.lineTo(x-w/2, y+h*0.35); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(x+w/2, y+h*0.15); ctx.lineTo(x+w/2+16, y+h*0.35); ctx.lineTo(x+w/2, y+h*0.35); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#4ab5ff';
  const n=5, step=w/(n+1);
  for(let i=1;i<=n;i++){ ctx.beginPath(); ctx.arc(x-w/2+step*i, y, 6, 0, Math.PI*2); ctx.fill(); }
  ctx.fillStyle='orange';
  ctx.beginPath(); ctx.moveTo(x-w*0.1, y+h/2); ctx.lineTo(x+w*0.1, y+h/2); ctx.lineTo(x, y+h/2+14); ctx.closePath(); ctx.fill();
}

/* Heaven wolk-platform */
function drawHeavenCloudPlat(x,y,w,h){
  const lobes=7, r=h*0.98, step=w/(lobes+1);
  ctx.save();
  for(let i=0;i<lobes;i++){
    const cx=x-w/2+step*(i+1), ry=r*(0.62+0.2*Math.sin(i*1.7));
    ctx.fillStyle='rgba(255,255,255,.99)';
    ctx.beginPath(); ctx.ellipse(cx,y,r,ry,0,0,Math.PI*2); ctx.fill();
  }
  const glow=ctx.createRadialGradient(x,y,8,x,y,Math.max(w,h));
  glow.addColorStop(0,'rgba(255,240,170,.38)'); glow.addColorStop(1,'rgba(255,240,170,0)');
  ctx.fillStyle=glow; ctx.fillRect(x-w, y-h*2, w*2, h*4);
  ctx.globalAlpha=.7; ctx.strokeStyle='rgba(255,255,210,0.95)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.ellipse(x, y-h*0.28, w*0.92, h*0.74, 0, 0, Math.PI*2); ctx.stroke();
  ctx.restore();
}

/* Gouden brug-segment (heaven variatie) */
function drawGoldBridgePlat(x,y,w,h){
  const deckGrad=ctx.createLinearGradient(x,y-h/2,x,y+h/2);
  deckGrad.addColorStop(0,'#ffe48f'); deckGrad.addColorStop(1,'#cfa33f');
  ctx.fillStyle=deckGrad; rrPath(x,y,w,h,12); ctx.fill();
  ctx.strokeStyle='rgba(255,230,160,0.8)'; ctx.lineWidth=6;
  ctx.beginPath(); ctx.moveTo(x-w*0.45, y+h*0.3);
  ctx.quadraticCurveTo(x, y+h*0.75, x+w*0.45, y+h*0.3); ctx.stroke();
  ctx.lineWidth=2.2; ctx.strokeStyle='rgba(255,240,200,0.9)';
  for(let t=0.15;t<0.86;t+=0.14){
    const px=x-w*0.45 + w*0.9*t;
    ctx.beginPath(); ctx.moveTo(px, y-h*0.5);
    ctx.quadraticCurveTo(px, y+h*0.1, px, y+h*0.3); ctx.stroke();
  }
}

/* Halo-ring platform (zwevend) */
function drawHaloRingPlat(x,y,w,h){
  const r=Math.min(w,h)*0.46;
  const glow=ctx.createRadialGradient(x,y,2,x,y,r*1.6);
  glow.addColorStop(0,'rgba(255,245,200,.35)'); glow.addColorStop(1,'rgba(255,245,200,0)');
  ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(x,y,r*1.6,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=6; ctx.strokeStyle='rgba(255,230,150,0.95)';
  ctx.beginPath(); ctx.ellipse(x,y,r,r*0.55,0,0,Math.PI*2); ctx.stroke();
}

/* ---------- Achtergrond: subtiele vliegtuigen ---------- */
function makePlane(y){
  const dir=Math.random()<0.5?-1:1;
  return {x:rnd(40,W-40), y, vx:dir*rnd(24,40), dir, trail:0, phase:Math.random()*6.28};
}
function drawPlane(p){
  // zeer subtiele condensstreep
  ctx.save();
  ctx.globalAlpha=0.18*p.trail;
  ctx.strokeStyle='#e8f2ff'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(p.x-38*p.dir, p.y+3); ctx.lineTo(p.x, p.y+3); ctx.stroke();
  // klein vliegtuig, iets geblurd & gedimd
  ctx.filter='blur(0.6px) brightness(0.92)';
  ctx.globalAlpha=0.35;
  const g=ctx.createLinearGradient(p.x,p.y-10,p.x,p.y+10);
  g.addColorStop(0,'#eff5ff'); g.addColorStop(1,'#c9d6ef');
  ctx.fillStyle=g; roundRect(p.x-18, p.y-10, 36, 20, 8); ctx.fill();
  ctx.fillStyle='#b7c8e6'; roundRect(p.x-32, p.y-6, 64, 12, 6); ctx.fill();
  ctx.fillStyle='#5fa3e3'; roundRect(p.x-6, p.y-8, 12, 7, 3); ctx.fill();
  ctx.filter='none';
  ctx.restore();
  ctx.globalAlpha=1;
}

/* Space: sterren/maan/planeten */
function makePlanet(y){ return {x:rnd(60,W-60), y, r:rnd(18,36), hue:rnd(180,360)}; }
function drawPlanet(p){
  const grad=ctx.createRadialGradient(p.x-p.r*0.5,p.y-p.r*0.5,p.r*0.2,p.x,p.y,p.r*1.1);
  grad.addColorStop(0,`hsl(${p.hue},60%,75%)`); grad.addColorStop(1,`hsl(${p.hue},60%,35%)`);
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=.28; ctx.strokeStyle='#fff'; ctx.lineWidth=1.6;
  ctx.beginPath(); ctx.ellipse(p.x,p.y+3,p.r*1.2,p.r*0.35,0,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
}
function makeMoon(y,x,r){ return {x,y,r}; }
function drawMoon(m){
  const g=ctx.createRadialGradient(m.x-m.r*0.3,m.y-m.r*0.3,m.r*0.2,m.x,m.y,m.r*1.1);
  g.addColorStop(0,'#ffffff'); g.addColorStop(1,'#c8c8d0');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(m.x,m.y,m.r,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(120,120,140,.35)';
  for(let i=0;i<6;i++){
    const ang=Math.random()*Math.PI*2, rr=rnd(m.r*0.1,m.r*0.22);
    const rx=m.x+Math.cos(ang)*rnd(0,m.r*0.55), ry=m.y+Math.sin(ang)*rnd(0,m.r*0.55);
    ctx.beginPath(); ctx.ellipse(rx,ry,rr,rr*0.7,ang,0,Math.PI*2); ctx.fill();
  }
}

/* ---------- Heaven: poort + coins + Big Coin ---------- */
function drawGoldenGate(g){
  const x=W*0.5, y=g.y, w=g.w, h=g.h;
  const glow=ctx.createRadialGradient(x, y+h*0.4, 10, x, y+h*0.4, Math.max(W,H)*0.65);
  glow.addColorStop(0,'rgba(255,223,130,0.18)'); glow.addColorStop(1,'rgba(255,223,130,0)');
  ctx.fillStyle=glow; ctx.fillRect(x-W, y-h, W*2, H*2);

  const colW=30, colR=10, lgCol=ctx.createLinearGradient(0,y,0,y+h);
  lgCol.addColorStop(0,'#ffd76a'); lgCol.addColorStop(1,'#caa03a');
  ctx.fillStyle=lgCol;
  roundRect(W*0.5-w*0.35, y, colW, h, colR); ctx.fill();
  roundRect(W*0.5+w*0.35-colW, y, colW, h, colR); ctx.fill();

  const archTop=y-h*0.06, archBot=y+h*0.56, gradArch=ctx.createLinearGradient(0,archTop,0,archBot);
  gradArch.addColorStop(0,'#ffe48f'); gradArch.addColorStop(1,'#cfa33f');
  ctx.strokeStyle=gradArch; ctx.lineWidth=14;
  ctx.beginPath(); ctx.moveTo(W*0.5-w*0.35+colW, archBot);
  ctx.quadraticCurveTo(W*0.5, archTop, W*0.5+w*0.35-colW, archBot); ctx.stroke();

  ctx.lineWidth=3; ctx.strokeStyle='rgba(255,236,170,0.7)';
  for(let t=0.1;t<0.9;t+=0.12){
    ctx.beginPath();
    const tx=W*0.5 - w*0.3 + t*w*0.6;
    ctx.moveTo(tx, archBot-6);
    ctx.quadraticCurveTo(W*0.5, archTop+12, W*0.5+(W*0.5-tx), archBot-6);
    ctx.stroke();
  }

  const baseY=y+h*0.63, sg=ctx.createLinearGradient(0,baseY,0,baseY+18);
  sg.addColorStop(0,'#e9e9ee'); sg.addColorStop(1,'#bdbdd2');
  ctx.fillStyle=sg; roundRect(W*0.5-(w*0.85)/2, baseY+9, w*0.85, 18, 10); ctx.fill();
}
function drawHeavenCoin(c){
  const g=ctx.createRadialGradient(c.x-c.r*.35,c.y-c.r*.35,c.r*.2,c.x,c.y,c.r*1.1);
  g.addColorStop(0,'#fff6c8'); g.addColorStop(0.55,'#f6d36a'); g.addColorStop(1,'#b78628');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.45)';
  ctx.beginPath(); ctx.arc(c.x,c.y,c.r-1,0,Math.PI*2); ctx.stroke();
  if(logo.complete){
    ctx.save(); ctx.beginPath(); ctx.arc(c.x,c.y,c.r-2,0,Math.PI*2); ctx.clip();
    ctx.drawImage(logo, c.x-(c.r-2), c.y-(c.r-2), (c.r-2)*2, (c.r-2)*2); ctx.restore();
  }
}
function drawBigCoinLight(bc){
  const x=W*0.5, y=bc.y, r=bc.r;
  const farGlow=ctx.createRadialGradient(x,y,60,x,y,Math.max(W,H)*0.95);
  farGlow.addColorStop(0,'rgba(255,245,160,0.12)'); farGlow.addColorStop(1,'rgba(255,245,160,0)');
  ctx.fillStyle=farGlow; ctx.fillRect(0, y-2*H, W, 4*H);

  const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.2,x,y,r*1.25);
  g.addColorStop(0,'#fffad0'); g.addColorStop(0.55,'#f9d66b'); g.addColorStop(1,'#c9972e');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=5; ctx.strokeStyle='rgba(255,255,255,.5)';
  ctx.beginPath(); ctx.arc(x,y,r-3,0,Math.PI*2); ctx.stroke();

  if(logo.complete){
    ctx.save(); ctx.beginPath(); ctx.arc(x,y,r-6,0,Math.PI*2); ctx.clip();
    ctx.drawImage(logo, x-(r-6), y-(r-6), (r-6)*2, (r-6)*2); ctx.restore();
  }
}

/* ---------- Hemelkleuren & overgangen ---------- */
function drawSky(){
  const alt=-camY;
  const EARTH_TOP=[114,198,255],  EARTH_BOT=[167,231,191];
  const CLOUD_TOP=[187,223,255],  CLOUD_BOT=[142,198,255];
  const MID_TOP=[60,110,170],     MID_BOT=[20,40,70];
  const SPACE_TOPC=[11,14,42],    SPACE_BOTC=[0,0,5];
  const HEAVEN_TOPC=[244,236,255],HEAVEN_BOTC=[217,204,255];

  function seg(a,b){return {a,b,length:(b-a)}}
  const sEarth=seg(-200, -TROPO_TOP);
  const sMid  =seg(-TROPO_TOP, -SPACE_TOP);
  const sSpace=seg(-SPACE_TOP, -HEAVEN_TOP);
  const sHeav =seg(-HEAVEN_TOP, 8000);

  let topCol,botCol;
  if(alt<=sEarth.a){ topCol=EARTH_TOP; botCol=EARTH_BOT; }
  else if(alt<sEarth.b){ topCol=EARTH_TOP; botCol=EARTH_BOT; }
  else if(alt<sMid.b){
    const t=(alt - sEarth.b)/sMid.length;
    topCol=[Math.round(CLOUD_TOP[0]*(1-t)+MID_TOP[0]*t),
            Math.round(CLOUD_TOP[1]*(1-t)+MID_TOP[1]*t),
            Math.round(CLOUD_TOP[2]*(1-t)+MID_TOP[2]*t)];
    botCol=[Math.round(CLOUD_BOT[0]*(1-t)+MID_BOT[0]*t),
            Math.round(CLOUD_BOT[1]*(1-t)+MID_BOT[1]*t),
            Math.round(CLOUD_BOT[2]*(1-t)+MID_BOT[2]*t)];
  } else if(alt<sSpace.b){
    const t=(alt - sMid.b)/sSpace.length;
    topCol=[Math.round(MID_TOP[0]*(1-t)+SPACE_TOPC[0]*t),
            Math.round(MID_TOP[1]*(1-t)+SPACE_TOPC[1]*t),
            Math.round(MID_TOP[2]*(1-t)+SPACE_TOPC[2]*t)];
    botCol=[Math.round(MID_BOT[0]*(1-t)+SPACE_BOTC[0]*t),
            Math.round(MID_BOT[1]*(1-t)+SPACE_BOTC[1]*t),
            Math.round(MID_BOT[2]*(1-t)+SPACE_BOTC[2]*t)];
  } else {
    const t=Math.min(1,(alt - sSpace.b)/sHeav.length);
    topCol=[Math.round(SPACE_TOPC[0]*(1-t)+HEAVEN_TOPC[0]*t),
            Math.round(SPACE_TOPC[1]*(1-t)+HEAVEN_TOPC[1]*t),
            Math.round(SPACE_TOPC[2]*(1-t)+HEAVEN_TOPC[2]*t)];
    botCol=[Math.round(SPACE_BOTC[0]*(1-t)+HEAVEN_BOTC[0]*t),
            Math.round(SPACE_BOTC[1]*(1-t)+HEAVEN_BOTC[1]*t),
            Math.round(SPACE_BOTC[2]*(1-t)+HEAVEN_BOTC[2]*t)];
  }

  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,`rgb(${topCol[0]},${topCol[1]},${topCol[2]})`);
  g.addColorStop(1,`rgb(${botCol[0]},${botCol[1]},${botCol[2]})`);
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // hemelse lichtstralen al voor heaven
  if(alt > -HEAVEN_TOP - 2000){
    const near=Math.min(1,(alt + HEAVEN_TOP + 2000)/2000);
    const alpha=0.04 + 0.18*near;
    const cx=W*.5, cy=H*.2;
    for(let i=0;i<4;i++){
      const ang=i/4*Math.PI*2 + env.t*.04;
      const x2=cx+Math.cos(ang)*W*.9, y2=cy+Math.sin(ang)*H*.9;
      const lg=ctx.createLinearGradient(cx,cy,x2,y2);
      lg.addColorStop(0,`rgba(255,255,255,${alpha})`); lg.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=lg; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x2,y2);
      ctx.lineTo(cx+Math.cos(ang+.12)*W*.6, cy+Math.sin(ang+.12)*H*.6); ctx.closePath(); ctx.fill();
    }
  }
}

/* ---------- Tekenwereld ---------- */
function inView(y,pad=200){return y>camY-pad && y<camY+H+pad;}

function drawWorld(){
  drawSky();
  ctx.save(); ctx.translate(0,-camY);

  // Aarde
  if(inView(GROUND_Y)){
    ctx.fillStyle='#2a4a2f'; ctx.fillRect(0, GROUND_Y+10, W, 80);
    drawHillsBand(env.hills);
    for(const l of env.city) drawCityBand(l);
    drawTreeLineBand(env.trees);
    for(const b of env.birds) if(inView(b.y,0)) drawBird(b);
    for(const c of env.groundClouds) if(inView(c.y)) drawCloud(c);
  }

  // Wolken
  for(const c of env.clouds) if(inView(c.y)) drawCloud(c);

  // Strato (subtiele vliegtuigen)
  for(const p of env.planes) if(inView(p.y)) drawPlane(p);

  // Space
  if(camY < SPACE_TOP + H){
    const alt=-camY;
    const starAlpha=Math.min(1, Math.max(0,(alt + SPACE_TOP)/(-SPACE_TOP + STRATO_TOP)));
    for(const s of env.stars){
      if(inView(s.y,0)){
        const tw=0.4 + 0.6*(0.5+0.5*Math.sin(env.t*2 + s.tw));
        ctx.globalAlpha=starAlpha*(0.18 + 0.6*tw);
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fillStyle='#cfe6ff'; ctx.fill();
        ctx.globalAlpha=1;
      }
    }
    if(env.moon && inView(env.moon.y,200)) drawMoon(env.moon);
    if(camY < DEEP_SPACE + H) for(const p of env.planets) if(inView(p.y)) drawPlanet(p);
  }

  // Grote licht-coin (veel later)
  if(inView(env.bigCoin.y, H*2)) drawBigCoinLight(env.bigCoin);

  // Poort + coins (heaven)
  if(camY < HEAVEN_TOP + H){
    drawGoldenGate(env.heavenGate);
    for(const c of env.heavenCoins) if(inView(c.y,50)) drawHeavenCoin(c);
  }

  ctx.restore();
}

/* ---------- Botsing ---------- */
function tryLandOn(p,dt){
  if(!p) return false;
  if(groundPlat && groundPlat.id===p.id) return false;
  const px=platX(p), marginX=player.r*.25;
  if(player.x < px-p.w/2 - marginX || player.x > px+p.w/2 + marginX) return false;
  const top=platTop(p), prevBottom=(player.y - player.vy*dt) + player.r, nowBottom=player.y + player.r, TOL=4;
  if(player.vy>0 && prevBottom<=top+TOL && nowBottom>=top-TOL){
    player.y=top-player.r; player.vy=0; player.onGround=true; groundPlat=p; return true;
  }
  return false;
}

/* ================ Lifecycle & Loop ================ */
function startRun(){
  player.r=Math.max(26,Math.min(42,H*0.04));
  currentPlat=makePlatform(W/2, GROUND_Y-8, true);
  currentPlat.lastX=platX(currentPlat);
  player.x=W/2; player.y=platTop(currentPlat)-player.r;
  player.vy=0; player.onGround=true; player.coyote=0; groundPlat=currentPlat;
  nextPlat=spawnNextAbove(currentPlat); nextPlat.lastX=platX(nextPlat);
  camY=0; meters=0; hud.textContent='0 m';
  env.rebuild();
}
resize(); startRun();

let last=performance.now();
function loop(now){
  let dt=(now-last)/1000; last=now; if(dt>0.05) dt=0.05;
  env.update(dt);

  const fixed=0.008, steps=Math.max(1,Math.ceil(dt/fixed)), h=dt/steps;
  for(let i=0;i<steps;i++){
    const prevXc=currentPlat?currentPlat.lastX:0, prevXn=nextPlat?nextPlat.lastX:0;
    if(nextPlat&&!nextPlat.isBase) nextPlat.phase+=nextPlat.speed*h;
    if(currentPlat&&!currentPlat.isBase) currentPlat.phase+=currentPlat.speed*h;
    if(currentPlat) currentPlat.lastX=platX(currentPlat); if(nextPlat) nextPlat.lastX=platX(nextPlat);
    const dxc=currentPlat?(currentPlat.lastX-prevXc):0, dxn=nextPlat?(nextPlat.lastX-prevXn):0;

    if(groundPlat){
      const dx=(groundPlat.id===currentPlat?.id)?dxc:(groundPlat.id===nextPlat?.id?dxn:0);
      player.x=Math.max(player.r,Math.min(W-player.r,player.x+dx));
      player.y=platTop(groundPlat)-player.r; player.vy=Math.max(0,player.vy);
      player.onGround=true; player.coyote=COYOTE;
    }else{
      player.vy+=GRAV*h; player.y+=player.vy*h; player.coyote=Math.max(0,player.coyote-h); player.onGround=false;
      const landed=tryLandOn(nextPlat,h) || tryLandOn(currentPlat,h);
      if(landed){
        if(groundPlat && groundPlat.id===nextPlat?.id){
          currentPlat=nextPlat; nextPlat=spawnNextAbove(currentPlat); nextPlat.lastX=platX(nextPlat);
        }
      }
    }
  }

  if(player.y<camY+H*0.45) camY=player.y-H*0.45;
  if(player.y-camY>H+240) startRun();

  const m=Math.max(0,Math.floor((-player.y + GROUND_Y)/6));
  if(m!==meters){ meters=m; hud.textContent=m+" m"; }

  ctx.clearRect(0,0,W,H);
  drawWorld();

  ctx.save(); ctx.translate(0,-camY);
  if(currentPlat && inView(currentPlat.y)) drawPlatform(currentPlat);
  if(nextPlat    && inView(nextPlat.y))    drawPlatform(nextPlat);
  // Speler (CBS coin)
  const x=player.x,y=player.y,r=player.r;
  const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.2,x,y,r*1.15);
  g.addColorStop(0,'#fff6c8'); g.addColorStop(0.55,'#f6d36a'); g.addColorStop(1,'#b78628');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,.5)';
  ctx.beginPath(); ctx.arc(x,y,r-2,0,Math.PI*2); ctx.stroke();
  if(logo.complete){ ctx.save(); ctx.beginPath(); ctx.arc(x,y,r-3,0,Math.PI*2); ctx.clip(); ctx.drawImage(logo, x-r, y-r, r*2, r*2); ctx.restore(); }
  ctx.restore();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ================ Utils ================ */
function rnd(a,b){return a+Math.random()*(b-a)}
</script>
</body>
</html>
