<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CBS Jump — Lagen & Thematische Platformen</title>
<style>
  html,body{margin:0;height:100%;background:#0b0f18;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh}
  .hud{
    position:fixed;top:10px;left:50%;transform:translateX(-50%);
    color:#fff;font:700 20px system-ui,sans-serif;text-shadow:0 2px 4px rgba(0,0,0,.6);pointer-events:none
  }
  .audio-ui{
    position:fixed;top:10px;right:10px;display:flex;gap:8px;align-items:center;
    background:rgba(0,0,0,.35);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.15); padding:8px 10px; border-radius:12px;
    color:#fff;font:600 13px system-ui,sans-serif
  }
  .audio-btn{
    appearance:none;border:0;border-radius:10px;padding:6px 10px;cursor:pointer;
    background:#1f2937;color:#fff;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.35)
  }
  .audio-btn:active{transform:translateY(1px)}
  .vol{width:110px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud" class="hud">0 m</div>

<!-- Muziek UI -->
<div class="audio-ui">
  <button id="toggleAudio" class="audio-btn">▶︎ Play</button>
  <label>Vol.</label>
  <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="0.5"/>
  <span id="audioStatus" style="opacity:.8">klaar</span>
</div>

<script>
/* ========== Audio (Pinata CID) ========== */
const AUDIO_URL = 'https://gateway.pinata.cloud/ipfs/bafybeif7okyipwq3m5fus33fpbxyd5byftb62m72xz4vvwkyf4cng6k2bq';
const audio = new Audio(AUDIO_URL);
audio.loop = true; audio.preload = 'auto';
audio.volume = parseFloat(localStorage.getItem('cbs_audio_vol')||'0.5');
let audioReady=false, audioPlaying=false;
const btn=document.getElementById('toggleAudio'), vol=document.getElementById('vol'), aStatus=document.getElementById('audioStatus');
vol.value = audio.volume.toString();
audio.addEventListener('canplaythrough',()=>{audioReady=true;aStatus.textContent='gereed';});
audio.addEventListener('error',()=>{aStatus.textContent='audio laadfout';});
async function safePlay(){try{await audio.play();audioPlaying=true;btn.textContent='⏸ Pause';aStatus.textContent='speelt';}catch(e){aStatus.textContent='tap om te spelen';}}
btn.addEventListener('click', async ()=>{ if(!audioReady){aStatus.textContent='laden…';return;} if(audioPlaying){audio.pause();audioPlaying=false;btn.textContent='▶︎ Play';aStatus.textContent='gepauzeerd';} else {await safePlay();}});
vol.addEventListener('input', ()=>{audio.volume=parseFloat(vol.value);localStorage.setItem('cbs_audio_vol',audio.volume.toString());});
['pointerdown','keydown'].forEach(evt=>{addEventListener(evt, async ()=>{if(audioReady&&!audioPlaying){await safePlay();}}, {once:false});});

/* ========== Canvas (HiDPI) ========== */
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
let W=0,H=0, DPR=1;
function resize(){
  DPR = Math.max(1, Math.min(2, devicePixelRatio || 1));
  W = innerWidth; H = innerHeight;
  canvas.width = Math.floor(W * DPR);
  canvas.height = Math.floor(H * DPR);
  canvas.style.width = W+'px'; canvas.style.height = H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);

/* ========== Assets ========== */
const logo=new Image(); logo.src='logo.png';
const isMobile=/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ========== Wereld-banden (wereld-Y; omhoog = negatief) ========== */
const GROUND_Y     = 380;     // grondlijn
const TROPO_TOP    = -800;    // wolkenlaag (blauwe lucht boven de wolken)
const STRATO_TOP   = -2200;   // vliegtuigen
const SPACE_TOP    = -4200;   // ruimte (bijna zwart + sterren)
const HEAVEN_TOP   = -6500;   // hemel (licht begint te stralen)
const BIG_COIN_Y   = HEAVEN_TOP - 300; // grote stralende CBS-coin

/* ========== Player/Physics ========== */
const GRAV=1600, JUMP=isMobile?-980:-1020, COYOTE=0.12;
let player={x:0,y:0,r:36,vy:0,onGround:false,coyote:0};
let groundPlat=null, camY=0, meters=0; const hud=document.getElementById('hud');

/* ========== Platforms ========== */
let idSeq=1; const newId=()=>idSeq++;
let currentPlat=null, nextPlat=null;
const GAP_BASE=180, GAP_VAR=50;

function platformSpecForAlt(y){
  // y: groter = lager (aarde). Lager (meer negatief) = hoger.
  if(y > TROPO_TOP)  return {type:'wood',        w:Math.max(150,W*0.26), h:22};  // Aarde
  if(y > STRATO_TOP) return {type:'cloud',       w:Math.max(180,W*0.30), h:26};  // Wolkenlaag
  if(y > SPACE_TOP)  return {type:'plane',       w:Math.max(180,W*0.32), h:30};  // Strato (vliegtuig)
  if(y > HEAVEN_TOP) return {type:'rocket',      w:Math.max(150,W*0.25), h:28};  // Ruimte (raket)
  return                 {type:'heavenCloud', w:Math.max(190,W*0.34), h:28};      // Heaven (glow-wolk)
}
function makePlatform(x,y,isBase=false){
  const s=platformSpecForAlt(y);
  const amp=isBase?0:(W/2-60), speed=isBase?0:(isMobile?0.9:1.05);
  return {id:newId(), x0:x, y, w:s.w, h:s.h, type:s.type, amp, speed, phase:Math.random()*6.28, isBase, lastX:x};
}
const platX=p=>p.x0+Math.sin(p.phase)*p.amp, platTop=p=>p.y-p.h/2;
function spawnNextAbove(ref){
  const alt=-ref.y;
  const diff=Math.min(220, Math.max(0, alt/10));
  const gap=GAP_BASE + Math.min(GAP_VAR, diff);
  const y = ref.y - (gap+Math.random()*20);
  return makePlatform(W/2, y, false);
}

/* ========== Input ========== */
function jump(){
  if(player.onGround||player.coyote>0){
    player.vy=JUMP; player.onGround=false; player.coyote=0; groundPlat=null;
  }
}
addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();jump();}});
addEventListener('pointerdown',jump);

/* ========== Wereld-objecten (ALLEMAAL in wereld-Y) ========== */
const env = {
  t:0,
  // Earth
  hills:null, trees:null, city:[],
  birds:[],
  groundClouds:[],
  // Troposphere / Strato
  clouds:[], planes:[],
  // Space / Heaven
  stars:[], planets:[],
  bigCoin:{x:0,y:BIG_COIN_Y,r:180},
  heavenGate:{x:0,y:HEAVEN_TOP-200,w:420,h:380},
  heavenCoins:[],
  rebuild(){
    // Aarde
    this.hills = makeHillsBand(GROUND_Y+120, '#203331', 0.55);
    this.trees = makeTreeLineBand(GROUND_Y+60, '#1a2a28');
    this.city  = makeCityBand(GROUND_Y+40, ['#24353a','#1a2a2e']);

    // Vogels
    this.birds=[]; for(let i=0;i<7;i++) this.birds.push(makeBird(GROUND_Y - rnd(140,300)));

    // Verre aard-wolken (hoog in aardhemel)
    this.groundClouds=[];
    for(let i=0;i<10;i++){
      const y=rnd(GROUND_Y - H*0.9, GROUND_Y - H*0.6);
      this.groundClouds.push({x:Math.random()*W, y, w:rnd(140,240), h:rnd(50,90), s:rnd(0.01,0.03)});
    }

    // Wolken (troposfeer)
    this.clouds = [];
    for(let i=0;i<28;i++){
      const y=rnd(TROPO_TOP-800, -60);
      this.clouds.push({x:Math.random()*W, y, w:rnd(160,300), h:rnd(60,110), s:rnd(0.02,0.07)});
    }

    // Vliegtuigen (strato)
    this.planes=[];
    for(let i=0;i<8;i++){
      this.planes.push(makePlane(rnd(STRATO_TOP-1000, TROPO_TOP-200)));
    }

    // Space
    this.stars=[]; 
    for(let i=0;i<180;i++){
      this.stars.push({x:Math.random()*W, y:rnd(HEAVEN_TOP-1200, SPACE_TOP-200), r:Math.random()*1.3+0.3, tw:Math.random()*6.28});
    }
    this.planets=[];
    for(let i=0;i<3;i++){
      this.planets.push(makePlanet(rnd(SPACE_TOP-1200, STRATO_TOP-400)));
    }

    // Heaven coins rond de poort
    this.heavenCoins=[];
    const gate = this.heavenGate;
    for(let i=0;i<24;i++){
      const ang = (i/24)*Math.PI*2;
      const radX = gate.w*0.45 + rnd(-20,20);
      const radY = gate.h*0.35 + rnd(-20,20);
      const cx = (W*0.5) + Math.cos(ang)*radX + rnd(-12,12);
      const cy = gate.y + gate.h*0.05 + Math.sin(ang)*radY + rnd(-12,12);
      this.heavenCoins.push({x:cx,y:cy,r:rnd(12,18),phase:Math.random()*6.28,vy:rnd(-12,-6)});
    }

    this.t=0;
  },
  update(dt){
    this.t+=dt;

    // vogels
    for(const b of this.birds){
      b.x += b.vx*dt;
      b.y += Math.sin(this.t*1.8 + b.phase)*0.25;
      if(b.x>W+40){b.x=-40; b.y=GROUND_Y - rnd(140,300);}
    }

    // wolken op aarde
    for(const c of this.groundClouds){ c.x-=8*c.s*dt; if(c.x<-c.w) c.x=W+c.w*0.5; }

    // troposfeer wolken
    for(const c of this.clouds){ c.x-=8*c.s*dt; if(c.x<-c.w) c.x=W+c.w*0.5; }

    // vliegtuigen
    for(const p of this.planes){
      p.x += p.vx*dt; p.trail = Math.max(0, Math.min(1, p.trail + dt*0.1));
      if(p.vx>0 && p.x>W+80){ p.x=-80; p.y += rnd(-80,80); }
      if(p.vx<0 && p.x<-80){ p.x=W+80; p.y += rnd(-80,80); }
    }

    // heaven coins: zacht zweven
    for(const c of this.heavenCoins){
      c.y += c.vy*dt + Math.sin(this.t*1.5 + c.phase)*0.2;
      c.x += Math.cos(this.t*0.8 + c.phase)*0.1;
    }
  }
};

/* --- Ground helpers --- */
function makeHillsBand(yBase, color, amp){
  const pts=[]; const nPts=6;
  for(let i=0;i<=nPts;i++){ pts.push({x:i/nPts*W, y:yBase + Math.sin(i*0.7)*60*amp}); }
  return {y:yBase, pts, color, speed:20};
}
function drawHillsBand(h){
  ctx.save(); ctx.fillStyle=h.color;
  const shift=(env.t*h.speed)%W; ctx.translate(-shift,0);
  for(let k=0;k<2;k++){
    ctx.beginPath(); ctx.moveTo(-W+k*W, h.y+300);
    for(const p of h.pts) ctx.lineTo(p.x+k*W, p.y);
    ctx.lineTo(W+k*W, h.y+300); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}
function makeTreeLineBand(yBase, color){
  const trees=[]; let x=0;
  while(x<W+60){
    const w=rnd(12,26), h=rnd(40,80);
    trees.push({x,y:yBase - h, w, h});
    x += w + rnd(8,18);
  }
  return {y:yBase, trees, color, speed:28};
}
function drawTreeLineBand(tl){
  ctx.save(); ctx.fillStyle=tl.color;
  const shift=(env.t*tl.speed)%W; ctx.translate(-shift,0);
  for(let k=0;k<3;k++){
    for(const t of tl.trees){
      const X=t.x + k*(W+100), Y=t.y;
      const Wd=t.w, Hd=t.h;
      ctx.fillRect(X+Wd*0.45, Y+Hd*0.6, Wd*0.1, Hd*0.4);
      ctx.beginPath(); ctx.moveTo(X+Wd*0.5, Y);
      ctx.lineTo(X+Wd, Y+Hd*0.7);
      ctx.lineTo(X, Y+Hd*0.7);
      ctx.closePath(); ctx.fill();
    }
  }
  ctx.restore();
}
function makeCityBand(yBase, colors){
  const layer = (speed,color,windowProb)=>{
    const buildings=[]; let x=0;
    while(x<W+140){ const w=rnd(60,120), h=rnd(80,170);
      buildings.push({x,y:yBase-h,w,h,roof:Math.random()<.3,color,windowProb});
      x += w + rnd(16,28);
    }
    return {y:yBase, speed, color, buildings};
  };
  return [
    layer(20, colors[0], .10),
    layer(32, colors[1], .12)
  ];
}
function drawCityBand(l){
  ctx.save();
  const shift=(env.t*l.speed)%(W+140); ctx.translate(-shift,0);
  for(let k=0;k<2;k++) for(const b of l.buildings){
    const X=b.x + k*(W+140), Y=b.y, Wd=b.w, Hd=b.h;
    ctx.fillStyle=b.color; ctx.fillRect(X,Y,Wd,Hd);
    if(b.roof){ ctx.beginPath(); ctx.moveTo(X,Y); ctx.lineTo(X+Wd/2,Y-10); ctx.lineTo(X+Wd,Y); ctx.closePath(); ctx.fill(); }
    const cols=Math.max(2,Math.floor(Wd/20)), rows=Math.max(2,Math.floor(Hd/28));
    ctx.fillStyle='rgba(255,214,115,0.6)';
    for(let i=0;i<cols;i++) for(let j=0;j<rows;j++) if(Math.random()<.08){
      ctx.fillRect(X+6+i*(Wd-12)/cols, Y+6+j*(Hd-12)/rows, 5, 8);
    }
  }
  ctx.restore();
}

/* --- Birds --- */
function makeBird(y){ return {x:rnd(-200,W), y, vx:rnd(25,45), phase:Math.random()*6.28}; }
function drawBird(b){
  ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(b.x-6,b.y);
  ctx.quadraticCurveTo(b.x,b.y-4,b.x+6,b.y);
  ctx.stroke();
}

/* --- Clouds --- */
function drawCloud(c){
  ctx.fillStyle='rgba(255,255,255,.96)';
  ctx.beginPath(); ctx.ellipse(c.x,c.y,c.w,c.h,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=.18; ctx.fillStyle='#6ea3d6';
  ctx.beginPath(); ctx.ellipse(c.x, c.y+c.h*0.34, c.w*0.46, c.h*0.6, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;
}

/* --- Planes (achtergrond) --- */
function makePlane(y){
  const dir = Math.random()<0.5 ? -1 : 1;
  return {x: dir<0 ? rnd(40,W-40) : rnd(40,W-40), y, vx: dir*rnd(40,70), dir, trail:0, phase:Math.random()*6.28};
}
function drawPlane(p){
  ctx.globalAlpha=0.35*p.trail;
  ctx.strokeStyle='#e8f2ff'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(p.x-40*p.dir, p.y+4); ctx.lineTo(p.x, p.y+4); ctx.stroke();
  ctx.globalAlpha=1;
  ctx.fillStyle='#e5eefc'; ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x-18*p.dir, p.y-5);
  ctx.lineTo(p.x-22*p.dir, p.y);
  ctx.lineTo(p.x-18*p.dir, p.y+5);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle='#ffed9c';
  ctx.beginPath(); ctx.arc(p.x-12*p.dir, p.y-2, 2, 0, Math.PI*2); ctx.fill();
}

/* --- Space --- */
function makePlanet(y){ return {x:rnd(60,W-60), y, r:rnd(18,36), hue:rnd(180,360)}; }
function drawPlanet(p){
  const grad=ctx.createRadialGradient(p.x-p.r*0.5,p.y-p.r*0.5,p.r*0.2,p.x,p.y,p.r*1.1);
  grad.addColorStop(0, `hsl(${p.hue},60%,75%)`);
  grad.addColorStop(1, `hsl(${p.hue},60%,35%)`);
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=.28; ctx.strokeStyle='#fff'; ctx.lineWidth=1.6;
  ctx.beginPath(); ctx.ellipse(p.x,p.y+3,p.r*1.2,p.r*0.35,0,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
}

/* --- Heaven: Golden Gate + coins + Big Light Coin --- */
function drawGoldenGate(g){
  const x = W*0.5, y = g.y, w = g.w, h = g.h;
  const glow = ctx.createRadialGradient(x, y+h*0.4, 10, x, y+h*0.4, Math.max(W,H)*0.6);
  glow.addColorStop(0, 'rgba(255,223,130,0.18)');
  glow.addColorStop(1, 'rgba(255,223,130,0)');
  ctx.fillStyle = glow; ctx.fillRect(x-W, y-h, W*2, H*2);

  const colW = 28, colR = 10;
  const lgCol = ctx.createLinearGradient(0,y,0,y+h);
  lgCol.addColorStop(0,'#ffd76a'); lgCol.addColorStop(1,'#caa03a');
  ctx.fillStyle = lgCol;
  roundRect(W*0.5-w*0.35, y, colW, h, colR); ctx.fill();
  roundRect(W*0.5+w*0.35-colW, y, colW, h, colR); ctx.fill();

  const archTop = y - h*0.05;
  const archBot = y + h*0.55;
  const gradArch = ctx.createLinearGradient(0,archTop,0,archBot);
  gradArch.addColorStop(0,'#ffe48f'); gradArch.addColorStop(1,'#cfa33f');
  ctx.strokeStyle=gradArch; ctx.lineWidth=14;
  ctx.beginPath();
  ctx.moveTo(W*0.5-w*0.35+colW, archBot);
  ctx.quadraticCurveTo(W*0.5, archTop, W*0.5+w*0.35-colW, archBot);
  ctx.stroke();

  ctx.lineWidth=3; ctx.strokeStyle='rgba(255,236,170,0.7)';
  for(let t=0.1;t<0.9;t+=0.12){
    ctx.beginPath();
    const tx = W*0.5 - w*0.3 + t*w*0.6;
    ctx.moveTo(tx, archBot-6);
    ctx.quadraticCurveTo(W*0.5, archTop+12, W*0.5+(W*0.5-tx), archBot-6);
    ctx.stroke();
  }

  const baseY = y + h*0.62;
  const sg=ctx.createLinearGradient(0,baseY,0,baseY+18);
  sg.addColorStop(0,'#e9e9ee'); sg.addColorStop(1,'#bdbdd2');
  ctx.fillStyle=sg; roundRect(W*0.5 - (w*0.85)/2, baseY+9, w*0.85, 18, 10); ctx.fill();
}
function drawHeavenCoin(c){
  const g=ctx.createRadialGradient(c.x-c.r*.35,c.y-c.r*.35,c.r*.2,c.x,c.y,c.r*1.1);
  g.addColorStop(0,'#fff6c8'); g.addColorStop(0.55,'#f6d36a'); g.addColorStop(1,'#b78628');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.45)';
  ctx.beginPath(); ctx.arc(c.x,c.y,c.r-1,0,Math.PI*2); ctx.stroke();
  if(logo.complete){
    ctx.save(); ctx.beginPath(); ctx.arc(c.x,c.y,c.r-2,0,Math.PI*2); ctx.clip();
    ctx.drawImage(logo, c.x-(c.r-2), c.y-(c.r-2), (c.r-2)*2, (c.r-2)*2); ctx.restore();
  }
}
function drawBigCoinLight(bc){
  const x=W*0.5, y=bc.y, r=bc.r;
  const farGlow = ctx.createRadialGradient(x, y, 50, x, y, Math.max(W,H)*0.9);
  farGlow.addColorStop(0, 'rgba(255,245,160,0.14)');
  farGlow.addColorStop(1, 'rgba(255,245,160,0)');
  ctx.fillStyle=farGlow; ctx.fillRect(0, y-2*H, W, 4*H);

  const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.2,x,y,r*1.25);
  g.addColorStop(0,'#fffad0'); g.addColorStop(0.55,'#f9d66b'); g.addColorStop(1,'#c9972e');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=5; ctx.strokeStyle='rgba(255,255,255,.5)';
  ctx.beginPath(); ctx.arc(x,y,r-3,0,Math.PI*2); ctx.stroke();

  if(logo.complete){
    ctx.save(); ctx.beginPath(); ctx.arc(x,y,r-6,0,Math.PI*2); ctx.clip();
    ctx.drawImage(logo, x-(r-6), y-(r-6), (r-6)*2, (r-6)*2); ctx.restore();
  }
}

/* ========== Hemel: aarde → wolken → donkerder → ruimte → hemellicht ========== */
function drawSky(){
  const alt = -camY;

  const EARTH_TOP=[114,198,255],  EARTH_BOT=[167,231,191];
  const CLOUD_TOP=[187,223,255],  CLOUD_BOT=[142,198,255];
  const MID_TOP=[60,110,170],     MID_BOT=[20,40,70];
  const SPACE_TOPC=[11,14,42],    SPACE_BOTC=[0,0,5];
  const HEAVEN_TOPC=[244,236,255],HEAVEN_BOTC=[217,204,255];

  function seg(a,b){ return {a,b,length:(b-a)}}
  const sEarth = seg(-200, -TROPO_TOP);
  const sMid   = seg(-TROPO_TOP, -SPACE_TOP);
  const sSpace = seg(-SPACE_TOP, -HEAVEN_TOP);
  const sHeaven= seg(-HEAVEN_TOP, 4000);

  let topCol, botCol;

  if(alt <= sEarth.a){ // aarde
    topCol = EARTH_TOP; botCol = EARTH_BOT;
  } else if(alt < sEarth.b){ // nog aarde
    topCol = EARTH_TOP; botCol = EARTH_BOT;
  } else if(alt < sMid.b){ // richting donkerder
    const t=(alt - sEarth.b)/sMid.length;
    topCol = [Math.round(CLOUD_TOP[0]*(1-t)+MID_TOP[0]*t),
              Math.round(CLOUD_TOP[1]*(1-t)+MID_TOP[1]*t),
              Math.round(CLOUD_TOP[2]*(1-t)+MID_TOP[2]*t)];
    botCol = [Math.round(CLOUD_BOT[0]*(1-t)+MID_BOT[0]*t),
              Math.round(CLOUD_BOT[1]*(1-t)+MID_BOT[1]*t),
              Math.round(CLOUD_BOT[2]*(1-t)+MID_BOT[2]*t)];
  } else if(alt < sSpace.b){
    const t=(alt - sMid.b)/sSpace.length;
    topCol = [Math.round(MID_TOP[0]*(1-t)+SPACE_TOPC[0]*t),
              Math.round(MID_TOP[1]*(1-t)+SPACE_TOPC[1]*t),
              Math.round(MID_TOP[2]*(1-t)+SPACE_TOPC[2]*t)];
    botCol = [Math.round(MID_BOT[0]*(1-t)+SPACE_BOTC[0]*t),
              Math.round(MID_BOT[1]*(1-t)+SPACE_BOTC[1]*t),
              Math.round(MID_BOT[2]*(1-t)+SPACE_BOTC[2]*t)];
  } else {
    const t=Math.min(1,(alt - sSpace.b)/sHeaven.length);
    topCol = [Math.round(SPACE_TOPC[0]*(1-t)+HEAVEN_TOPC[0]*t),
              Math.round(SPACE_TOPC[1]*(1-t)+HEAVEN_TOPC[1]*t),
              Math.round(SPACE_TOPC[2]*(1-t)+HEAVEN_TOPC[2]*t)];
    botCol = [Math.round(SPACE_BOTC[0]*(1-t)+HEAVEN_BOTC[0]*t),
              Math.round(SPACE_BOTC[1]*(1-t)+HEAVEN_BOTC[1]*t),
              Math.round(SPACE_BOTC[2]*(1-t)+HEAVEN_BOTC[2]*t)];
  }

  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, `rgb(${topCol[0]},${topCol[1]},${topCol[2]})`);
  g.addColorStop(1, `rgb(${botCol[0]},${botCol[1]},${botCol[2]})`);
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // Zachte lichtstralen als je Heaven nadert
  if(alt > -HEAVEN_TOP - 1200){
    const near = Math.min(1, (alt + HEAVEN_TOP + 1200)/1200);
    const alpha = 0.05 + 0.15*near;
    const cx=W*.5, cy=H*.2;
    for(let i=0;i<4;i++){
      const ang=i/4*Math.PI*2 + env.t*.04;
      const x2=cx+Math.cos(ang)*W*.9, y2=cy+Math.sin(ang)*H*.9;
      const lg=ctx.createLinearGradient(cx,cy,x2,y2);
      lg.addColorStop(0,`rgba(255,255,255,${alpha})`); lg.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=lg; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x2,y2);
      ctx.lineTo(cx+Math.cos(ang+.12)*W*.6, cy+Math.sin(ang+.12)*H*.6); ctx.closePath(); ctx.fill();
    }
  }
}

/* ========== View-culling en wereldtekenen ========== */
function inView(y, pad=200){ return y > camY - pad && y < camY + H + pad; }

function drawWorld(){
  drawSky();
  ctx.save(); ctx.translate(0,-camY);

  // AARDE
  if(inView(GROUND_Y)){
    ctx.fillStyle='#2a4a2f';
    ctx.fillRect(0, GROUND_Y+10, W, 60);
    drawHillsBand(env.hills);
    for(const l of env.city) drawCityBand(l);
    drawTreeLineBand(env.trees);
    for(const b of env.birds) if(inView(b.y,0)) drawBird(b);
    for(const c of env.groundClouds){ if(inView(c.y)) drawCloud(c); }
  }

  // WOLKEN
  for(const c of env.clouds){ if(inView(c.y)) drawCloud(c); }

  // STRATO (vliegtuigen)
  for(const p of env.planes){ if(inView(p.y)) drawPlane(p); }

  // SPACE
  if(camY < SPACE_TOP + H){
    const alt = -camY;
    const starAlpha = Math.min(1, Math.max(0, (alt + SPACE_TOP)/(-SPACE_TOP + STRATO_TOP)));
    for(const s of env.stars){
      if(inView(s.y,0)){
        const tw = 0.4 + 0.6*(0.5+0.5*Math.sin(env.t*2 + s.tw));
        ctx.globalAlpha = starAlpha * (0.18 + 0.6*tw);
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fillStyle='#cfe6ff'; ctx.fill();
        ctx.globalAlpha=1;
      }
    }
    for(const p of env.planets){ if(inView(p.y)) drawPlanet(p); }
  }

  // GROTE LICHT-COIN (zichtbaar nog voor heaven)
  if(inView(env.bigCoin.y, H*2)) drawBigCoinLight(env.bigCoin);

  // HEAVEN
  if(camY < HEAVEN_TOP + H){
    drawGoldenGate(env.heavenGate);
    for(const c of env.heavenCoins){ if(inView(c.y,50)) drawHeavenCoin(c); }
  }

  ctx.restore();
}

/* ========== Collision & platforms ========== */
function tryLandOn(p,dt){
  if(!p) return false;
  if(groundPlat && groundPlat.id===p.id) return false;
  const px=platX(p), marginX=player.r*.25;
  if(player.x < px-p.w/2 - marginX || player.x > px+p.w/2 + marginX) return false;
  const top=platTop(p), prevBottom=(player.y - player.vy*dt) + player.r, nowBottom=player.y + player.r, TOL=4;
  if(player.vy>0 && prevBottom<=top+TOL && nowBottom>=top-TOL){
    player.y=top-player.r; player.vy=0; player.onGround=true; groundPlat=p; return true;
  }
  return false;
}

/* ---- Rounded rect helpers ---- */
function rrPath(x,y,w,h,r=8){
  const hw=w/2, hh=h/2;
  ctx.beginPath();
  ctx.moveTo(x-hw+r,y-hh); ctx.lineTo(x+hw-r,y-hh);
  ctx.quadraticCurveTo(x+hw,y-hh,x+hw,y-hh+r);
  ctx.lineTo(x+hw,y+hh-r);
  ctx.quadraticCurveTo(x+hw,y+hh,x+hw-r,y+hh);
  ctx.lineTo(x-hw+r,y+hh);
  ctx.quadraticCurveTo(x-hw,y+hh,x-hw,y+hh-r);
  ctx.lineTo(x-hw,y-hh+r);
  ctx.quadraticCurveTo(x-hw,y-hh,x-hw+r,y-hh);
  ctx.closePath();
}
function roundRect(x,y,w,h,r){
  const x2=x+w, y2=y+h; r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x2,y,x2,y+r,r);
  ctx.arcTo(x2,y2,x2-r,y2,r);
  ctx.arcTo(x,y2,x,y2-r,r);
  ctx.arcTo(x,y,x+r,y,r);
  ctx.closePath();
}

/* ---- Platform renderers (per laag) ---- */
function drawPlatform(p){
  const x=platX(p), y=p.y, w=p.w, h=p.h, th=Math.max(10,h*1.1);
  if(p.type==='wood')        drawWood(x,y,w,h,th);
  else if(p.type==='cloud')  drawCloudPlat(x,y,w,h);
  else if(p.type==='plane')  drawPlanePlat(x,y,w,h);
  else if(p.type==='rocket') drawRocketPlat(x,y,w,h);
  else if(p.type==='heavenCloud') drawHeavenCloudPlat(x,y,w,h);
  else drawMarble(x,y,w,h,th);
}

/* Aarde: hout */
function drawWood(x,y,w,h,th){
  const sg=ctx.createLinearGradient(x,y,x,y+th); sg.addColorStop(0,'#7a4a1e'); sg.addColorStop(1,'#4b2b12');
  ctx.fillStyle=sg; rrPath(x,y+th,w,h,10); ctx.fill();
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2); g.addColorStop(0,'#c08a4b'); g.addColorStop(1,'#8a5a2a');
  ctx.fillStyle=g; rrPath(x,y,w,h,10); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=2;
  for(let i=-1;i<=1;i++){ ctx.beginPath(); ctx.moveTo(x-w*.45,y+i*5); ctx.quadraticCurveTo(x,y+i*7, x+w*.45,y+i*5); ctx.stroke(); }
}

/* Wolk-platform (troposfeer) */
function drawCloudPlat(x,y,w,h){
  const r=h*.9; ctx.fillStyle='rgba(255,255,255,.96)';
  const n=5, step=w/(n+1);
  for(let i=0;i<n;i++){ const cx=x-w/2+step*(i+1); ctx.beginPath(); ctx.ellipse(cx,y,r,r*.7,0,0,Math.PI*2); ctx.fill(); }
  ctx.globalAlpha=.18; ctx.fillStyle='#6ea3d6'; ctx.beginPath(); ctx.ellipse(x,y+h*.34,w*.46,h*.6,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
}

/* Vliegtuig-platform (strato) */
function drawPlanePlat(x,y,w,h){
  // romp
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2);
  g.addColorStop(0,'#f0f6ff'); g.addColorStop(1,'#c6d7f5');
  ctx.fillStyle=g; roundRect(x-w/2, y-h/2, w, h, 12); ctx.fill();

  // vleugels
  ctx.fillStyle='#b8cbed';
  roundRect(x-w*0.6, y-h*0.18, w*1.2, h*0.36, 10); ctx.fill();

  // cockpit
  ctx.fillStyle='#5fa3e3'; roundRect(x-w*0.16, y-h*0.34, w*0.32, h*0.22, 6); ctx.fill();

  // kleine ramen
  ctx.fillStyle='#8fc3ff';
  const n=5; for(let i=0;i<n;i++){ ctx.beginPath(); ctx.arc(x-w*0.25+i*(w*0.5/(n-1)), y, 4, 0, Math.PI*2); ctx.fill(); }
}

/* Raket-platform (ruimte) */
function drawRocketPlat(x,y,w,h){
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2);
  g.addColorStop(0,'#eeeeee'); g.addColorStop(1,'#9aa2ad');
  ctx.fillStyle=g; roundRect(x-w/2, y-h/2, w, h, 8); ctx.fill();

  // raampjes
  ctx.fillStyle='#4ab5ff';
  const n=5, step=w/(n+1);
  for(let i=1;i<=n;i++){ ctx.beginPath(); ctx.arc(x-w/2+step*i, y, 6, 0, Math.PI*2); ctx.fill(); }

  // kleine vlam
  ctx.fillStyle='orange';
  ctx.beginPath(); ctx.moveTo(x-w*0.1, y+h/2); ctx.lineTo(x+w*0.1, y+h/2); ctx.lineTo(x, y+h/2+12); ctx.closePath(); ctx.fill();
}

/* Heaven glow-wolk */
function drawHeavenCloudPlat(x,y,w,h){
  const r=h*.9;
  ctx.fillStyle='rgba(255,255,255,.97)';
  const n=5, step=w/(n+1);
  for(let i=0;i<n;i++){ const cx=x-w/2+step*(i+1); ctx.beginPath(); ctx.ellipse(cx,y,r,r*.7,0,0,Math.PI*2); ctx.fill(); }
  // glow rand
  ctx.save();
  ctx.globalAlpha=0.7; ctx.strokeStyle='rgba(255,255,210,0.9)'; ctx.lineWidth=4;
  ctx.beginPath(); ctx.ellipse(x,y,w/2,h*0.6,0,0,Math.PI*2); ctx.stroke();
  ctx.restore();
}

/* Marble reserve (onbruikbaar, maar laten staan als fallback) */
function drawMarble(x,y,w,h,th){
  const sg=ctx.createLinearGradient(x,y,x,y+th); sg.addColorStop(0,'#e9e9ee'); sg.addColorStop(1,'#bdbdd2');
  ctx.fillStyle=sg; rrPath(x,y+th,w,h,10); ctx.fill();
  const g=ctx.createLinearGradient(x,y-h/2,x,y+h/2); g.addColorStop(0,'#ffffff'); g.addColorStop(1,'#e7e7f5');
  ctx.fillStyle=g; rrPath(x,y,w,h,10); ctx.fill();
  ctx.globalAlpha=.18; ctx.strokeStyle='rgba(120,120,160,.6)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(x-w*.45,y-h*.15); ctx.quadraticCurveTo(x-w*.2,y, x,y-h*.05);
  ctx.quadraticCurveTo(x+w*.2,y+h*.1, x+w*.45,y-h*.02); ctx.stroke(); ctx.globalAlpha=1;
}

/* ========== Player (CBS coin) ========== */
function drawPlayer(){
  const x=player.x,y=player.y,r=player.r;
  const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.2,x,y,r*1.15);
  g.addColorStop(0,'#fff6c8'); g.addColorStop(0.55,'#f6d36a'); g.addColorStop(1,'#b78628');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,.5)';
  ctx.beginPath(); ctx.arc(x,y,r-2,0,Math.PI*2); ctx.stroke();
  if(logo.complete){ ctx.save(); ctx.beginPath(); ctx.arc(x,y,r-3,0,Math.PI*2); ctx.clip(); ctx.drawImage(logo, x-r, y-r, r*2, r*2); ctx.restore(); }
}

/* ========== Lifecycle & Loop (start op aarde) ========== */
function startRun(){
  player.r=Math.max(26,Math.min(40,H*0.04));
  // Start letterlijk op de grond
  currentPlat=makePlatform(W/2, GROUND_Y-20, true);
  currentPlat.lastX=platX(currentPlat);
  player.x=W/2; player.y=platTop(currentPlat)-player.r;
  player.vy=0; player.onGround=true; player.coyote=0; groundPlat=currentPlat;
  nextPlat=spawnNextAbove(currentPlat); nextPlat.lastX=platX(nextPlat);
  camY=0; meters=0; hud.textContent='0 m';
  env.rebuild();
}

/* ========== Main loop ========== */
resize();
startRun();

let last=performance.now();
function loop(now){
  let dt=(now-last)/1000; last=now; if(dt>0.05) dt=0.05;
  env.update(dt);

  const fixed=0.008, steps=Math.max(1,Math.ceil(dt/fixed)), h=dt/steps;
  for(let i=0;i<steps;i++){
    const prevXc=currentPlat?currentPlat.lastX:0, prevXn=nextPlat?nextPlat.lastX:0;
    if(nextPlat&&!nextPlat.isBase) nextPlat.phase+=nextPlat.speed*h;
    if(currentPlat&&!currentPlat.isBase) currentPlat.phase+=currentPlat.speed*h;
    if(currentPlat) currentPlat.lastX=platX(currentPlat); if(nextPlat) nextPlat.lastX=platX(nextPlat);
    const dxc=currentPlat?(currentPlat.lastX-prevXc):0, dxn=nextPlat?(nextPlat.lastX-prevXn):0;

    if(groundPlat){
      const dx=(groundPlat.id===currentPlat?.id)?dxc:(groundPlat.id===nextPlat?.id?dxn:0);
      player.x=clamp(player.x+dx,player.r,W-player.r);
      player.y=platTop(groundPlat)-player.r; player.vy=Math.max(0,player.vy);
      player.onGround=true; player.coyote=COYOTE;
    }else{
      player.vy+=GRAV*h; player.y+=player.vy*h; player.coyote=Math.max(0,player.coyote-h); player.onGround=false;
      const landed = tryLandOn(nextPlat,h) || tryLandOn(currentPlat,h);
      if(landed){
        if(groundPlat && groundPlat.id===nextPlat?.id){ 
          currentPlat=nextPlat; nextPlat=spawnNextAbove(currentPlat); nextPlat.lastX=platX(nextPlat); 
        }
      }
    }
  }

  // Camera volgt
  if(player.y<camY+H*0.45) camY=player.y-H*0.45;
  if(player.y-camY>H+200) startRun();

  const m=Math.max(0,Math.floor((-player.y + GROUND_Y)/6));
  if(m!==meters){ meters=m; hud.textContent=m+" m"; }

  ctx.clearRect(0,0,W,H);
  drawWorld();

  // Platforms + speler
  ctx.save(); ctx.translate(0,-camY);
  if(currentPlat && inView(currentPlat.y)) drawPlatform(currentPlat);
  if(nextPlat    && inView(nextPlat.y))    drawPlatform(nextPlat);
  drawPlayer();
  ctx.restore();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ========== Utils ========== */
function rnd(a,b){return a+Math.random()*(b-a)}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
</script>
</body>
</html>
